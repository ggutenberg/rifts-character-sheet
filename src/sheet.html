<!-- Add class="debug" to <main> for debugging -->
<main id="megaverse" class="debug">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_abilities">
      Abilities
    </button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">
      Modifiers
    </button>
    <button class="metal linear" type="action" name="act_bonuses">
      Bonuses
    </button>
    <button class="metal linear" type="action" name="act_magic">Magic</button>
    <button class="metal linear" type="action" name="act_psionics">
      Psionics
    </button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
    <button class="metal linear" type="action" name="act_importexport">
      Imp/Exp
    </button>
    <img
      class="logo"
      src="https://db4sgowjqfwig.cloudfront.net/game_systems/22/assets/1100695/rifts-logo.png"
    />
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />
  <!-- inject:partials/datalists.html -->
  <!-- endinject -->

  <!-- inject:partials/core.html -->
  <!-- endinject -->

  <br />

  <!-- inject:partials/skills.html -->
  <!-- endinject -->

  <div class="abilities">
    <h3>Natural Abilities / Powers</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter some natural abilities/powers that are neither magic nor psionic
        in nature.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Don't forget to copy/paste the power description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <div class="repeating-bonuses-outer">
      <fieldset class="repeating_abilities">
        <details class="info">
          <!-- inject:partials/abilities.html -->
          <!-- endinject -->
          <!-- inject:partials/repeating_bonuses_details.html -->
          <!-- endinject -->
        </details>
      </fieldset>
    </div>
  </div>

  <!-- inject:partials/weapon_proficiencies.html -->
  <!-- endinject -->

  <div class="modifiers">
    <div class="bonuses-container">
      <h3>Modifiers</h3>
      <details>
        <summary><b>Instructions</b></summary>
        <p>
          Complete the repeating sections for your various combat skills and
          modifiers. Skill dropdowns are free-form, so you can type anything in
          them and don't need to select from the list. What's there is just a
          small sample.
        </p>
        <p>
          Any modifiers you add will appear as checkboxes on the Bonuses tab.
          Toggling them will recalculate the bonuses for all checked items.
        </p>
        <p>
          If you have additional bonuses from items, magic, training, etc., you
          can create arbitrarily named sections and apply those as well. You can
          also add weapons here, and include any strike/parry bonuses they
          provide, as well as their damage.
        </p>
      </details>
      <p>Click <b>Instructions</b> for detailed instructions.</p>
      <div class="repeating-bonuses-outer">
        <fieldset class="repeating_modifiers">
          <details class="info">
            <summary>
              <div class="bonus-thing-heading">
                <b class="click-expand"
                  ><span title="Click for more info">&nbsp;&#9432;</span></b
                >
                <label
                  ><span>Name</span>
                  <input type="text" list="combat-modifiers" name="attr_name" />
                </label>
                <label
                  ><span>Level</span>
                  <input type="number" value="1" name="attr_level" />
                </label>
              </div>
            </summary>
            <!-- inject:partials/repeating_bonuses_details.html -->
            <!-- endinject -->
          </details>
        </fieldset>
      </div>
    </div>
  </div>

  <div class="bonuses">
    <div class="bonuses-container">
      <h3>Aggregated Bonuses</h3>
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p></p>
          <p>
            Any modifiers you add on the Modifiers tab will appear as checkboxes
            here.
          </p>
          <p>
            Any Weapon Proficiencies you add on the WPs tab will appear on this
            page as well. Weapon Proficiencies <b>automatically</b> calculate
            their bonuses based on level, but no other skill (like Hand-to-Hand)
            does so yet.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. Damage adds everything together as a rollable field, and
            prompts to add Punch damage. Crit/Knockout/Death Blow use the lowest
            of the available options (ex. Crit: 17 is better than Crit: 19).
          </p>
          <p>
            The first Profile in the list is considered the
            <b>Default</b> profile and is used to perform global calculations
            like speed over time and skill bonuses.
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <fieldset class="repeating_bonusselections">
          <label>
            <input type="checkbox" name="attr_enabled" value="1" />
            <span name="attr_name"></span
          ></label>
          <input type="hidden" name="attr_name" value="" />
          <input type="hidden" name="attr_bonus_id" value="" />
        </fieldset>
        <div class="selected-ids">
          <b>Selected IDs</b>
          <input
            class="full"
            type="text"
            name="attr_bonus_ids_output"
            value=""
          />
        </div>
        <hr />
        <div class="profiles repeating-bonuses-outer">
          <h3>Profiles</h3>
          <fieldset class="repeating_profiles">
            <details class="info">
              <summary>
                <div class="bonus-thing-heading">
                  <b class="click-expand"
                    ><span title="Click for more info">&nbsp;&#9432;</span></b
                  >
                  <label
                    ><span>Name</span>
                    <input
                      type="text"
                      list="combat-modifiers"
                      name="attr_name"
                    />
                  </label>
                  <label
                    ><span>Level</span>
                    <input type="number" value="1" name="attr_level" />
                  </label>
                </div>
              </summary>
              <div class="profile-management">
                <input type="text" class="full" name="attr_bonus_ids" />
                <input type="hidden" name="attr_bonus_names" />
                <div class="bonus-names">
                  <span name="attr_bonus_names"></span>
                </div>
                <button
                  type="action"
                  name="act_copybonusids"
                  class="metal linear small"
                >
                  Apply Checked Modifiers to this Profile
                </button>
                <!-- <button type="action" name="act_checkbonusids">
                  Apply this Profile to Selected IDs
                </button> -->
                <button
                  type="action"
                  name="act_updateprofile"
                  class="metal linear small"
                >
                  Update Profile if Attributes or Modifiers have changed
                </button>
              </div>
              <!-- inject:partials/repeating_bonuses_details.html -->
              <!-- endinject -->
            </details>
          </fieldset>
        </div>
        <hr />
      </div>
      <div class="bonus-sources repeating-bonuses-outer">
        <h3>Bonus Sources</h3>
        <fieldset class="repeating_bonuses">
          <input type="hidden" name="attr_selection_id" value="" />
          <details class="info">
            <summary>
              <div class="bonus-thing-heading">
                <b class="click-expand"
                  ><span title="Click for more info">&nbsp;&#9432;</span></b
                >
                <label
                  ><span>Name</span>
                  <input type="text" list="combat-modifiers" name="attr_name" />
                </label>
                <label
                  ><span>Level</span>
                  <input type="number" value="1" name="attr_level" />
                </label>
              </div>
            </summary>
            <!-- inject:partials/repeating_bonuses_details.html -->
            <!-- endinject -->
          </details>
        </fieldset>
      </div>
    </div>
  </div>

  <div class="magic">
    <h3>Magic</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter a Spell name and its PPE. Optionally set the School and Spell
        Level. Then expand the Details, and fill in the applicable values. They
        will calculate and populate Range, Damage, Duration, and Skill if
        applicable.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Press the Cast button to remove the PPE from the Current PPE input
        field. Click Reset PPE to set Current PPE back to the value on the Core
        tab. Note the roll button beside Damage and Skill.
      </p>
      <p>
        Don't forget to copy/paste the spell description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <label
      ><span>Current P.P.E.</span>
      <input type="number" name="attr_currentppe" value="0" />
      <button type="action" name="act_resetppe">Reset P.P.E.</button>
    </label>
    <fieldset class="repeating_magic">
      <details class="info">
        <!-- inject:partials/magic.html -->
        <!-- endinject -->
        <!-- inject:partials/repeating_bonuses_details.html -->
        <!-- endinject -->
      </details>
    </fieldset>
  </div>

  <div class="psionics">
    <h3>Psionics</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter a Psionic name and its ISP. Then expand the Details, and fill in
        the applicable values. They will calculate and populate Range, Damage,
        Duration, and Skill if applicable.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Press the Use button to remove the ISP from the Current ISP input field.
        Click Reset ISP to set Current ISP back to the value on the Core tab.
        Note the roll button beside Damage and Skill.
      </p>
      <p>
        Don't forget to copy/paste the power description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <label
      ><span>Current I.S.P.</span>
      <input type="number" name="attr_currentisp" value="0" />
      <button type="action" name="act_resetisp">Reset I.S.P.</button>
    </label>
    <fieldset class="repeating_psionics">
      <details class="info">
        <!-- inject:partials/psionics.html -->
        <!-- endinject -->
        <!-- inject:partials/repeating_bonuses_details.html -->
        <!-- endinject -->
      </details>
    </fieldset>
  </div>

  <div class="equipment">
    <h3>Equipment</h3>
    <p>Free form equipment list for now.</p>
    <textarea class="full tall" name="attr_equipment"></textarea>
  </div>

  <div class="importexport">
    <h3>Import/Export</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Click the <b>Export</b> button to get a JSON object representing your
        character. Paste a valid JSON object and click <b>Import</b> to import a
        character.
      </p>
      <p>
        In order to know what the valid fields are, complete all the fields with
        at least one of each repeating section and do an Export.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <button type="action" name="act_import">Import</button>
    <button type="action" name="act_export">Export</button>
    <textarea class="full tall" name="attr_importexport"></textarea>
  </div>
</main>
<script type="text/javascript">
  // Change from javascript to worker before upload

  /* inject:js/async.js */
  /* endinject */

  /* inject:js/definitions.js */
  /* endinject */

  /* inject:js/utils.js */
  /* endinject */

  /* inject:js/bonuses.js */
  /* endinject */

  /* inject:js/wps.js */
  /* endinject */

  /* inject:js/modifiers.js */
  /* endinject */

  /* inject:js/profiles.js */
  /* endinject */

  /* inject:js/attributes.js */
  /* endinject */

  /* inject:js/skills.js */
  /* endinject */

  /* inject:js/magic_psionics.js */
  /* endinject */

  /* inject:js/movement.js */
  /* endinject */

  /* inject:js/import_export.js */
  /* endinject */

  /**
   * Add attributes, PS type, ISP, PPE, HP, SDC, MDC, etc. to Bonuses
   * [x] Allow for an "absolute" value
   * [x] Add additional field(s) to Profile for aggregate attribute bonuses
   * [] Use a "text" input and allow for values like `*2` or `/2`
   * Aggregate Logic:
   * - PS includes type
   * - HP, SDC, AR, MDC are grouped on their own Armor row w/ Name
   * - PPE, ISP are grouped on their own "Mana"? row w/ Name
   *
   * [] Have abilities/magic/psionics auto-calculate/populate MDC/SDC/HP/...
   * [] Make things async
   *
   * @todo Armor tab / repeater; Armor checkboxes in Aggregate Bonuses, and Armor list (name, MDC) underneath
   *    Aggregate Bonuses checkboxes that show and hide based on the check
   *    - Magic and Psionics also provide armor. so you have to add the spell and then have a button to add it to the Armor tab
   *      Hitting "cast" should use up the PPE and check the checkbox. This should also apply to spell which have a duration and provide bonuses.
   *      Buttons: Cast | Cast and add to modifiers | Cast and add to armor
   * @todo add Ammo/Uses to Combat, Magic
   * @todo add import status - add an attribute and update count on each callback, or just once at the end indicating completion
   *
   * @todo Import isn't setting Skill level properly, probably because it's already "1"
   * @todo when Aggregate Attacks change, recalculate ft/attack fields
   *
   * Questions
   * - Paratrooper gets a save vs. Torture. What is this?
   *
   * @todo standardize/improve markup on Core tab
   *
   * @todo add an active combat section above Aggregate bonuses
   *    - track attacks
   *    - track ammo (roll20 has something for this)
   *    - track MDC - for each aggregate MDC modifier, track it separately in a repeater. allow the user to reorder, and deduct from bottom to top
   *
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   *
   * @todo better better build process with imports/file modules
   *
   * To get Character ID, `getAttrs(["character_id"])`
   * */

  /**
   * This one could be a doozy
   * */
  on("change:character_level", (e) => {
    console.log("change:character_level", e.newValue, e.previousValue);
    // Update WPs
    updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    updateSkillLevels(+e.newValue, +e.previousValue);
    updateMagicPsionicsLevels();
  });

  const buttonlist = [
    "core",
    "wp",
    "combat",
    "bonuses",
    "equipment",
    "skills",
    "magic",
    "psionics",
    "importexport",
    "abilities",
  ];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({ sheetTab: button });
    });
  });
</script>
