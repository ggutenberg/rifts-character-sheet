<main id="megaverse">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">Combat</button>
    <button class="metal linear" type="action" name="act_bonuses">
      Bonuses
    </button>
    <button class="metal linear" type="action" name="act_magic">Magic</button>
    <button class="metal linear" type="action" name="act_psionics">
      Psionics
    </button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
    <button class="metal linear" type="action" name="act_importexport">
      Imp/Exp
    </button>
    <img
      class="logo"
      src="https://db4sgowjqfwig.cloudfront.net/game_systems/22/assets/1100695/rifts-logo.png"
    />
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />
  <!-- inject:partials/datalists.html -->
  <!-- endinject -->

  <!-- inject:partials/core.html -->
  <!-- endinject -->

  <br />

  <!-- inject:partials/weapon_proficiencies.html -->
  <!-- endinject -->

  <div class="combat">
    <div class="combat-container">
      <h3>Combat Modifiers</h3>
      <details>
        <summary><b>Instructions</b></summary>
        <p>
          Complete the repeating sections for your various combat skills and
          modifiers. Skill dropdowns are free-form, so you can type anything in
          them and don't need to select from the list. What's there is just a
          small sample.
        </p>
        <p>
          Any modifiers you add will appear as checkboxes on the Bonuses tab.
          Toggling them will recalculate the bonuses for all checked items.
        </p>
        <p>
          If you have additional bonuses from items, magic, training, etc., you
          can create arbitrarily named sections and apply those as well. You can
          also add weapons here, and include any strike/parry bonuses they
          provide, as well as their damage.
        </p>
      </details>
      <p>Click <b>Instructions</b> for detailed instructions.</p>
      <fieldset class="repeating_combat">
        <input type="hidden" name="attr_bonus_id" value="" />
        <div class="bonus-thing-heading">
          <label
            ><span>Thing</span>
            <input type="text" list="combat-modifiers" name="attr_name" />
          </label>
          <label
            ><span>Level</span>
            <input type="number" value="1" name="attr_level" />
          </label>
        </div>
        <!-- inject:partials/repeating_bonuses_details.html -->
        <!-- endinject -->
      </fieldset>
    </div>
  </div>

  <div class="bonuses">
    <div class="combat-container">
      <h3>Aggregated Bonuses</h3>
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Any combat modifiers you add on the Combat tab will appear as
            checkboxes. Toggling them will recalculate the bonuses for all
            checked items.
          </p>
          <p>
            Any Weapon Proficiencies you add on the WPs tab will appear on this
            page as well. Weapon Proficiencies <b>automatically</b> calculate
            their bonuses based on level, but no other skill (like Hand-to-Hand)
            does so yet.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. Damage adds everything together as a rollable field, and
            prompts to add Punch damage. Crit/Knockout/Death Blow use the lowest
            of the available options (ex. Crit: 17 is better than Crit: 19).
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <fieldset class="repeating_bonusselections">
          <label>
            <input type="checkbox" name="attr_enabled" value="1" />
            <span name="attr_name"></span
          ></label>
          <input type="hidden" name="attr_name" value="" />
          <input type="hidden" name="attr_bonus_id" value="" />
          <input type="hidden" name="attr_bonus_section" value="" />
        </fieldset>
        <hr />
        <!-- inject:partials/combat_combined_melee.html -->
        <!-- endinject -->
        <hr />
        <!-- inject:partials/combat_combined_range.html -->
        <!-- endinject -->
        <hr />
        <h4>Saving Throws</h4>
        <!-- inject:partials/combat_combined_saving_throws.html -->
        <!-- endinject -->
      </div>
      <div class="hidden">
        <h3>Bonus Sources</h3>
        <fieldset class="repeating_bonuses">
          <div class="bonus-type-container">
            <input type="hidden" name="attr_bonus_selection_id" value="" />
            <label
              ><span>Skill</span>
              <input type="text" list="combat-modifiers" name="attr_name" />
            </label>
            <label
              ><span>Level</span>
              <input type="number" value="1" name="attr_level" />
            </label>
            <div></div>
            <div></div>
          </div>
          <!-- inject:partials/repeating_bonuses_details.html -->
          <!-- endinject -->
        </fieldset>
      </div>
    </div>
  </div>

  <!-- inject:partials/skills.html -->
  <!-- endinject -->

  <!-- inject:partials/magic.html -->
  <!-- endinject -->

  <!-- inject:partials/psionics.html -->
  <!-- endinject -->

  <div class="equipment">
    <h3>Equipment</h3>
    <p>Free form equipment list for now.</p>
    <textarea class="full tall" name="attr_equipment"></textarea>
  </div>

  <div class="importexport">
    <h3>Import/Export</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Click the <b>Export</b> button to get a JSON object representing your
        character. Paste a valid JSON object and click <b>Import</b> to import a
        character.
      </p>
      <p>
        In order to know what the valid fields are, complete all the fields with
        at least one of each repeating section and do an Export.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <button type="action" name="act_import">Import</button>
    <button type="action" name="act_export">Export</button>
    <textarea class="full tall" name="attr_importexport"></textarea>
  </div>
</main>
<script type="text/javascript">
  // Change from javascript to worker before upload

  /* inject:js/definitions.js */
  /* endinject */

  /* inject:js/utils.js */
  /* endinject */

  /* inject:js/combat.js */
  /* endinject */

  /* inject:js/attributes.js */
  /* endinject */

  /* inject:js/skills.js */
  /* endinject */

  /* inject:js/magic_psionics.js */
  /* endinject */

  /* inject:js/movement.js */
  /* endinject */

  /* inject:js/import_export.js */
  /* endinject */

  /**
   * @todo add tab for Powers/Abilities (like Psionics) - Skill %, Range, Duration, Damage, MDC,
   * - Regenerate | Damage: 1d6*5 | Duration: 1 min
   * @todo add MDC to Magic/Psionics
   * @todo add Ammo/Uses to Combat, Magic
   * @todo when Aggregate Attacks change, recalculate ft/attack fields
   *
   * Questions
   * - Paratrooper gets a save vs. Torture. What is this?
   *
   * @todo standardize/improve markup on Core tab
   *
   * @todo add an active combat section above Aggregate bonuses
   *    - track attacks
   *    - track ammo (roll20 has something for this)
   *    - track MDC - for each aggregate MDC modifier, track it separately in a repeater. allow the user to reorder, and deduct from bottom to top
   *
   * @todo Magic - include checkbox beside each spell to add it as a row on the Combat tab
   * @todo Psionics - include checkbox beside each psionic to add it as a row on the Combat tab
   * @todo consider spells/gear that modifies attributes (either as a modifier or an absolute value),
   *    modifies PS type,
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   *
   * @todo better better build process with imports/file modules
   *
   * To get Character ID, `getAttrs(["character_id"])`
   * */

  /**
   * This one could be a doozy
   * */
  on("change:character_level", (e) => {
    console.log("change:character_level", e.newValue, e.previousValue);
    // Update WPs
    updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    updateSkillLevels(+e.newValue, +e.previousValue);
    updateMagicPsionicsLevels();
  });

  const buttonlist = [
    "core",
    "wp",
    "combat",
    "bonuses",
    "equipment",
    "skills",
    "magic",
    "psionics",
    "importexport",
  ];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({ sheetTab: button });
    });
  });
</script>
