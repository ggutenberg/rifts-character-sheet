<main id="megaverse">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">Combat</button>
    <button class="metal linear" type="action" name="act_bonuses">
      Bonuses
    </button>
    <button class="metal linear" type="action" name="act_magic">Magic</button>
    <button class="metal linear" type="action" name="act_psionics">
      Psionics
    </button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
    <button class="metal linear" type="action" name="act_importexport">
      Imp/Exp
    </button>
    <img
      class="logo"
      src="https://db4sgowjqfwig.cloudfront.net/game_systems/22/assets/1100695/rifts-logo.png"
    />
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />

  <datalist id="distance-units">
    <option value="m"></option>
    <option value="km"></option>
    <option value="ft"></option>
    <option value="yd"></option>
    <option value="mi"></option>
  </datalist>
  <datalist id="damage-units">
    <option value="MDC"></option>
    <option value="SDC"></option>
  </datalist>
  <datalist id="time-units">
    <option value="seconds"></option>
    <option value="melees"></option>
    <option value="minutes"></option>
    <option value="hours"></option>
    <option value="days"></option>
    <option value="months"></option>
    <option value="years"></option>
  </datalist>
  <datalist id="spell-schools">
    <option value="Invocation"></option>
    <option value="Elemental"></option>
    <option value="Necromancy"></option>
  </datalist>
  <datalist id="combat-modifiers">
    <option value="Custom - Type Your Own"></option>
    <option value="Hand to Hand: Basic"></option>
    <option value="Hand to Hand: Dragon"></option>
    <option value="RPA Basic"></option>
    <option value="RPA Elite: Glitter Boy"></option>
    <option value="Weapon: NG-P7"></option>
    <option value="Weapon: TW Flame Sword"></option>
    <option value="Armor: Crusader"></option>
    <option value="Power Armor: Glitter Boy"></option>
    <option value="TW: Armor of Ithan"></option>
    <option value="Spell: Superhuman Speed"></option>
    <option value="Psionic: Sixth Sense"></option>
    <option value="Magic Amulet: Charm"></option>
  </datalist>

  <div class="core">
    <br />
    <h1>Character Statistics</h1>
    <div class="grid-container">
      <div class="section-one character-background">
        <label
          ><span>Character Name</span>
          <input
            id="character-name"
            type="text"
            value=""
            name="attr_character_name"
        /></label>
        <label
          ><span>True Name</span>
          <input type="text" value="" name="attr_truename_name"
        /></label>
        <label
          ><span>Race</span>
          <input type="text" value="" name="attr_character_race"
        /></label>
        <label
          ><span>Character Class</span>
          <input type="text" value="" name="attr_occ"
        /></label>
        <label
          ><span>Strength Type</span>
          <select class="" name="attr_ps_type" value="normal">
            <option value="normal">Normal</option>
            <option value="augmented">Augmented</option>
            <option value="robotic">Robotic</option>
            <option value="supernatural">Supernatural</option>
          </select></label
        >
        <label
          ><span>Level</span> <input type="number" name="attr_character_level"
        /></label>
        <label
          ><span>Experience</span> <input type="number" name="attr_experience"
        /></label>
        <label
          ><span>Alignment</span>
          <select class="select" name="attr_alignment" value="0">
            <option value="0"></option>
            <option value="Principled">Principled</option>
            <option value="Scrupulous">Scrupulous</option>
            <option value="Unprincipled">Unprincipled</option>
            <option value="Anarchist">Anarchist</option>
            <option value="Taoist">Taoist</option>
            <option value="Miscreant">Miscreant</option>
            <option value="Abberant">Aberrant</option>
            <option value="Diabolic">Diabolic</option>
          </select></label
        >
        <label
          ><span>Age</span>
          <input
            class="attribute"
            type="number"
            value=""
            name="attr_character_age"
        /></label>
        <label
          ><span>Gender</span>
          <input type="text" value="" name="attr_character_gender"
        /></label>
        <label
          ><span>Height</span>
          <input type="text" value="" name="attr_character_height"
        /></label>
        <label
          ><span>Weight</span>
          <input type="text" value="" name="attr_character_weight"
        /></label>
        <label
          ><span>Family Origin</span>
          <input type="text" value="" name="attr_character_familyorigin"
        /></label>
        <label
          ><span>Environment</span>
          <input value="" name="attr_character_environment"
        /></label>
        <label
          ><span>Native Language(s)</span>
          <input type="text" value="" name="attr_character_languages"
        /></label>
        <label
          ><span>Insanity, if any</span>
          <input type="text" value="" name="attr_character_insanity"
        /></label>
        <label
          ><span>Disposition</span>
          <input type="text" value="" name="attr_character_disposition"
        /></label>
      </div>

      <div class="section-two">
        <div class="ss-2a">
          <label for="iq">I.Q.</label>
          <input
            id="iq"
            type="number"
            value="0"
            name="attr_iq"
            title="Intelligence Quotient"
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_iq_bonus"
            title="+ Skills %"
            readonly
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_perception_bonus"
            title="+ Perception (Rifter #13, p.16)"
            readonly
          />

          <label for="mental-endurance">M.E.</label>
          <input
            id="mental-endurance"
            type="number"
            value="0"
            name="attr_me"
            title="Mental Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_me_bonus"
            title="+ Save vs. Psionics"
            readonly
          />
          <div></div>

          <label for="mental-affinity">M.A.</label>
          <input
            id="mental-affinity"
            type="number"
            value="0"
            name="attr_ma"
            title="Mental Affinity"
          />
          <input
            type="number"
            value="0"
            name="attr_ma_bonus"
            title="% Trust/Intimidate"
            readonly
          />
          <div></div>

          <label for="physical-strength">P.S.</label>
          <input
            id="physical-strength"
            type="number"
            value="0"
            name="attr_ps"
            title="Physical Strength"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_ps_bonus"
            title="+ SDC Damage"
            readonly
          />
          <div></div>

          <label for="physical-prowess">P.P</label>
          <input
            id="physical-prowess"
            type="number"
            value="0"
            name="attr_pp"
            title="Physical Prowess"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pp_bonus"
            title="+ Strike/Parry/Dodge/Entangle/Disarm"
            readonly
          />
          <div></div>

          <label for="physical-endurance">P.E.</label>
          <input
            id="physical-endurance"
            type="number"
            value="0"
            name="attr_pe"
            title="Physical Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_bonus"
            title="+ Magic/Poison/Toxins"
            readonly
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_coma_bonus"
            title="+ Coma/Death %"
            readonly
          />

          <label for="physical-beauty">P.B.</label>
          <input
            id="physical-beauty"
            type="number"
            value="0"
            name="attr_pb"
            title="Physical Beauty"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pb_bonus"
            title="% Charm/Impress"
            readonly
          />
          <div></div>

          <label for="speed">Spd</label>
          <input
            id="speed"
            type="number"
            value="0"
            name="attr_spd"
            title="Speed"
          />
        </div>
        <div class="ss-2b">
          <label for="trust-intimidate">Trust/Intimidate</label>
          <input
            id="trust-intimidate"
            type="number"
            value="0"
            name="attr_trust_intimidate"
          /><span>%</span>

          <label for="charm-impress">Charm/Impress</label>
          <input
            id="charm-impress"
            type="number"
            value="0"
            name="attr_charm_impress"
          /><span>%</span>
        </div>
        <div class="ss-2c">
          <label for="restrained-punch">Restrained Punch</label>
          <input
            id="restrained-punch"
            type="text"
            name="attr_restrained_punch"
          />
          <select name="attr_restrained_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="punch">Punch</label>
          <input id="punch" type="text" name="attr_punch" />
          <select name="attr_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="power-punch">Power Punch</label>
          <input id="power-punch" type="text" name="attr_power_punch" />
          <select name="attr_power_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="kick">Kick</label>
          <input id="kick" type="text" name="attr_kick" />
          <select name="attr_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="leap-kick">Leap Kick</label>
          <input id="leap-kick" type="text" name="attr_leap_kick" />
          <select name="attr_leap_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="lift">Lift</label>
          <input id="lift" type="number" value="0" name="attr_lift" />
          <div></div>

          <label for="carry">Carry</label>
          <input id="carry" type="number" value="0" name="attr_carry" />
          <div></div>

          <label for="throw">Throw</label>
          <input id="throw" type="number" value="0" name="attr_throw" />
          <div></div>

          <label for="carry-max">Carry Max</label>
          <input
            id="carry-max"
            type="number"
            value="0"
            name="attr_carry_max"
          />Minutes

          <label for="carry-running">Carry (Running)</label>
          <input
            id="carry-running"
            type="number"
            value="0"
            name="attr_carry_running"
          />Minutes

          <label for="hold-max">Hold Max.</label>
          <input
            id="hold-max"
            type="number"
            value="0"
            name="attr_hold_max"
          />Melees
        </div>
      </div>
      <div class="section-three">
        <label
          ><span>Hit Points</span>
          <input type="number" value="0" name="attr_character_hp" />
        </label>
        <label>
          <span>S.D.C.</span>
          <input type="number" value="0" name="attr_character_sdc" />
        </label>
        <label
          ><span>A.R.</span
          ><input type="number" value="0" name="attr_character_ar"
        /></label>
        <label
          ><span>M.D.C.</span>
          <input type="number" value="0" name="attr_character_mdc" />
        </label>
        <label
          ><span>P.P.E.</span>
          <input type="number" value="0" name="attr_character_ppe" />
        </label>
        <label
          ><span>I.S.P.</span
          ><input type="number" value="0" name="attr_character_isp"
        /></label>
        <label
          ><span>H.F.</span
          ><input type="number" value="0" name="attr_character_hf"
        /></label>
        <label
          ><span>Perception</span>
          <input
            id="perception"
            type="number"
            value="0"
            name="attr_perception"
          />
          <button type="roll" value="Perception: [[d20+@{perception}]]" />
        </label>
      </div>
    </div>

    <h2>Movement</h2>
    <div class="movement-container">
      <div></div>
      <label for="mph">MPH</label>
      <label for="ft-melee">Ft/Melee</label>
      <label for="ft-attack">Ft/Attack</label>
      <label for="cruising">Cruising</label>
      <label for="run-at-max">Run at Max</label>
      <label>Run</label>
      <input id="mph" type="number" value="0" readonly name="attr_run_mph" />
      <input
        id="ft-melee"
        type="number"
        value="0"
        readonly
        name="attr_run_ft_melee"
      />
      <input
        id="ft-attack"
        type="number"
        value="0"
        readonly
        name="attr_run_ft_attack"
      />
      <input id="cruising" type="number" value="0" name="attr_run_cruising" />
      <div>
        <input
          id="run-at-max"
          type="number"
          value="@{pe}/2"
          disabled="true"
          name="attr_run_at_max"
        />
        minutes
      </div>

      <label>Leaping Distance</label>
      <input type="number" name="attr_leapup" value="0" />
      <div>feet up?</div>
      <input type="number" name="attr_leapout" value="0" />
      <div>feet out?</div>
      <div></div>
    </div>
    <br />
    <div class="repeating-movement">
      <fieldset class="repeating_movement">
        <h5>Additional Movement Type</h5>
        <h5>MPH</h5>
        <h5>Ft/Melee</h5>
        <h5>Ft/Attack</h5>
        <h5>Cruising</h5>
        <h5>Max speed duration</h5>
        <input type="text" value="" name="attr_name" />
        <input type="number" value="0" name="attr_mph" />
        <input type="number" value="0" name="attr_ft_melee" />
        <input type="number" value="0" name="attr_ft_attack" readonly />
        <input type="number" value="0" name="attr_cruising" />
        <label
          ><input type="number" value="0" name="attr_dur_at_max" />
          minutes</label
        >
      </fieldset>
    </div>
  </div>
  <br />

  <div class="wp">
    <div class="wp-container">
      <h3>Ancient Weapon Proficiencies</h3>
      <fieldset class="repeating_wp">
        <h5>Weapon Proficiency</h5>
        <h5>Strike</h5>
        <h5>Parry</h5>
        <h5>Disarm</h5>
        <h5>Throw</h5>
        <h5>Entangle</h5>
        <h5>RoF</h5>
        <h5>Level</h5>
        <h5>Row ID</h5>
        <input type="hidden" name="attr_bonus_id" value="" />
        <input type="text" list="weaponProficiencies" name="attr_name" />
        <datalist id="weaponProficiencies">
          <option value="Archery"></option>
          <option value="Axe"></option>
          <option value="Blunt"></option>
          <option value="Chain"></option>
          <option value="Forked"></option>
          <option value="Knife"></option>
          <option value="Grappling Hook"></option>
          <option value="Pole Arm"></option>
          <option value="Rope"></option>
          <option value="Shield"></option>
          <option value="Spear"></option>
          <option value="Staff"></option>
          <option value="Sword"></option>
          <option value="Targeting"></option>
          <option value="Whip"></option>
        </datalist>
        <input type="number" value="0" name="attr_strike" />
        <input type="number" value="0" name="attr_parry" />
        <input type="number" value="0" name="attr_disarm" />
        <input type="number" value="0" name="attr_throw" />
        <input type="number" value="0" name="attr_entangle" />
        <input type="number" value="0" name="attr_rof" />
        <input type="number" value="0" name="attr_level" />
        <input type="string" value="" name="attr_rowid" readonly />
      </fieldset>
      <hr />
      <h3>Modern Weapon Proficiencies</h3>
      <fieldset class="repeating_wpmodern">
        <h5>Weapon Proficiency</h5>
        <h5>Single</h5>
        <h5>Burst</h5>
        <h5>Level</h5>
        <h5>Row ID</h5>
        <input type="hidden" name="attr_bonus_id" value="" />
        <input type="text" list="weaponProficienciesModern" name="attr_name" />
        <datalist id="weaponProficienciesModern">
          <option value="Handguns"></option>
          <option value="Rifles"></option>
          <option value="Energy Heavy"></option>
          <option value="Energy Pistol"></option>
          <option value="Energy Rifle"></option>
          <option value="Heavy"></option>
          <option value="Speargun"></option>
          <option value="Shotgun"></option>
          <option value="Submachinegun"></option>
          <option value="Flamethrower"></option>
        </datalist>
        <input type="number" value="0" name="attr_strike_range_single" />
        <input type="number" value="0" name="attr_strike_range_burst" />
        <input type="number" value="0" name="attr_level" />
        <input type="text" value="" name="attr_rowid" readonly />
      </fieldset>
    </div>
  </div>

  <div class="combat">
    <div class="combat-container">
      <h3>Combat Modifiers</h3>
      <details>
        <summary><b>Instructions</b></summary>
        <p>
          Complete the repeating sections for your various combat skills and
          modifiers. Skill dropdowns are free-form, so you can type anything in
          them and don't need to select from the list. What's there is just a
          small sample.
        </p>
        <p>
          Any modifiers you add will appear as checkboxes on the Bonuses tab.
          Toggling them will recalculate the bonuses for all checked items.
        </p>
        <p>
          If you have additional bonuses from items, magic, training, etc., you
          can create arbitrarily named sections and apply those as well. You can
          also add weapons here, and include any strike/parry bonuses they
          provide, as well as their damage.
        </p>
      </details>
      <p>Click <b>Instructions</b> for detailed instructions.</p>
      <fieldset class="repeating_combat">
        <input type="hidden" name="attr_bonus_id" value="" />
        <div class="bonus-thing-heading">
          <label
            ><span>Thing</span>
            <input type="text" list="combat-modifiers" name="attr_name" />
          </label>
          <label
            ><span>Level</span>
            <input type="number" value="1" name="attr_level" />
          </label>
        </div>
        <!-- inject:partials/repeating_bonuses_details.html -->
        <!-- endinject -->
      </fieldset>
    </div>
  </div>

  <div class="bonuses">
    <div class="combat-container">
      <h3>Aggregated Bonuses</h3>
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Any combat modifiers you add on the Combat tab will appear as
            checkboxes. Toggling them will recalculate the bonuses for all
            checked items.
          </p>
          <p>
            Any Weapon Proficiencies you add on the WPs tab will appear on this
            page as well. Weapon Proficiencies <b>automatically</b> calculate
            their bonuses based on level, but no other skill (like Hand-to-Hand)
            does so yet.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. Damage adds everything together as a rollable field, and
            prompts to add Punch damage. Crit/Knockout/Death Blow use the lowest
            of the available options (ex. Crit: 17 is better than Crit: 19).
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <fieldset class="repeating_bonusselections">
          <label>
            <input type="checkbox" name="attr_enabled" value="1" />
            <span name="attr_name"></span
          ></label>
          <input type="hidden" name="attr_name" value="" />
          <input type="hidden" name="attr_bonus_id" value="" />
          <input type="hidden" name="attr_bonus_section" value="" />
        </fieldset>
        <hr />
        <div class="combat-combined-bonuses">
          <label
            ><span>Attacks</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_attacks"
            />
          </label>
          <label
            ><span>S.D.C.</span
            ><input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_sdc"
          /></label>
          <label
            ><span>M.D.C.</span
            ><input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_mdc"
          /></label>
          <label
            ><span>Initiative</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_initiative"
            />
            <button
              type="roll"
              value="Initiative: [[d20+@{combat_combined_initiative} &{tracker}]]"
            />
          </label>
          <label
            ><span>Strike</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_strike"
            />
            <button
              type="roll"
              value="Strike: [[d20+@{combat_combined_strike}]]"
            />
          </label>
          <label
            ><span>Parry</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_parry"
            />
            <button
              type="roll"
              value="Parry: [[d20+@{combat_combined_parry}]]"
            />
          </label>
          <label
            ><span>Dodge</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_dodge"
            />
            <button
              type="roll"
              value="Dodge: [[d20+@{combat_combined_dodge}]]"
            />
          </label>
          <label
            ><span>Throw</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_throw"
            />
            <button
              type="roll"
              value="Throw: [[d20+@{combat_combined_throw}]]"
            />
          </label>
          <label
            ><span>Disarm</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_disarm"
            />
            <button
              type="roll"
              value="Disarm: [[d20+@{combat_combined_disarm}]]"
            />
          </label>
          <label
            ><span>Entangle</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_entangle"
            />
            <button
              type="roll"
              value="Entangle: [[d20+@{combat_combined_entangle}]]"
            />
          </label>
          <label
            ><span>Pull Punch</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_pull"
            />
            <button
              type="roll"
              value="Pull Punch: [[d20+@{combat_combined_pull}]]"
            />
          </label>
          <label
            ><span>Roll w/ Impact</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_roll"
            />
            <button
              type="roll"
              value="Roll w/ Impact: [[d20+@{combat_combined_roll}]]"
            />
          </label>
          <label
            ><span>Damage</span>
            <input
              readonly
              type="text"
              value="0"
              name="attr_combat_combined_damage"
            />
            <button
              type="roll"
              value="?{Add damage modifier?|
                None,Damage: [[@{combat_combined_damage}]]|
                Punch,Damage: [[@{combat_combined_damage}+@{punch}]]|
                P.S. Bonus,Damage: [[@{combat_combined_damage}+@{ps_bonus}]]
              }"
            />
          </label>
          <label
            ><span>Dodge: Flight</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_dodge_flight"
            />
            <button
              type="roll"
              value="Dodge in Flight: [[d20+@{combat_combined_dodge_flight}]]"
            />
          </label>
          <label
            ><span>Dodge: Auto</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_dodge_auto"
            />
            <button
              type="roll"
              value="Auto Dodge: [[d20+@{combat_combined_dodge_auto}]]"
            />
          </label>
          <label
            ><span>Dodge: Teleport</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_dodge_teleport"
            />
            <button
              type="roll"
              value="Teleport Dodge: [[d20+@{combat_combined_dodge_teleport}]]"
            />
          </label>
          <label
            ><span>Dodge: Motion</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_dodge_motion"
            />
            <button
              type="roll"
              value="Dodge in Motion: [[d20+@{combat_combined_dodge_motion}]]"
            />
          </label>
          <label
            ><span>Strike: Range</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_strike_range"
            />
            <button
              type="roll"
              value="Range Strike: [[d20+@{combat_combined_strike_range}]]"
            />
          </label>
          <label
            ><span
              >Range: Single<span title="Includes Strike: Range"
                >&nbsp;&#9432;</span
              >
            </span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_strike_range_single"
            />
            <button
              type="roll"
              value="Range Strike - Single Shot: [[d20+@{combat_combined_strike_range_single}]]"
            />
          </label>
          <label
            ><span
              >Range: Burst
              <span title="Includes Strike: Range">&nbsp;&#9432;</span></span
            >
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_strike_range_burst"
            />
            <button
              type="roll"
              value="Range Strike - Burst: [[d20+@{combat_combined_strike_range_burst}]]"
            />
          </label>
          <label
            ><span>Critical</span>
            <input
              type="number"
              value="20"
              name="attr_combat_combined_critical"
          /></label>
          <label
            ><span>Knockout</span>
            <input type="number" value="0" name="attr_combat_combined_knockout"
          /></label>
          <label
            ><span>Death Blow</span>
            <input
              type="number"
              value="0"
              name="attr_combat_combined_deathblow"
          /></label>
        </div>
        <hr />
        <h4>Saving Throws</h4>
        <div class="combat-combined-bonuses">
          <label
            ><span>Perception</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_perceptioncheck"
            />
            <button
              type="roll"
              value="Perception Check: [[d20+@{combat_combined_perceptioncheck}]]"
            />
          </label>
          <label
            ><span>Psionics</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_psionics"
            />
            <button
              type="roll"
              value="Save vs. Psionics: [[d20+@{combat_combined_psionics}]]"
            />
          </label>
          <label
            ><span>Magic</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_magic"
            />
            <button
              type="roll"
              value="Save vs. Magic: [[d20+@{combat_combined_magic}]]"
            />
          </label>
          <label
            ><span>Horror Factor</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_horrorfactor"
            />
            <button
              type="roll"
              value="Save vs. Horror Factor: [[d20+@{combat_combined_horrorfactor}]]"
            />
          </label>
          <label
            ><span>Mind Control</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_mindcontrol"
            />
            <button
              type="roll"
              value="Save vs. Mind Control: [[d20+@{combat_combined_mindcontrol}]]"
            />
          </label>
          <label
            ><span>Disease</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_disease"
            />
            <button
              type="roll"
              value="Save vs. Disease: [[{d20+@{combat_combined_disease}}>13]]"
            />
          </label>
          <label
            ><span>Illusions</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_illusions"
            />
            <button
              type="roll"
              value="Save vs. Illusions: [[d20+@{combat_combined_illusions}]]"
            />
          </label>
          <label
            ><span>Possession</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_possession"
            />
            <button
              type="roll"
              value="Save vs. Possession: [[d20+@{combat_combined_possession}]]"
            />
          </label>
          <label
            ><span>Insanity</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_insanity"
            />
            <button
              type="roll"
              value="Save vs. Insanity: [[d20+@{combat_combined_insanity}]]"
            />
          </label>
          <label
            ><span>Pain</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_pain"
            />
            <button
              type="roll"
              value="Save vs. Pain: [[d20+@{combat_combined_pain}]]"
            />
          </label>
          <label
            ><span>Lethal Poison</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_lethalpoison"
            />
            <button
              type="roll"
              value="Save vs. Lethal Poison: [[{d20+@{combat_combined_lethalpoison}}>13]]"
            />
          </label>
          <label
            ><span>Non-Lethal Poison</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_nonlethalpoison"
            />
            <button
              type="roll"
              value="Save vs. Non-Lethal Poison: [[{d20+@{combat_combined_nonlethalpoison}}>15]]"
            />
          </label>
          <label
            ><span>Drugs</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_drugs"
            />
            <button
              type="roll"
              value="Save vs. Drugs: [[{d20+@{combat_combined_drugs}}>14]]"
            />
          </label>
          <label
            ><span>Curses</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_curses"
            />
            <button
              type="roll"
              value="Save vs. Curses: [[{d20+@{combat_combined_curses}}>14]]"
            />
          </label>
          <label
            ><span>Coma/Death</span>
            <input
              readonly
              type="number"
              value="0"
              name="attr_combat_combined_comadeath"
            />
            <button
              type="roll"
              value="Save vs. Coma/Death: [[d100-@{combat_combined_comadeath}]]"
            />
          </label>
        </div>
      </div>
      <div class="hidden">
        <h3>Bonus Sources</h3>
        <fieldset class="repeating_bonuses">
          <div class="bonus-type-container">
            <input type="hidden" name="attr_bonus_selection_id" value="" />
            <label
              ><span>Skill</span>
              <input type="text" list="combat-modifiers" name="attr_name" />
            </label>
            <label
              ><span>Level</span>
              <input type="number" value="1" name="attr_level" />
            </label>
            <div></div>
            <div></div>
          </div>
          <!-- inject:partials/repeating_bonuses_details.html -->
          <!-- endinject -->
        </fieldset>
      </div>
    </div>
  </div>

  <div class="skills">
    <h3>Skills</h3>
    <p>Note that skills include IQ bonus.</p>
    <fieldset class="repeating_skills">
      <div class="values">
        <h5>Skill</h5>
        <h5>Category</h5>
        <h5>Base</h5>
        <h5>Bonus</h5>
        <h5>Per Level</h5>
        <h5>Level</h5>
        <h5>Total</h5>
        <h5></h5>
        <input type="text" value="" name="attr_name" />
        <select name="attr_category" value="occ">
          <option value="occ">O.C.C.</option>
          <option value="related">O.C.C. Related</option>
          <option value="secondary">Secondary</option>
        </select>
        <input type="number" value="0" name="attr_base" />
        <input type="number" value="0" name="attr_bonus" />
        <input type="number" value="0" name="attr_perlevel" />
        <input type="number" value="1" name="attr_level" />
        <input type="number" value="0" name="attr_total" />
        <button
          type="roll"
          value="@{character_name} @{skill} check: [[d100<@{total}]]"
        />
      </div>
      <details>
        <summary>
          <b>Describe <span name="attr_name"></span></b>
        </summary>
        <textarea name="attr_description" value=""></textarea>
        <div class="macro-help">
          <label
            ><span><b>Row ID:</b></span>
            <input type="text" readonly name="attr_rowid" value=""
          /></label>
        </div>
      </details>
    </fieldset>
  </div>

  <div class="magic">
    <h3>Magic</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter a Spell name and its PPE. Optionally set the School and Spell
        Level. Then expand the Details, and fill in the applicable values. They
        will calculate and populate Range, Damage, Duration, and Skill if
        applicable.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Press the Cast button to remove the PPE from the Current PPE input
        field. Click Reset PPE to set Current PPE back to the value on the Core
        tab. Note the roll button beside Damage and Skill.
      </p>
      <p>
        Don't forget to copy/paste the spell description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <label
      ><span>Current P.P.E.</span>
      <input type="number" name="attr_currentppe" value="0" />
      <button type="action" name="act_resetppe">Reset P.P.E.</button>
    </label>
    <fieldset class="repeating_magic">
      <div class="spells-list">
        <h5>Spell</h5>
        <h5>School</h5>
        <h5>Spell Level</h5>
        <h5>Range</h5>
        <h5>Damage</h5>
        <h5></h5>
        <h5>Duration</h5>
        <h5>Skill</h5>
        <h5></h5>
        <h5>P.P.E.</h5>
        <h5></h5>
        <input type="text" value="" name="attr_name" />
        <input type="text" value="" name="attr_school" list="spell-schools" />
        <input type="number" value="1" name="attr_spell_level" />
        <input type="text" value="0" name="attr_range" />
        <input type="text" value="0" name="attr_damage" />
        <button
          type="roll"
          value="@{character_name} @{name} [[@{damage}]] @{damage_unit}"
        />
        <input type="text" value="0" name="attr_duration" />
        <input type="number" value="0" name="attr_percentage" />
        <button
          type="roll"
          value="@{character_name} @{name} check: [[d100<@{percentage}]]"
        />
        <input type="number" value="0" name="attr_ppe" />
        <button type="action" name="act_usespell">Cast</button>
      </div>
      <details>
        <summary>
          <b>Details for <span name="attr_name"></span></b>
        </summary>
        <div class="spell-details">
          <label
            ><span>Starting range</span
            ><input type="number" value="0" name="attr_range_starting"
          /></label>
          <label
            ><span>Range per level</span
            ><input type="number" value="0" name="attr_range_per_level"
          /></label>
          <label
            ><span>Range unit</span
            ><input
              type="text"
              value=""
              name="attr_range_unit"
              list="distance-units"
            />
          </label>
          <label
            ><span>Starting damage</span
            ><input type="text" value="0" name="attr_damage_starting"
          /></label>
          <label
            ><span>Damage per level</span
            ><input type="text" value="0" name="attr_damage_per_level"
          /></label>
          <label
            ><span>Damage unit</span
            ><input
              type="text"
              value=""
              name="attr_damage_unit"
              list="damage-units"
            />
          </label>
          <label
            ><span>Starting duration</span
            ><input type="number" value="0" name="attr_duration_starting"
          /></label>
          <label
            ><span>Duration per level</span
            ><input type="number" value="0" name="attr_duration_per_level"
          /></label>
          <label
            ><span>Duration unit</span
            ><input
              type="text"
              value=""
              name="attr_duration_unit"
              list="time-units"
            />
          </label>
          <label
            ><span>Starting skill %</span
            ><input type="number" value="0" name="attr_percentage_starting"
          /></label>
          <label
            ><span>Skill % per level</span
            ><input type="number" value="0" name="attr_percentage_per_level"
          /></label>
          <label></label>
        </div>
        <label
          ><b>Description</b>
          <textarea class="full" name="attr_description" value=""></textarea>
        </label>
        <div class="macro-help">
          <label
            ><span><b>Row ID:</b></span>
            <input type="text" readonly name="attr_rowid" value=""
          /></label>
        </div>
      </details>
    </fieldset>
  </div>

  <div class="psionics">
    <h3>Psionics</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter a Psionic name and its ISP. Then expand the Details, and fill in
        the applicable values. They will calculate and populate Range, Damage,
        Duration, and Skill if applicable.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Press the Use button to remove the ISP from the Current ISP input field.
        Click Reset ISP to set Current ISP back to the value on the Core tab.
        Note the roll button beside Damage and Skill.
      </p>
      <p>
        Don't forget to copy/paste the power description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <label
      ><span>Current I.S.P.</span>
      <input type="number" name="attr_currentisp" value="0" />
      <button type="action" name="act_resetisp">Reset I.S.P.</button>
    </label>
    <fieldset class="repeating_psionics">
      <div class="psionics-list">
        <h5>Psionic</h5>
        <h5>Range</h5>
        <h5>Damage</h5>
        <h5></h5>
        <h5>Duration</h5>
        <h5>Skill</h5>
        <h5></h5>
        <h5>I.S.P.</h5>
        <h5></h5>
        <input type="text" value="" name="attr_name" />
        <input type="text" value="0" name="attr_range" />
        <input type="text" value="0" name="attr_damage" />
        <button
          type="roll"
          value="@{character_name} @{name} [[@{damage}]] @{damage_unit}"
        />
        <input type="text" value="0" name="attr_duration" />
        <input type="number" value="0" name="attr_percentage" />
        <button
          type="roll"
          value="@{character_name} @{name} check: [[d100<@{percentage}]]"
        />
        <input type="number" value="0" name="attr_isp" />
        <button type="action" name="act_usepsionic">Use</button>
      </div>
      <details>
        <summary>
          <b>Details for <span name="attr_name"></span></b>
        </summary>
        <div class="psionic-details">
          <label
            ><span>Starting range</span
            ><input type="number" value="0" name="attr_range_starting"
          /></label>
          <label
            ><span>Range per level</span
            ><input type="number" value="0" name="attr_range_per_level"
          /></label>
          <label
            ><span>Range unit</span
            ><input
              type="text"
              value=""
              name="attr_range_unit"
              list="distance-units"
            />
          </label>
          <label
            ><span>Starting damage</span
            ><input type="text" value="0" name="attr_damage_starting"
          /></label>
          <label
            ><span>Damage per level</span
            ><input type="text" value="0" name="attr_damage_per_level"
          /></label>
          <label
            ><span>Damage unit</span
            ><input
              type="text"
              value=""
              name="attr_damage_unit"
              list="damage-units"
            />
          </label>
          <label
            ><span>Starting duration</span
            ><input type="number" value="0" name="attr_duration_starting"
          /></label>
          <label
            ><span>Duration per level</span
            ><input type="number" value="0" name="attr_duration_per_level"
          /></label>
          <label
            ><span>Duration unit</span
            ><input
              type="text"
              value=""
              name="attr_duration_unit"
              list="time-units"
            />
          </label>
          <label
            ><span>Starting skill %</span
            ><input type="number" value="0" name="attr_percentage_starting"
          /></label>
          <label
            ><span>Skill % per level</span
            ><input type="number" value="0" name="attr_percentage_per_level"
          /></label>
          <label></label>
        </div>
        <label
          ><b>Description</b>
          <textarea class="full" name="attr_description" value=""></textarea>
        </label>
        <div class="macro-help">
          <label
            ><span><b>Row ID:</b></span>
            <input type="text" readonly name="attr_rowid" value=""
          /></label>
        </div>
      </details>
    </fieldset>
  </div>

  <div class="equipment">
    <h3>Equipment</h3>
    <p>Free form equipment list for now.</p>
    <textarea class="full tall" name="attr_equipment"></textarea>
  </div>

  <div class="importexport">
    <h3>Import/Export</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Click the <b>Export</b> button to get a JSON object representing your
        character. Paste a valid JSON object and click <b>Import</b> to import a
        character.
      </p>
      <p>
        In order to know what the valid fields are, complete all the fields with
        at least one of each repeating section and do an Export.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <button type="action" name="act_import">Import</button>
    <button type="action" name="act_export">Export</button>
    <textarea class="full tall" name="attr_importexport"></textarea>
  </div>
</main>
<script type="text/javascript">
  // Change from javascript to worker before upload

  /* inject:js/definitions.js */
  /* endinject */

  /* inject:js/utils.js */
  /* endinject */

  /* inject:js/combat.js */
  /* endinject */

  /* inject:js/attributes.js */
  /* endinject */

  /* inject:js/skills.js */
  /* endinject */

  /* inject:js/magic_psionics.js */
  /* endinject */

  /* inject:js/movement.js */
  /* endinject */

  /* inject:js/import_export.js */
  /* endinject */

  /**
   * @todo Add Repeating Movement and Equipment to export
   * @todo add Bonus: Body Flip/Throw
   * @todo make calculated skill % readonly
   * @todo add Aimed and Called shot bonus fields
   * @todo add Disarm: Range field
   * @todo add tab for Powers/Abilities (like Psionics) - Skill %, Range, Duration, Damage, MDC,
   * - Regenerate | Damage: 1d6*5 | Duration: 1 min
   * @todo add MDC to Magic/Psionics
   * @todo add Ammo/Uses to Combat, Magic
   * @todo add Description field to Combat
   * @todo when Aggregate Attacks change, recalculate ft/attack fields
   *
   * Questions
   * - Paratrooper gets a save vs. Torture. What is this?
   *
   * @todo standardize/improve markup on Core tab
   *
   * @todo add an active combat section above Aggregate bonuses
   *    - track attacks
   *    - track ammo (roll20 has something for this)
   *    - track MDC - for each aggregate MDC modifier, track it separately in a repeater. allow the user to reorder, and deduct from bottom to top
   *
   * @todo Magic - include checkbox beside each spell to add it as a row on the Combat tab
   * @todo Psionics - include checkbox beside each psionic to add it as a row on the Combat tab
   * @todo consider spells/gear that modifies attributes (either as a modifier or an absolute value),
   *    modifies PS type,
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   *
   * @todo better better build process with imports/file modules
   *
   * To get Character ID, `getAttrs(["character_id"])`
   * */

  /**
   * This one could be a doozy
   * */
  on("change:character_level", (e) => {
    console.log("change:character_level", e.newValue, e.previousValue);
    // Update WPs
    updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    updateSkillLevels(+e.newValue, +e.previousValue);
    updateMagicPsionicsLevels();
  });

  const buttonlist = [
    "core",
    "wp",
    "combat",
    "bonuses",
    "equipment",
    "skills",
    "magic",
    "psionics",
    "importexport",
  ];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({ sheetTab: button });
    });
  });
</script>
