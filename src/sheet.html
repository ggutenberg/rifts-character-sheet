<!-- Add class="debug" to <main> for debugging -->
<main id="megaverse" class="xdebug">
  <img
    class="logo"
    src="https://db4sgowjqfwig.cloudfront.net/game_systems/22/assets/1100695/rifts-logo.png"
  />
  <div class="r-tabbed">
    <input type="radio" id="tab-core" name="css-tabs" checked />
    <input type="radio" id="tab-skills" name="css-tabs" />
    <input type="radio" id="tab-wps" name="css-tabs" />
    <input type="radio" id="tab-powersabilities" name="css-tabs" />
    <input type="radio" id="tab-magic" name="css-tabs" />
    <input type="radio" id="tab-psionics" name="css-tabs" />
    <input type="radio" id="tab-modifiers" name="css-tabs" />
    <input type="radio" id="tab-bonuses" name="css-tabs" />
    <input type="radio" id="tab-equipment" name="css-tabs" />
    <input type="radio" id="tab-importexport" name="css-tabs" />

    <ul class="r-tabs">
      <li class="r-tab">
        <label class="" for="tab-core">Core</label>
      </li>
      <li class="r-tab"><label for="tab-skills">Skills</label></li>
      <li class="r-tab"><label for="tab-wps">WPs</label></li>
      <li class="r-tab"><label for="tab-powersabilities">Abilities</label></li>
      <li class="r-tab"><label for="tab-magic">Magic</label></li>
      <li class="r-tab"><label for="tab-psionics">Psionics</label></li>
      <li class="r-tab"><label for="tab-modifiers">Modifiers</label></li>
      <li class="r-tab"><label for="tab-bonuses">Profiles</label></li>
      <li class="r-tab"><label for="tab-equipment">Equipment</label></li>
      <li class="r-tab"><label for="tab-importexport">Imp/Exp</label></li>
    </ul>

    <div class="r-tab-content">
      <!-- inject:partials/datalists.html -->
      <!-- endinject -->

      <!-- inject:partials/core.html -->
      <!-- endinject -->
    </div>

    <br />

    <div class="r-tab-content">
      <!-- inject:partials/skills.html -->
      <!-- endinject -->
    </div>

    <div class="r-tab-content">
      <!-- inject:partials/weapon_proficiencies.html -->
      <!-- endinject -->
    </div>

    <div class="r-tab-content">
      <div class="powersabilities">
        <h3>Natural Abilities / Powers</h3>
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Enter some natural abilities/powers that are neither magic nor
            psionic in nature. Click the <b>&#9432;</b> icon to expand each row.
          </p>
          <p>
            Range, Duration, Frequency, Damage, D.C., and Skill are all
            calculated from the per-level values you enter in the details. For
            Starting Damage and Damage per Level enter values that roll20 would
            use for dice rolls. Ex. "4d6", "1d6", etc.
          </p>
          <!-- inject:partials/repeated_instructions.html -->
          <!-- endinject -->
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <div class="repeating-bonuses-outer">
          <fieldset class="repeating_powersabilities">
            <details class="info">
              <!-- inject:partials/powersabilities.html -->
              <!-- endinject -->
              <h2>Modifiers</h2>
              <!-- inject:partials/repeating_modifiers.html -->
              <!-- endinject -->
            </details>
          </fieldset>
        </div>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="magic">
        <h3>Magic</h3>
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Enter a Spell name and its PPE. Click the <b>&#9432;</b> icon to
            expand each row., and fill in the applicable values.
          </p>
          <p>
            Range, Duration, Damage, D.C., and Skill are all calculated from the
            per-level values you enter in the details. For Starting Damage and
            Damage per Level enter values that roll20 would use for dice rolls.
            Ex. "4d6", "1d6", etc.
          </p>
          <p>
            Press the Cast button to remove the PPE from the
            <b>Current PPE</b> input field. Click <b>Reset PPE</b> to set
            <b>Current PPE</b> back to the value on the Core tab. Note the roll
            buttons beside Damage and Skill.
          </p>
          <!-- inject:partials/repeated_instructions.html -->
          <!-- endinject -->
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <label
          ><span>Current P.P.E.</span>
          <input type="number" name="attr_currentppe" value="0" />
          <button type="action" name="act_resetppe">Reset P.P.E.</button>
        </label>
        <label>
          <span>Spell Strength</span>
          <input type="number" name="attr_spellstrength" value="0" />
        </label>
        <fieldset class="repeating_magic">
          <details class="info">
            <!-- inject:partials/magic.html -->
            <!-- endinject -->
            <h2>Modifiers</h2>
            <!-- inject:partials/repeating_modifiers.html -->
            <!-- endinject -->
          </details>
        </fieldset>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="psionics">
        <h3>Psionics</h3>
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Enter a Psionic name and its ISP. Click the <b>&#9432;</b> icon to
            expand each row, and fill in the applicable values.
          </p>
          <p>
            Range, Duration, Damage, D.C., and Skill are all calculated from the
            per-level values you enter in the details. For Starting Damage and
            Damage per Level enter values that roll20 would use for dice rolls.
            Ex. "4d6", "1d6", etc.
          </p>
          <p>
            Press the Use button to remove the ISP from the
            <b>Current ISP</b> input field. Click <b>Reset ISP</b> to set
            <b>Current ISP</b> back to the value on the Core tab. Note the roll
            button beside Damage and Skill.
          </p>
          <!-- inject:partials/repeated_instructions.html -->
          <!-- endinject -->
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <label
          ><span>Current I.S.P.</span>
          <input type="number" name="attr_currentisp" value="0" />
          <button type="action" name="act_resetisp">Reset I.S.P.</button>
        </label>
        <label>
          <span>Psionic Ability</span>
          <select name="attr_psionic_ability" value="15">
            <option value="15">None</option>
            <option value="12">Minor</option>
            <option value="12">Major</option>
            <option value="10">Master</option>
          </select>
        </label>
        <fieldset class="repeating_psionics">
          <details class="info">
            <!-- inject:partials/psionics.html -->
            <!-- endinject -->
            <h2>Modifiers</h2>
            <!-- inject:partials/repeating_modifiers.html -->
            <!-- endinject -->
          </details>
        </fieldset>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="modifiers">
        <div class="bonuses-container">
          <h3>Modifiers, Weapons, Armor, Gear</h3>
          <details>
            <summary><b>Instructions</b></summary>
            <p>
              Complete the repeating sections for your various combat skills and
              modifiers. Modifier dropdowns are free-form, so you can type
              anything in them and don't need to select from the list. What's
              there is just a small sample.
            </p>
            <!-- inject:partials/repeated_instructions.html -->
            <!-- endinject -->
          </details>
          <p>Click <b>Instructions</b> for detailed instructions.</p>
          <div class="repeating-bonuses-outer">
            <fieldset class="repeating_modifiers">
              <details class="info">
                <summary>
                  <div class="bonus-thing-heading">
                    <b class="click-expand"
                      ><span title="Click for more info">&nbsp;&#9432;</span></b
                    >
                    <label
                      ><span>Name</span>
                      <input
                        type="text"
                        list="combat-modifiers"
                        name="attr_name"
                      />
                    </label>
                    <label
                      ><span>Level</span>
                      <input type="number" value="1" name="attr_level" />
                    </label>
                  </div>
                </summary>
                <!-- inject:partials/repeating_modifiers.html -->
                <!-- endinject -->
              </details>
            </fieldset>
          </div>
        </div>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="bonuses">
        <div class="bonuses-container">
          <h3>Cumulative Modifiers</h3>
          <div class="combat-combined">
            <details>
              <summary><b>Instructions</b></summary>
              <p></p>
              <p>
                Any modifiers you add on the Modifiers tab will appear as
                checkboxes here. Additionally any Abilities, Magic, or Psionics
                that you checked <b>Add to Cumulative Modifiers</b> will appear
                here. Any Weapon Proficiencies you add on the WPs tab will
                appear on this page as well.
              </p>
              <p>
                Create a new Profile in the Profiles section. Check all of the
                items that make up that particular profile, click the
                <b>&#9432;</b> icon to expand the details, and click the
                <b>Apply Checked Modifiers to this Profile</b> button. This will
                aggregate all of the bonuses and values from all of the checked
                modifiers and store them in that profile. In simple cases, this
                may be all you need - stack all of your gear into one Profile,
                and that's that. But you might have a profile where you have
                some TW Armor that grants abilities, so that's a different
                profile than your default. Or you might have a series of spells
                you cast to buff up, which you might want to add to another
                profile. Or you might be a Glitter Boy pilot that has a totally
                different set of gear and bonuses inside and outside his armor.
              </p>
              <p>
                Profiles also allow you to set up different macros with
                different configurations, as you can reference the individual
                profiles. Note that each Profile includes a read-only field with
                the Row ID for use in macros.
              </p>
              <p>
                PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
                Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and
                Dodge: Motion. Damage adds everything together as a rollable
                field, and prompts to add Punch damage. Crit/Knockout/Death Blow
                use the lowest of the available options (ex. Crit: 17 is better
                than Crit: 19).
              </p>
              <p>
                The first Profile in the list is considered the
                <b>Default</b> profile and is used to perform global
                calculations like speed over time and skill bonuses. Click the
                <b>Modify</b> button and drag to reorder as needed.
              </p>
              <p>
                Note that profiles aren't cumulative, but you can make multiple
                profiles that are very similar with only one or two differences.
              </p>
            </details>
            <p>Click <b>Instructions</b> for detailed instructions.</p>
            <fieldset class="repeating_bonusselections">
              <label>
                <input type="checkbox" name="attr_enabled" value="1" />
                <span name="attr_name"></span
              ></label>
              <input type="hidden" name="attr_name" value="" />
              <input type="hidden" name="attr_bonus_id" value="" />
            </fieldset>
            <div class="selected-ids">
              <b>Selected IDs</b>
              <input
                class="full"
                type="text"
                name="attr_bonus_ids_output"
                value=""
              />
            </div>
            <hr />
            <div class="profiles repeating-bonuses-outer">
              <h3>Profiles</h3>
              <input type="hidden" name="attr_default_mdc" />
              <fieldset class="repeating_profiles">
                <details class="info">
                  <summary>
                    <div class="bonus-thing-heading">
                      <b class="click-expand"
                        ><span title="Click for more info"
                          >&nbsp;&#9432;</span
                        ></b
                      >
                      <label
                        ><span>Name</span>
                        <input
                          type="text"
                          list="combat-modifiers"
                          name="attr_name"
                        />
                      </label>
                      <label
                        ><span>Level</span>
                        <input type="number" value="1" name="attr_level" />
                      </label>
                    </div>
                  </summary>
                  <div class="profile-management">
                    <input type="text" class="full" name="attr_bonus_ids" />
                    <input type="hidden" name="attr_bonus_names" />
                    <div class="bonus-names">
                      <span name="attr_bonus_names"></span>
                    </div>
                    <button type="action" name="act_copybonusids" class="small">
                      Apply Checked Modifiers to this Profile
                    </button>
                    <!-- <button type="action" name="act_checkbonusids">
                  Apply this Profile to Selected IDs
                </button> -->
                    <button
                      type="action"
                      name="act_updateprofile"
                      class="small"
                    >
                      Update Profile if Attributes or Modifiers have changed
                    </button>
                  </div>
                  <!-- inject:partials/repeating_modifiers_readonly.html -->
                  <!-- endinject -->
                </details>
              </fieldset>
            </div>
            <hr />
          </div>
          <div class="bonus-sources repeating-bonuses-outer">
            <h3>Bonus Sources</h3>
            <fieldset class="repeating_bonuses">
              <input type="hidden" name="attr_selection_id" value="" />
              <details class="info">
                <summary>
                  <div class="bonus-thing-heading">
                    <b class="click-expand"
                      ><span title="Click for more info">&nbsp;&#9432;</span></b
                    >
                    <label
                      ><span>Name</span>
                      <input
                        type="text"
                        list="combat-modifiers"
                        name="attr_name"
                      />
                    </label>
                    <label
                      ><span>Level</span>
                      <input type="number" value="1" name="attr_level" />
                    </label>
                  </div>
                </summary>
                <!-- inject:partials/repeating_modifiers_readonly.html -->
                <!-- endinject -->
              </details>
            </fieldset>
          </div>
        </div>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="equipment">
        <h3>Equipment</h3>
        <p>
          Free form equipment list for now. Weapons and armor should go in the
          Modifiers tab.
        </p>
        <textarea class="full tall" name="attr_equipment"></textarea>
      </div>
    </div>

    <div class="r-tab-content">
      <div class="importexport">
        <h3>Import/Export</h3>
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Click the <b>Export</b> button to get a JSON object representing
            your character. Paste a valid JSON object and click <b>Import</b> to
            import a character.
          </p>
          <p>
            In order to know what the valid fields are, complete all the fields
            with at least one of each repeating section and do an Export.
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <button type="action" name="act_import">Import</button>
        <button type="action" name="act_export">Export</button>
        <label>Status: <span name="attr_importexportstatus"></span></label>
        <input type="hidden" name="attr_importexportstatus" />
        <textarea class="full tall" name="attr_importexport"></textarea>
      </div>
    </div>
  </div>
  <!-- .r-tabbed -->
</main>
<script type="text/javascript">
  // Change from javascript to worker before upload

  /* inject:js/async.js */
  /* endinject */

  /* inject:js/definitions.js */
  /* endinject */

  /* inject:js/utils.js */
  /* endinject */

  /* inject:js/bonuses.js */
  /* endinject */

  /* inject:js/wps.js */
  /* endinject */

  /* inject:js/modifiers.js */
  /* endinject */

  /* inject:js/profiles.js */
  /* endinject */

  /* inject:js/attributes.js */
  /* endinject */

  /* inject:js/skills.js */
  /* endinject */

  /* inject:js/magic_psionics_abilities.js */
  /* endinject */

  /* inject:js/movement.js */
  /* endinject */

  /* inject:js/import_export.js */
  /* endinject */

  /**
   * [] Add Psionics type to Psionics tab (minor, major, master), and use that to calculate save roll
   * [] Add weight to abilities/magic/psionics
   * [] Add a non-repeating section for Default Profile so that profile attributes can be set on the token
   * [] Pressing space when typing an ability name expands and collapses the Details panel
   * [] Removing Bonus Sources doesn't remove them from Selections
   * [x] Add trust/charm to Profile (consider an item that gives MA/PB bonus)
   * [x] Make sure that "Add to Bonuses" checkbox is exported/imported
   * [x] Add Spell Strength to magic tab
   * [x] Change Profile fields to hidden + span for efficiency's sake
   * [x] Profile values (bonuses, saves) that aggregate with a global attribute/attribute bonus should use the profile-specific value instead
   * [x] Fix coma/death aggregation in profiles (and add a roll button?)
   * [x] Fix +Punch/PS roll to use value in current section rather than global
   * [x] Magic/... DC should populate S/MDC based on DC unit.
   * [x] Why are Abilities showing up on the Bonuses tab without Add to Bonuses being checked?
   * [x] PPE on Profiles needs to include primary. Reset PPE on Magic tabs needs to pull from default (1st) profile
   * [x] Removing Abilities doesn't seem to remove them from Bonus Sources
   *
   * [x] Add/update Instructions on every tab, then re-release.
   *
   * Add attributes, PS type, ISP, PPE, HP, SDC, MDC, etc. to Bonuses
   * [x] Allow for an "absolute" value
   * [x] Add additional field(s) to Profile for aggregate attribute bonuses
   * [] Use a "text" input and allow for values like `*2` or `/2`
   * Aggregate Logic:
   * - PS includes type
   * - HP, SDC, AR, MDC are grouped on their own Armor row w/ Name
   * - PPE, ISP are grouped on their own "Mana"? row w/ Name
   *
   * [x] Have abilities/magic/psionics auto-calculate/populate MDC/SDC/HP/...
   * [x] Make things async
   *
   * @todo Armor tab / repeater; Armor checkboxes in Aggregate Bonuses, and Armor list (name, MDC) underneath
   *    Aggregate Bonuses checkboxes that show and hide based on the check
   *    - Magic and Psionics also provide armor. so you have to add the spell and then have a button to add it to the Armor tab
   *      Hitting "cast" should use up the PPE and check the checkbox. This should also apply to spell which have a duration and provide bonuses.
   *      Buttons: Cast | Cast and add to modifiers | Cast and add to armor
   * @todo add Ammo/Uses to Combat, Magic
   * @todo add import status - add an attribute and update count on each callback, or just once at the end indicating completion
   *
   * @todo Import isn't setting Skill level properly, probably because it's already "1"
   * @todo when Aggregate Attacks change, recalculate ft/attack fields
   *
   * Questions
   * - Paratrooper gets a save vs. Torture. What is this?
   *
   * @todo standardize/improve markup on Core tab
   *
   * @todo add an active combat section above Aggregate bonuses
   *    - track attacks
   *    - track ammo (roll20 has something for this)
   *    - track MDC - for each aggregate MDC modifier, track it separately in a repeater. allow the user to reorder, and deduct from bottom to top
   *
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   *
   * @todo better better build process with imports/file modules
   *
   * To get Character ID, `getAttrs(["character_id"])`
   * */

  /**
   * This one could be a doozy
   * */
  on("change:character_level", async (e) => {
    console.log("change:character_level", e.newValue, e.previousValue);
    // Update WPs
    await updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    await updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    await updateSkillLevels(+e.newValue, +e.previousValue);
    await updateMagicPsionicsLevels();
  });
</script>
