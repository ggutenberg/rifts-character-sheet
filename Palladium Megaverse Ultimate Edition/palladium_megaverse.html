<link rel="stylesheet" href="palladium_megaverse.css" />
<main class="charsheet">
  Palladium MegaverseÂ© Character Sheet <br />
  <details>
    <summary>Character Statistics</summary>
    <div class="character-stats">
      <div>
        <label for="character_name">Character Name</label>
        <input
          type="text"
          value=""
          name="attr_character_name"
          id="character_name"
        />
      </div>
      <div>
        <label for="character_truename">True Name</label>
        <input
          type="text"
          value=""
          name="attr_character_truename"
          id="character_truename"
        />
      </div>
    </div>
  </details>

  <label for="level">Level</label
  ><input type="number" value="" id="level" name="attr_level" />
  <br />

  Weapon Proficiency / Strike / Burst / Parry / Disarm / RoF / Thrown / Entangle
  <fieldset class="repeating_wp">
    <input type="text" list="weaponProficiencies" name="attr_name" />
    <datalist id="weaponProficiencies">
      <option value="Archery"></option>
      <option value="Axe"></option>
      <option value="Blunt"></option>
      <option value="Chain"></option>
      <option value="Forked"></option>
      <option value="Knife"></option>
      <option value="Grappling Hook"></option>
      <option value="Pole Arm"></option>
      <option value="Rope"></option>
      <option value="Shield"></option>
      <option value="Spear"></option>
      <option value="Staff"></option>
      <option value="Sword"></option>
      <option value="Targeting"></option>
      <option value="Whip"></option>
      <option value="Handguns"></option>
      <option value="Rifles"></option>
      <option value="Energy Heavy"></option>
      <option value="Energy Pistol"></option>
      <option value="Energy Rifle"></option>
      <option value="Heavy"></option>
      <option value="Speargun"></option>
      <option value="Shotgun"></option>
      <option value="Submachinegun"></option>
      <option value="Flamethrower"></option>
    </datalist>
    <input type="number" value="" name="attr_strike" />
    <input type="number" value="" name="attr_burst" />
    <input type="number" value="" name="attr_parry" />
    <input type="number" value="" name="attr_disarm" />
    <input type="number" value="" name="attr_rof" />
    <input type="number" value="" name="attr_thrown" />
    <input type="number" value="" name="attr_entangle" />
  </fieldset>
</main>
<script type="text/worker">
  // Change from javascript to worker before upload

  const WP_ACTIONS = ["strike", "parry", "disarm", "rof", "thrown", "entangle"];
  const WP = {
    archery: [
      { strike: 1, parry: 1, disarm: 1, rof: 2 },
      { strike: 1, disarm: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      { disarm: 1, rof: 1 },
      { strike: 1 },
      {},
      { strike: 1, rof: 1 },
      {},
      { strike: 1, disarm: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      { disarm: 1 },
    ],
    axe: [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
    ],
    blunt: [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1 },
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      { strike: 1, parry: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      { thrown: 1 },
      {},
      { strike: 1, parry: 1 },
      {},
      {},
      { thrown: 1 },
    ],
    chain: [
      { strike: 1, parry: 1 },
      { parry: 1 },
      { strike: 1 },
      { parry: 1 },
      {},
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
      {},
      { parry: 1 },
      { strike: 1 },
      {},
      {},
    ],
    forked: [
      { strike: 1, parry: 1, thrown: 1, entangle: 1 },
      {},
      { strike: 1, parry: 1, entangle: 1 },
      { thrown: 1 },
      { strike: 1, thrown: 1, entangle: 1 },
      { parry: 1 },
      {},
      { strike: 1, entangle: 1 },
      {},
      { parry: 1, thrown: 1 },
      { strike: 1, entangle: 1 },
      {},
      { strike: 1, parry: 1, entangle: 1 },
      {},
      { thrown: 1 },
    ],
    knife: [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1 },
      {},
      { parry: 1, thrown: 1 },
      { strike: 1 },
      { thrown: 1 },
      { parry: 1 },
      { strike: 1, thrown: 1 },
      {},
      { parry: 1 },
      { strike: 1, thrown: 1 },
      {},
      {},
    ],
    "grappling hook": [
      { strike: 1, entangle: 1 },
      { strike: 1, entangle: 1 },
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      {},
    ],
    "pole arm": [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      { strike: 1, parry: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      {},
    ],
    rope: [
      { strike: 1, entangle: 1, disarm: 1 },
      { strike: 1 },
      {},
      { strike: 1 },
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
    ],
    shield: [
      { strike: 1, parry: 1 },
      { strike: 1 },
      { parry: 1 },
      { strike: 1 },
      {},
      {},
      { parry: 1 },
      { strike: 1 },
      {},
      { parry: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      {},
    ],
    spear: [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      { thrown: 1 },
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      { thrown: 1 },
      {},
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      {},
    ],
    staff: [
      { strike: 1, parry: 1, thrown: 1 },
      { parry: 1 },
      { strike: 1 },
      { parry: 1 },
      { parry: 1, thrown: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1, thrown: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      { thrown: 1 },
    ],
    sword: [
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1, thrown: 1 },
      { strike: 1, parry: 1 },
      { parry: 1, thrown: 1 },
      { strike: 1 },
      { strike: 1 },
      { parry: 1 },
      { thrown: 1 },
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1, thrown: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
    ],
    targeting: [
      { strike: 1 },
      { damage: 1 },
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      { damage: 1 },
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      {},
    ],
    whip: [
      { strike: 1, entangle: 1, disarm: 1, damage: 1 },
      { strike: 1, entangle: 1, disarm: 1, damage: 1 },
      { strike: 1, entangle: 1, disarm: 1 },
      { strike: 1, entangle: 1, disarm: 1, damage: 1 },
      {},
      {},
      { strike: 1, entangle: 1, disarm: 1 },
      { damage: 1 },
      {},
      { strike: 1, entangle: 1, disarm: 1 },
      {},
      { damage: 1 },
      { strike: 1, entangle: 1, disarm: 1 },
      {},
      {},
    ],
    handguns: [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
    ],
    rifles: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
    ],
    "energy heavy": [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
    ],
    "energy pistol": [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
    ],
    "energy rifle": [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
    ],
    heavy: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
    ],
    speargun: [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
    ],
    shotgun: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
    ],
    submachinegun: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
    ],
    flamethrower: [
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
    ],
  };
  const getBiAttributeBonus = (attr) => {
    const bonus = attr > 15 ? Math.ceil((Math.min(attr, 30) - 15) / 2) : 0;
    return bonus;
  };

  const mergeAndAddObjects = (data) => {
    const result = {};
    data.forEach((obj) => {
      for (let [key, value] of Object.entries(obj)) {
        if (result[key]) {
          result[key] += value;
        } else {
          result[key] = value;
        }
      }
    });
    return result;
  };

  const setWp = (name, level, rowId = "") => {
    let attrs = {};
    const levelBonuses = WP[name].slice(0, level);
    const totalBonuses = mergeAndAddObjects(levelBonuses);
    WP_ACTIONS.forEach((action) => {
      const keyPrefix = rowId
        ? `repeating_wp_${rowId}`
        : `repeating_wp`;
      const key = `${keyPrefix}_${action}`
      attrs[key] = action in totalBonuses ? totalBonuses[action] : 0;
      if (action == 'strike') {
        attrs[`${keyPrefix}_burst`] = Math.floor(attrs[key] / 2);
      }
    });
    setAttrs(attrs);
  };

  /**
   * This one is a doozy
   * */
  on("change:level", (e) => {
    console.log("change:level", e.newValue);
    // Update WPs
    getSectionIDs("wp", (ids) => {
      const attrNames = ids.map((id) => `repeating_wp_${id}_name`);
      getAttrs(attrNames, (a) => {
        const attrs = {};
        ids.forEach((id) => {
          setWp(a[`repeating_wp_${id}_name`].toLowerCase(), e.newValue, id);
        });
      });
    });
  });

  on("change:repeating_wp:name", (e) => {
    const wpName = e.newValue.toLowerCase();
    getAttrs(["level"], (a) => {
      setWp(wpName, a.level);
    });
  });

  on("change:iq", (e) => {
    const iq_bonus = e.newValue > 15 ? e.newValue - 14 : 0;
    const perception_bonus = getBiAttributeBonus(e.newValue);
    setAttrs({ iq_bonus, perception_bonus });
  });

  on("change:me change:pp change:pe", (e) => {
    const bonus = getBiAttributeBonus(e.newValue);
    const attrs = {};
    attrs[`${e.sourceAttribute}_bonus`] = bonus;
    if (e.sourceAttribute == "pe") {
      attrs["pe_coma_bonus"] =
        e.newValue >= 16
          ? e.newValue <= 18
            ? 4 + (e.newValue - 16)
            : e.newValue <= 30
            ? 8 + (e.newValue - 19) * 2
            : 30 + (e.newValue - 30)
          : 0;
    }
    setAttrs(attrs);
  });

  on("change:ma", (e) => {
    const ma_bonus =
      e.newValue >= 16
        ? e.newValue <= 24
          ? 40 + (e.newValue - 16) * 5
          : e.newValue <= 27
          ? 80 + (e.newValue - 24) * 4
          : e.newValue <= 29
          ? 92 + (e.newValue - 27) * 2
          : 97
        : 0;
    setAttrs({ ma_bonus });
  });

  on("change:ps", (e) => {
    const ps_bonus = e.newValue > 15 ? e.newValue - 15 : 0;
    const ps_supernatural_bonus =
      e.newValue >= 16
        ? e.newValue <= 20
          ? "1D6"
          : e.newValue <= 25
          ? "2D6"
          : e.newValue <= 30
          ? "3D6"
          : e.newValue <= 35
          ? "4D6"
          : e.newValue <= 40
          ? "5D6"
          : e.newValue <= 50
          ? "6D6"
          : e.newValue <= 60
          ? "1D6*10"
          : e.newValue <= 70
          ? "1D6*10+10"
          : "2D4*10"
        : "4D6 SDC";
    setAttrs({ ps_bonus, ps_supernatural_bonus });
  });

  on("change:pb", (e) => {
    const pb_bonus =
      e.newValue >= 16
        ? e.newValue <= 26
          ? 30 + (e.newValue - 16) * 5
          : e.newValue <= 28
          ? 80 + (e.newValue - 26) * 3
          : e.newValue == 29
          ? 90
          : 92
        : 0;
    setAttrs({ pb_bonus });
  });

  on("change:spd", (e) => {
    getAttrs(["combatskill_numberattacks"], (a) => {
      const feetPerMelee = e.newValue * 15;
      const attrs = {
        run_mph: ((feetPerMelee * 4 * 60) / 5280).toFixed(1),
        run_ft_melee: feetPerMelee,
        run_ft_attack: Math.round(feetPerMelee / a.combatskill_numberattacks),
      };
      setAttrs(attrs);
    });
  });

  on("change:repeating_movement:movement_mph", (e) => {
    getAttrs(["combatskill_numberattacks"], (a) => {
      const feetPerMelee = Math.round((e.newValue * 5280) / 60 / 4);
      const attrs = {
        repeating_movement_movement_ft_melee: feetPerMelee,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combatskill_numberattacks
        ),
      };
      setAttrs(attrs);
    });
  });

  on("change:repeating_movement:movement_ft_melee", (e) => {
    getAttrs(["combatskill_numberattacks"], (a) => {
      const feetPerMelee = e.newValue;
      //const mph = Math.round((feetPerMelee * 4 * 60) / 5280);
      const mph = ((feetPerMelee * 4 * 60) / 5280).toFixed(1);
      const attrs = {
        repeating_movement_movement_mph: mph,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combatskill_numberattacks
        ),
      };
      setAttrs(attrs);
    });
  });

  on("change:combatskill_numberattacks", (e) => {
    getSectionIDs("movement", (ids) => {
      const attrNames = ids.map(
        (id) => `repeating_movement_${id}_movement_ft_melee`
      );
      getAttrs(attrNames, (a) => {
        const attrs = {};
        ids.forEach((id) => {
          const row = `repeating_movement_${id}`;
          const feetPerMelee = a[`${row}_movement_ft_melee`] || 0;
          if (feetPerMelee) {
            attrs[`${row}_movement_ft_attack`] = Math.round(
              feetPerMelee / e.newValue
            );
          }
        });
        setAttrs(attrs);
      });
    });
  });
</script>
