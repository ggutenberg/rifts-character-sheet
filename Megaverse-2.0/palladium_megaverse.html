<main id="megaverse">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">Combat</button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />

  <div class="core">
    Palladium Rifts Character Sheet <br />
    <h1>Character Statistics</h1>
    <div class="grid-container">
      <div class="section-one character-background">
        <label
          ><span>Character Name</span>
          <input
            id="character-name"
            type="text"
            value=""
            name="attr_character_name"
        /></label>
        <label
          ><span>True Name</span>
          <input type="text" value="" name="attr_truename_name"
        /></label>
        <label
          ><span>Race</span>
          <input type="text" value="" name="attr_character_race"
        /></label>
        <label
          ><span>O.C.C.</span> <input type="text" value="" name="attr_occ"
        /></label>
        <label
          ><span>Strength Type</span>
          <select class="" name="attr_ps_type" value="normal">
            <option value="normal">Normal</option>
            <option value="augmented">Augmented</option>
            <option value="robotic">Robotic</option>
            <option value="supernatural">Supernatural</option>
          </select></label
        >
        <label
          ><span>Level</span> <input type="number" name="attr_level"
        /></label>
        <label
          ><span>Experience</span> <input type="number" name="attr_experience"
        /></label>
        <label
          ><span>Alignment</span>
          <select class="select" name="attr_alignment_select" value="0">
            <option value="0"></option>
            <option value="Principled">Principled</option>
            <option value="Scrupulous">Scrupulous</option>
            <option value="Unprincipled">Unprincipled</option>
            <option value="Anarchist">Anarchist</option>
            <option value="Taoist">Taoist</option>
            <option value="Miscreant">Miscreant</option>
            <option value="Abberant">Aberrant</option>
            <option value="Diabolic">Diabolic</option>
          </select></label
        >
        <label
          ><span>Age</span>
          <input
            class="attribute"
            type="number"
            value=""
            name="attr_character_age"
        /></label>
        <label
          ><span>Gender</span>
          <input type="text" value="" name="attr_character_gender"
        /></label>
        <label
          ><span>Height</span>
          <input type="text" value="" name="attr_character_height"
        /></label>
        <label
          ><span>Weight</span>
          <input type="text" value="" name="attr_character_weight"
        /></label>
        <label
          ><span>Family Origin</span>
          <input type="text" value="" name="attr_character_familyorigin"
        /></label>
        <label
          ><span>Environment</span>
          <input value="" name="attr_character_environment"
        /></label>
        <label
          ><span>Native Language(s)</span>
          <input type="text" value="" name="attr_character_languages"
        /></label>
        <label
          ><span>Insanity, if any</span>
          <input type="text" value="" name="attr_character_insanity"
        /></label>
        <label
          ><span>Disposition</span>
          <input type="text" value="" name="attr_character_disposition"
        /></label>
      </div>

      <div class="section-two">
        <div class="ss-2a">
          <label for="iq">I.Q.</label>
          <input
            id="iq"
            type="number"
            value=""
            name="attr_iq"
            title="Intelligence Quotient"
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_iq_bonus"
            title="+ Skills %"
            readonly
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_perception_bonus"
            title="+ Perception (Rifter #13, p.16)"
            readonly
          />

          <label for="mental-endurance">M.E.</label>
          <input
            id="mental-endurance"
            type="number"
            value=""
            name="attr_me"
            title="Mental Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_me_bonus"
            title="+ Save vs. Psionics"
            readonly
          />
          <div></div>

          <label for="mental-affinity">M.A.</label>
          <input
            id="mental-affinity"
            type="number"
            value=""
            name="attr_ma"
            title="Mental Affinity"
          />
          <input
            type="number"
            value="0"
            name="attr_ma_bonus"
            title="% Trust/Intimidate"
            readonly
          />
          <div></div>

          <label for="physical-strength">P.S.</label>
          <input
            id="physical-strength"
            type="number"
            value=""
            name="attr_ps"
            title="Physical Strength"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_ps_bonus"
            title="+ SDC Damage"
            readonly
          />
          <div></div>

          <label for="physical-prowess">P.P</label>
          <input
            id="physical-prowess"
            type="number"
            value=""
            name="attr_pp"
            title="Physical Prowess"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pp_bonus"
            title="+ Strike/Parry/Dodge/Entangle/Disarm"
            readonly
          />
          <div></div>

          <label for="physical-endurance">P.E.</label>
          <input
            id="physical-endurance"
            type="number"
            value=""
            name="attr_pe"
            title="Physical Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_bonus"
            title="+ Magic/Poison/Toxins"
            readonly
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_coma_bonus"
            title="+ Coma/Death %"
            readonly
          />

          <label for="physical-beauty">P.B.</label>
          <input
            id="physical-beauty"
            type="number"
            value=""
            name="attr_pb"
            title="Physical Beauty"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pb_bonus"
            title="% Charm/Impress"
            readonly
          />
          <div></div>

          <label for="speed">Spd</label>
          <input
            id="speed"
            type="number"
            value=""
            name="attr_spd"
            title="Speed"
          />
        </div>
        <div class="ss-2b">
          <label for="trust-intimidate">Trust/Intimidate</label>
          <input
            id="trust-intimidate"
            type="number"
            value=""
            name="attr_trust_intimidate"
          /><span>%</span>

          <label for="charm-impress">Charm/Impress</label>
          <input
            id="charm-imporess"
            type="number"
            value=""
            name="attr_charm_impress"
          /><span>%</span>
        </div>
        <div class="ss-2c">
          <label for="restrained-punch">Restrained Punch</label>
          <input
            id="restrained-punch"
            type="text"
            name="attr_restrained_punch"
          />
          <select name="attr_restrained_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="punch">Punch</label>
          <input id="punch" type="text" name="attr_punch" />
          <select name="attr_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="power-punch">Power Punch</label>
          <input id="power-punch" type="text" name="attr_power_punch" />
          <select name="attr_power_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="kick">Kick</label>
          <input id="kick" type="text" name="attr_kick" />
          <select name="attr_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="leap-kick">Leap Kick</label>
          <input id="leap-kick" type="text" name="attr_leap_kick" />
          <select name="attr_leap_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="lift">Lift</label>
          <input id="lift" type="number" value="" name="attr_lift" />
          <div></div>

          <label for="carry">Carry</label>
          <input id="carry" type="number" value="" name="attr_carry" />
          <div></div>

          <label for="throw">Throw</label>
          <input id="throw" type="number" value="" name="attr_throw" />
          <div></div>

          <label for="carry-max">Carry Max</label>
          <input
            id="carry-max"
            type="number"
            value=""
            name="attr_carry_max"
          />Minutes

          <label for="carry-running">Carry (Running)</label>
          <input
            id="carry-running"
            type="number"
            value=""
            name="attr_carry_running"
          />Minutes

          <label for="hold-max">Hold Max.</label>
          <input
            id="hold-max"
            type="number"
            value=""
            name="attr_hold_max"
          />Melees
        </div>
      </div>
      <div class="section-three">
        <label for="hit-points">Hit Points</label>
        <input
          id="hit-points"
          type="number"
          value=""
          name="attr_character_hp"
        />
        <select
          class="select"
          name="attr_charactertype_select"
          value="0"
          style="width: 80px"
        >
          <option value="0"></option>
          <option value="sdc">S.D.C.</option>
          <option value="mdc">M.D.C.</option>
        </select>
        <input
          class="attribute"
          type="number"
          value=""
          name="attr_character_dc"
        />

        <label for="ppe">P.P.E.</label>
        <input id="ppe" type="number" value="" name="attr_character_ppe" />

        <label for="ar">A.R.</label>
        <input id="ar" type="number" value="" name="attr_character_ar" />

        <label for="isp">I.S.P.</label>
        <input id="isp" type="number" value="" name="attr_character_isp" />

        <label for="hf">H.F.</label>
        <input id="hf" type="number" value="" name="attr_character_hf" />

        <label for="initiative">Initiative</label>
        <div>
          <input
            id="initative"
            type="number"
            value="@{initiative}"
            disabled="true"
          />
          <button
            type="roll"
            value="Initiative: [[d20+@{initiative}+0.1*@{initiative}&{tracker}]]"
          >
            Roll
          </button>
        </div>

        <label for="perception">Perception</label>
        <div>
          <input id="perception" type="number" value"0" name="attr_perception"
          />
          <button type="roll" value="Perception: [[d20+@{perception}]]">
            Roll
          </button>
        </div>
      </div>
    </div>

    <h2>Movement</h2>
    <div class="movement-container">
      <div></div>
      <label for="mph">MPH</label>
      <label for="ft-melee">Ft/Melee</label>
      <label for="ft-attack">Ft/Attack</label>
      <label for="cruising">Cruising</label>
      <label for="run-at-max">Run at Max</label>
      <label>Run</label>
      <input id="mph" type="number" value="" readonly name="attr_run_mph" />
      <input
        id="ft-melee"
        type="number"
        value=""
        readonly
        name="attr_run_ft_melee"
      />
      <input
        id="ft-attack"
        type="number"
        value=""
        readonly
        name="attr_run_ft_attack"
      />
      <input id="cruising" type="number" value="" name="attr_run_cruising" />
      <div>
        <input
          id="run-at-max"
          type="number"
          value="@{pe}/2"
          disabled="true"
          name="attr_run_at_max"
        />
        minutes
      </div>

      <label for="leaing-distance">Leaping Distance</label>
      <input type="number" name="attr_leapup" value="" />
      <div>feet up?</div>
      <input type="number" name="attr_leapout" value="" />
      <div>feet out?</div>
      <div></div>

      <label>Additional Movement Type</label>
      <label>MPH</label>
      <label>Ft/Melee</label>
      <label>Ft/Attack</label>
      <label>Cruising</label>
      <label>Run at Max</label>

      <input type="text" value="" name="attr_movement_name" />
      <input type="number" value="" name="attr_movement_mph" />
      <input type="number" value="" name="attr_movement_ft_melee" />
      <input type="number" value="" name="attr_movement_ft_attack" readonly />
      <input type="number" value="" name="attr_movement_cruising" />
      <div>
        <input type="number" value="" name="attr_movement_at_max" /> minutes
      </div>
    </div>
  </div>
  <br />

  <div class="wp">
    <div class="wp-container">
      <fieldset class="repeating_wp">
        <h5>Weapon Proficiency</h5>
        <h5>Strike</h5>
        <h5>Burst</h5>
        <h5>Parry</h5>
        <h5>Disarm</h5>
        <h5>RoF</h5>
        <h5>Thrown</h5>
        <h5>Entangle</h5>
        <h5>WP Level</h5>
        <input type="text" list="weaponProficiencies" name="attr_wpname" />
        <datalist id="weaponProficiencies">
          <option value="Archery"></option>
          <option value="Axe"></option>
          <option value="Blunt"></option>
          <option value="Chain"></option>
          <option value="Forked"></option>
          <option value="Knife"></option>
          <option value="Grappling Hook"></option>
          <option value="Pole Arm"></option>
          <option value="Rope"></option>
          <option value="Shield"></option>
          <option value="Spear"></option>
          <option value="Staff"></option>
          <option value="Sword"></option>
          <option value="Targeting"></option>
          <option value="Whip"></option>
          <option value="Handguns"></option>
          <option value="Rifles"></option>
          <option value="Energy Heavy"></option>
          <option value="Energy Pistol"></option>
          <option value="Energy Rifle"></option>
          <option value="Heavy"></option>
          <option value="Speargun"></option>
          <option value="Shotgun"></option>
          <option value="Submachinegun"></option>
          <option value="Flamethrower"></option>
        </datalist>
        <input type="number" value="" name="attr_strike" />
        <input type="number" value="" name="attr_burst" />
        <input type="number" value="" name="attr_parry" />
        <input type="number" value="" name="attr_disarm" />
        <input type="number" value="" name="attr_rof" />
        <input type="number" value="" name="attr_thrown" />
        <input type="number" value="" name="attr_entangle" />
        <input type="number" value="" name="attr_wplevel" />
      </fieldset>
    </div>
  </div>

  <div class="combat">
    <div class="combat-container">
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Complete the repeating sections for your various combat skills, then
            select a valid skill as your base skill, followed by a valid skill
            as your extra skill. Skill dropdowns are free-form, so you can type
            anything in them and don't need to select from the list. Just make
            sure that your Base and Extra skill selections match what you typed
            exactly.
          </p>
          <p>
            If you have additional bonuses from items, magic, training, etc.,
            you can create an arbitrarily named Additional section and apply
            that as Additional Bonuses as well.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. PS bonus isn't added to Damage because it could be
            non-Normal. Crit should be the lowest of the available options (ex.
            Crit: 17 is better than Crit: 19), but hasn't been implemented so
            needs to be set manually.
          </p>
          <p>Examples:</p>
          <ul>
            <li>
              <b>Base</b>: Commando<br /><b>Extra</b>: RPA Elite: Glitter Boy<br /><b
                >Additional</b
              >: Magic Gear
            </li>
            <li>
              <b>Base</b>: White Jade Fan<br /><b>Extra</b>: Bok Pai Kung Fu
              (Crane Style)<br /><b>Additional</b>: Super Powers
            </li>
          </ul>
        </details>
        <label
          >Base Skill
          <input type="text" list="handToHand" name="attr_combat_skill_base" />
        </label>
        <label
          >Extra Skill
          <input type="text" list="handToHand" name="attr_combat_skill_extra" />
        </label>
        <label
          >Additional
          <input
            type="text"
            list="handToHand"
            name="attr_combat_skill_additional"
          />
        </label>
        <div class="combat-combined-bonuses">
          <label
            ><span>Attacks</span>
            <input type="number" value="" name="attr_combat_combined_attacks" />
          </label>
          <label
            ><span>Initiative</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_initiative"
            />
            <button
              type="roll"
              value="Initiative: [[d20+@{combat_combined_initiative}]]"
            />
          </label>
          <label
            ><span>Strike</span>
            <input type="number" value="" name="attr_combat_combined_strike" />
            <button
              type="roll"
              value="Strike: [[d20+@{combat_combined_strike}]]"
            />
          </label>
          <label
            ><span>Parry</span>
            <input type="number" value="" name="attr_combat_combined_parry" />
            <button
              type="roll"
              value="Parry: [[d20+@{combat_combined_parry}]]"
            />
          </label>
          <label
            ><span>Dodge</span>
            <input type="number" value="" name="attr_combat_combined_dodge" />
            <button
              type="roll"
              value="Dodge: [[d20+@{combat_combined_dodge}]]"
            />
          </label>
          <label
            ><span>Throw</span>
            <input type="number" value="" name="attr_combat_combined_throw" />
            <button
              type="roll"
              value="Throw: [[d20+@{combat_combined_throw}]]"
            />
          </label>
          <label
            ><span>Disarm</span>
            <input type="number" value="" name="attr_combat_combined_disarm" />
            <button
              type="roll"
              value="Disarm: [[d20+@{combat_combined_disarm}]]"
            />
          </label>
          <label
            ><span>Entangle</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_entangle"
            />
            <button
              type="roll"
              value="Entangle: [[d20+@{combat_combined_entangle}]]"
            />
          </label>
          <label
            ><span>Pull Punch</span>
            <input type="number" value="" name="attr_combat_combined_pull" />
            <button
              type="roll"
              value="Pull Punch: [[d20+@{combat_combined_pull}]]"
            />
          </label>
          <label
            ><span>Roll w/ Impact</span>
            <input type="number" value="" name="attr_combat_combined_roll" />
            <button
              type="roll"
              value="Roll w/ Impact: [[d20+@{combat_combined_roll}]]"
            />
          </label>
          <label
            ><span>Damage</span>
            <input type="number" value="" name="attr_combat_combined_damage" />
            <div></div>
          </label>
          <label
            ><span>Dodge: Flight</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_dodge_flight"
            />
            <button
              type="roll"
              value="Dodge in Flight: [[d20+@{combat_combined_dodge_flight}]]"
            />
          </label>
          <label
            ><span>Dodge: Auto</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_dodge_auto"
            />
            <button
              type="roll"
              value="Auto Dodge: [[d20+@{combat_combined_dodge_auto}]]"
            />
          </label>
          <label
            ><span>Dodge: Teleport</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_dodge_teleport"
            />
            <button
              type="roll"
              value="Teleport Dodge: [[d20+@{combat_combined_dodge_teleport}]]"
            />
          </label>
          <label
            ><span>Dodge: Motion</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_dodge_motion"
            />
            <button
              type="roll"
              value="Dodge in Motion: [[d20+@{combat_combined_dodge_motion}]]"
            />
          </label>
          <label
            ><span>Strike: Range</span>
            <input
              type="number"
              value=""
              name="attr_combat_combined_strike_range"
            />
            <button
              type="roll"
              value="Range Strike: [[d20+@{combat_combined_strike_range}]]"
            />
          </label>
          <label
            ><span>Critical</span>
            <input type="number" value="" name="attr_combat_combined_critical"
          /></label>
        </div>
      </div>
      <hr />
      <fieldset class="repeating_combat">
        <label
          ><span>Skill</span>
          <input type="text" list="handToHand" name="attr_combat_skill" />
          <datalist id="handToHand">
            <option value="Basic"></option>
            <option value="Expert"></option>
            <option value="Martial Arts"></option>
            <option value="Assassin"></option>
            <option value="Commando"></option>
            <option value="Dragon"></option>
            <option value="RPA Basic"></option>
            <option value="RPA Elite: Flying PA"></option>
            <option value="RPA Elite: Ground PA"></option>
            <option value="RPA Elite: Heavy Vehicle"></option>
            <option value="RPA Elite: Heavy Ground"></option>
            <option value="RPA Elite: Light Ground"></option>
            <option value="RPA Elite: Glitter Boy"></option>
          </datalist>
        </label>
        <label
          ><span>Level</span>
          <input type="number" value="" name="attr_combat_skill_level" />
        </label>
        <div></div>
        <div></div>
        <label
          ><span>Attacks</span>
          <input type="number" value="" name="attr_combat_skill_attacks" />
        </label>
        <label
          ><span>Initiative</span>
          <input type="number" value="" name="attr_combat_skill_initiative" />
          <button
            type="roll"
            value="Initiative: [[d20+@{combat_skill_initiative}]]"
          />
        </label>
        <label
          ><span>Strike</span>
          <input type="number" value="" name="attr_combat_skill_strike" />
          <button type="roll" value="Strike: [[d20+@{combat_skill_strike}]]" />
        </label>
        <label
          ><span>Parry</span>
          <input type="number" value="" name="attr_combat_skill_parry" />
          <button type="roll" value="Parry: [[d20+@{combat_skill_parry}]]" />
        </label>
        <label
          ><span>Dodge</span>
          <input type="number" value="" name="attr_combat_skill_dodge" />
          <button type="roll" value="Dodge: [[d20+@{combat_skill_dodge}]]" />
        </label>
        <label
          ><span>Throw</span>
          <input type="number" value="" name="attr_combat_skill_throw" />
          <button type="roll" value="Throw: [[d20+@{combat_skill_throw}]]" />
        </label>
        <label
          ><span>Disarm</span>
          <input type="number" value="" name="attr_combat_skill_disarm" />
          <button type="roll" value="Disarm: [[d20+@{combat_skill_disarm}]]" />
        </label>
        <label
          ><span>Entangle</span>
          <input type="number" value="" name="attr_combat_skill_entangle" />
          <button
            type="roll"
            value="Entangle: [[d20+@{combat_skill_entangle}]]"
          />
        </label>
        <label
          ><span>Pull Punch</span>
          <input type="number" value="" name="attr_combat_skill_pull" />
          <button
            type="roll"
            value="Pull Punch: [[d20+@{combat_skill_pull}]]"
          />
        </label>
        <label
          ><span>Roll w/ Impact</span>
          <input type="number" value="" name="attr_combat_skill_roll" />
          <button
            type="roll"
            value="Roll w/ Impact: [[d20+@{combat_skill_roll}]]"
          />
        </label>
        <label
          ><span>Damage</span>
          <input type="number" value="" name="attr_combat_skill_damage" />
          <div></div>
        </label>
        <label
          ><span>Dodge: Flight</span>
          <input type="number" value="" name="attr_combat_skill_dodge_flight" />
          <button
            type="roll"
            value="Dodge in Flight: [[d20+@{combat_skill_dodge_flight}]]"
          />
        </label>
        <label
          >Dodge: Auto
          <input type="number" value="" name="attr_combat_skill_dodge_auto" />
          <button
            type="roll"
            value="Auto Dodge: [[d20+@{combat_skill_dodge_auto}]]"
          />
        </label>
        <label
          ><span>Dodge: Teleport</span>
          <input
            type="number"
            value=""
            name="attr_combat_skill_dodge_teleport"
          />
          <button
            type="roll"
            value="Teleport Dodge: [[d20+@{combat_skill_dodge_teleport}]]"
          />
        </label>
        <label
          ><span>Dodge: Motion</span>
          <input type="number" value="" name="attr_combat_skill_dodge_motion" />
          <button
            type="roll"
            value="Dodge in Motion: [[d20+@{combat_skill_dodge_motion}]]"
          />
        </label>
        <label
          ><span>Strike: Range</span>
          <input type="number" value="" name="attr_combat_skill_strike_range" />
          <button
            type="roll"
            value="Range Strike: [[d20+@{combat_skill_strike_range}]]"
          />
        </label>
        <label
          ><span>Critical</span>
          <input type="number" value="" name="attr_combat_skill_critical"
        /></label>
      </fieldset>
    </div>
  </div>

  <div class="equipment">Equipment Coming Soon!</div>
  <div class="skills">Skills Coming Soon!</div>
</main>
<script type="text/worker">
  // Change from javascript to worker before upload

  const repeatingSum = (destinations, section, fields, ...extras) => {
    const isNumber = (value) =>
      parseFloat(value).toString() === value.toString();
    const isOption = (value) =>
      [...checks.valid, ...checks.roundtypes].includes(value);
    const isRounding = (value) => checks.roundtypes.includes(value);
    const isFraction = (value) =>
      value.includes("/") && !(value.includes(",") || value.includes("|"));
    const getTrimmed = (value) => value.toLowerCase().replace(/\s/g, "");
    const getRounded = (type, value, pow) =>
      (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(
        Math.max(0, pow)
      );
    const getFraction = (value /*{ console.log(`value: ${value}`); */) =>
      parseInt(value.split("/")[0]) / parseInt(value.split("/")[1]);
    const getMultiplier = (value, rounding = 1) =>
      "undefined" === typeof value
        ? rounding
          ? 0
          : 1
        : isNumber(value)
        ? parseFloat(value)
        : isFraction(value)
        ? getFraction(value)
        : value;
    if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
    if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
    const fields_trimmed = fields.map(
      (field) => getTrimmed(field).split(":")[0]
    );
    const subfields = fields_trimmed.slice(0, destinations.length);
    const checks = {
      valid: ["multiplier"],
      roundtypes: ["ceil", "round", "floor"],
    };
    let properties = { attributes: {}, options: {} };
    extras.forEach((extra) => {
      const [prop, v] = getTrimmed(extra).split(":");
      const multiplier_maybe = getMultiplier(v, isRounding(prop));
      const obj = isNumber(multiplier_maybe)
        ? subfields.reduce((obj, field) => {
            obj[field] = multiplier_maybe;
            return obj;
          }, {})
        : multiplier_maybe.split(",").reduce((obj, item) => {
            const [stat, value] = item.split("|");
            const multiplier = getMultiplier(value, isRounding(prop));
            obj[stat] = multiplier;
            return obj;
          }, {});
      properties[isOption(prop) ? "options" : "attributes"][prop] = obj;
    });
    getSectionIDs(`repeating_${section}`, (idArray) => {
      const attrArray = idArray.reduce(
        (m, id) => [
          ...m,
          ...fields_trimmed.map(
            (field) => `repeating_${section}_${id}_${field}`
          ),
        ],
        []
      );
      let filteredAttrArray = attrArray;
      if (properties.attributes.filter) {
        filteredAttrArray = attrArray.filter((attr) =>
          Object.keys(properties.attributes.filter).some((sectionId) =>
            attr.includes(sectionId)
          )
        );
      }
      console.log("properties", properties);
      console.log("attrArray", attrArray);
      console.log("filteredAttrArray", filteredAttrArray);
      getAttrs(
        [...filteredAttrArray, ...Object.keys(properties.attributes)],
        (v) => {
          const getValue = (section, id, field) =>
            v[`repeating_${section}_${id}_${field}`] === "on"
              ? 1
              : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
          const commonMultipliers =
            fields.length <= destinations.length
              ? []
              : fields.splice(
                  destinations.length,
                  fields.length - destinations.length
                );
          const output = destinations.reduce((obj, destination, index) => {
            let sumTotal = idArray.reduce(
              (total, id) =>
                total +
                getValue(section, id, fields_trimmed[index]) *
                  commonMultipliers.reduce(
                    (subtotal, mult) =>
                      subtotal *
                      (!mult.includes(":") ||
                      mult
                        .split(":")[1]
                        .split(",")
                        .includes(fields_trimmed[index])
                        ? getValue(section, id, mult.split(":")[0])
                        : 1),
                    1
                  ),
              0
            );
            sumTotal *=
              properties.options.hasOwnProperty("multiplier") &&
              Object.keys(properties.options.multiplier).includes(
                fields_trimmed[index]
              )
                ? parseFloat(
                    properties.options.multiplier[fields_trimmed[index]]
                  ) || 0
                : 1;
            sumTotal += Object.entries(properties.attributes).reduce(
              (total, [key, value]) =>
                (total += value.hasOwnProperty(fields_trimmed[index])
                  ? parseFloat(v[key] || 0) *
                    (parseFloat(value[fields_trimmed[index]]) || 1)
                  : 0),
              0
            );
            checks.roundtypes.forEach((type) => {
              if (properties.options.hasOwnProperty(type)) {
                if (
                  Object.keys(properties.options[type]).includes(
                    fields_trimmed[index]
                  )
                ) {
                  sumTotal = getRounded(
                    type,
                    sumTotal,
                    +properties.options[type][fields_trimmed[index]] || 0
                  );
                } else if (
                  properties.options[type] == "0" ||
                  !isNaN(+properties.options[type] || "x")
                ) {
                  sumTotal = getRounded(
                    type,
                    sumTotal,
                    +properties.options[type]
                  );
                }
              }
            });
            obj[destination] = sumTotal;
            return obj;
          }, {});
          setAttrs(output);
        }
      );
    });
  };
  const WP_ACTIONS = ["strike", "parry", "disarm", "rof", "thrown", "entangle"];
  const WP = {
    archery: [
      { strike: 1, parry: 1, rof: 2 },
      { strike: 1, disarm: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      { disarm: 1, rof: 1 },
      { strike: 1 },
      {},
      { strike: 1, rof: 1 },
      {},
      { strike: 1, disarm: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      {},
      { strike: 1, rof: 1 },
      { disarm: 1 },
    ],
    axe: [
      {},
      { strike: 1, parry: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
    ],
    blunt: [
      { strike: 1, parry: 1 },
      {},
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      { strike: 1, parry: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      { thrown: 1 },
      {},
      { strike: 1, parry: 1 },
      {},
      {},
      { thrown: 1 },
    ],
    chain: [
      { strike: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
      {},
      { parry: 1 },
      { strike: 1 },
      {},
      {},
    ],
    forked: [
      { strike: 1, parry: 1, entangle: 1 },
      {},
      { strike: 1, parry: 1, entangle: 1 },
      { thrown: 1 },
      { strike: 1, entangle: 1 },
      { parry: 1 },
      {},
      { strike: 1, entangle: 1 },
      {},
      { parry: 1, thrown: 1 },
      { strike: 1, entangle: 1 },
      {},
      { strike: 1, parry: 1, entangle: 1 },
      {},
      { thrown: 1 },
    ],
    knife: [
      { parry: 1, thrown: 1 },
      { strike: 1 },
      { parry: 1, thrown: 1 },
      { strike: 1 },
      {},
      { parry: 1, thrown: 1 },
      { strike: 1 },
      { thrown: 1 },
      { parry: 1 },
      { strike: 1, thrown: 1 },
      {},
      { parry: 1 },
      { strike: 1, thrown: 1 },
      {},
      {},
    ],
    "grappling hook": [
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      { strike: 1, entangle: 1 },
      {},
      {},
      {},
    ],
    "pole arm": [
      { strike: 1, parry: 1 },
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      { strike: 1, parry: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      {},
    ],
    rope: [
      { strike: 1, entangle: 1, disarm: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
    ],
    shield: [
      { parry: 1 },
      {},
      { parry: 1 },
      { strike: 1 },
      {},
      {},
      { parry: 1 },
      { strike: 1 },
      {},
      { parry: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      {},
    ],
    spear: [
      { strike: 1, parry: 1 },
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1, thrown: 1 },
      {},
      {},
      { strike: 1, parry: 1 },
      { thrown: 1 },
      {},
      { strike: 1, parry: 1 },
      {},
      { thrown: 1 },
      {},
    ],
    staff: [
      { strike: 1 },
      { parry: 1 },
      { strike: 1 },
      {},
      { parry: 1, thrown: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1, thrown: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      { thrown: 1 },
    ],
    sword: [
      { strike: 1 },
      { parry: 1 },
      { strike: 1 },
      { parry: 1, thrown: 1 },
      {},
      { strike: 1 },
      { parry: 1 },
      { thrown: 1 },
      { strike: 1 },
      { parry: 1 },
      {},
      { strike: 1, thrown: 1 },
      { parry: 1 },
      {},
      { strike: 1 },
    ],
    targeting: [
      { strike: 1 },
      { damage: 1 },
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      { damage: 1 },
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      {},
    ],
    whip: [
      {},
      { strike: 1, entangle: 1, disarm: 1, damage: 1 },
      {},
      { strike: 1, entangle: 1, disarm: 1, damage: 1 },
      {},
      {},
      { strike: 1, entangle: 1, disarm: 1 },
      { damage: 1 },
      {},
      { strike: 1, entangle: 1, disarm: 1 },
      {},
      { damage: 1 },
      { strike: 1, entangle: 1, disarm: 1 },
      {},
      {},
    ],
    handguns: [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
    ],
    rifles: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
    ],
    "energy heavy": [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
    ],
    "energy pistol": [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
    ],
    "energy rifle": [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
    ],
    heavy: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
    ],
    speargun: [
      {},
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
    ],
    shotgun: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      { strike: 1 },
      {},
    ],
    submachinegun: [
      { strike: 1 },
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
    ],
    flamethrower: [
      {},
      { strike: 1 },
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
      {},
      {},
      {},
      {},
      { strike: 1 },
    ],
  };

  const getBiAttributeBonus = (attr) => {
    const bonus = attr > 15 ? Math.ceil((Math.min(attr, 30) - 15) / 2) : 0;
    return bonus;
  };

  const mergeAndAddObjects = (data) => {
    const result = {};
    data.forEach((obj) => {
      for (let [key, value] of Object.entries(obj)) {
        if (result[key]) {
          result[key] += value;
        } else {
          result[key] = value;
        }
      }
    });
    return result;
  };

  const setWpRow = (name, keyPrefix, level) => {
    console.log("setWpRow", name, keyPrefix, level);
    const attrs = {};
    const levelBonuses = WP[name.toLowerCase()].slice(0, level);
    const totalBonuses = mergeAndAddObjects(levelBonuses);
    WP_ACTIONS.forEach((action) => {
      const key = `${keyPrefix}_${action}`;
      attrs[key] = action in totalBonuses ? totalBonuses[action] : 0;
      if (action == "strike") {
        attrs[`${keyPrefix}_burst`] = Math.floor(attrs[key] / 2);
      }
      attrs[`${keyPrefix}_wplevel`] = level;
    });
    setAttrs(attrs);
  };

  const setWp = ({
    wpName,
    newCharacterLevel,
    oldCharacterLevel,
    newWpLevel,
    rowId,
  }) => {
    console.log({
      wpName,
      newCharacterLevel,
      oldCharacterLevel,
      newWpLevel,
      rowId,
    });
    const keyPrefix = rowId ? `repeating_wp_${rowId}` : `repeating_wp`;
    if (newWpLevel) {
      setWpRow(wpName, keyPrefix, newWpLevel);
    } else if (!rowId) {
      setWpRow(wpName, keyPrefix, newCharacterLevel);
    } else {
      getAttrs([`${keyPrefix}_wplevel`], (a) => {
        const oldWpLevel = a[`${keyPrefix}_wplevel`];
        console.log("oldWpLevel", oldWpLevel);
        if (oldCharacterLevel) {
          const delta = oldCharacterLevel - oldWpLevel;
          console.log("delta", delta);
          if (delta != 0) {
            newWpLevel = newCharacterLevel - delta;
            setWpRow(wpName, keyPrefix, newWpLevel);
          } else {
            setWpRow(wpName, keyPrefix, newCharacterLevel);
          }
        } else {
          setWpRow(wpName, keyPrefix, newCharacterLevel);
        }
      });
    }
  };

  /**
   * This one is a doozy
   * */
  on("change:level", (e) => {
    console.log("change:level", e.newValue, e.previousValue);
    // Update WPs
    getSectionIDs("wp", (ids) => {
      const attrNames = ids.map((id) => `repeating_wp_${id}_wpname`);
      getAttrs(attrNames, (a) => {
        const attrs = {};
        ids.forEach((id) => {
          setWp({
            wpName: a[`repeating_wp_${id}_wpname`].toLowerCase(),
            newCharacterLevel: e.newValue,
            oldCharacterLevel: e.previousValue,
            rowId: id,
          });
        });
      });
    });
  });

  on("change:h2h", (e) => {
    getAttrs([`level`], (a) => {
      setAttrs({ h2hlevel: a.level });
    });
  });

  on("change:repeating_wp:wplevel", (e) => {
    getSectionIDs("wp", (ids) => {
      const rowId = ids.find(
        (id) => `repeating_wp_${id}_wplevel`.toLowerCase() == e.sourceAttribute
      );
      getAttrs([`repeating_wp_${rowId}_wpname`], (a) => {
        setWp({
          wpName: a[`repeating_wp_${rowId}_wpname`],
          newWpLevel: e.newValue,
          rowId: rowId,
        });
      });
    });
    console.log(e);
  });

  on("change:repeating_wp:wpname", (e) => {
    const wpName = e.newValue.toLowerCase();
    getAttrs(["level"], (a) => {
      setWp({ wpName, newCharacterLevel: a.level });
    });
  });

  on("change:iq", (e) => {
    const iq_bonus = e.newValue > 15 ? e.newValue - 14 : 0;
    const perception_bonus = getBiAttributeBonus(e.newValue);
    setAttrs({ iq_bonus, perception_bonus });
  });

  on("change:me change:pp change:pe", (e) => {
    const bonus = getBiAttributeBonus(e.newValue);
    const attrs = {};
    attrs[`${e.sourceAttribute}_bonus`] = bonus;
    if (e.sourceAttribute == "pe") {
      attrs["pe_coma_bonus"] =
        e.newValue >= 16
          ? e.newValue <= 18
            ? 4 + (e.newValue - 16)
            : e.newValue <= 30
            ? 8 + (e.newValue - 19) * 2
            : 30 + (e.newValue - 30)
          : 0;
    }
    setAttrs(attrs);
  });

  on("change:ma", (e) => {
    const ma_bonus =
      e.newValue >= 16
        ? e.newValue <= 24
          ? 40 + (e.newValue - 16) * 5
          : e.newValue <= 27
          ? 80 + (e.newValue - 24) * 4
          : e.newValue <= 29
          ? 92 + (e.newValue - 27) * 2
          : 97
        : 0;
    setAttrs({ ma_bonus, trust_intimidate: ma_bonus });
  });

  on("change:ps change:ps_type", (e) => {
    getAttrs(["ps", "ps_type"], (a) => {
      const ps = a.ps;
      const ps_type = a.ps_type;
      const ps_bonus = ps > 15 ? ps - 15 : 0;

      let restrained_punch = (punch = power_punch = kick = leap_kick = "");
      let restrained_punch_unit =
        (punch_unit =
        power_punch_unit =
        kick_unit =
        leap_kick_unit =
          "sdc");

      switch (ps_type) {
        case "normal":
          punch = "1D4";
          kick = "1D4";
          break;
        case "augmented":
          if (ps < 24) {
            // nop
          } else if (ps == 24) {
            power_punch = "1";
            power_punch_unit = "mdc";
          } else if (ps <= 27) {
            power_punch = "1D4";
            power_punch_unit = "mdc";
          } else if (ps <= 30) {
            power_punch = "1D6";
            power_punch_unit = "mdc";
          } else if (ps <= 40) {
            power_punch = "2D4";
            power_punch_unit = "mdc";
          } else if (ps <= 50) {
            restrained_punch = "3D6";
            punch = "1D4";
            punch_unit = "mdc";
            power_punch = "3D4";
            power_punch_unit = "mdc";
          } else {
            restrained_punch = "4D6";
            punch = "1D8";
            punch_unit = "mdc";
            power_punch = "4D4";
            power_punch_unit = "mdc";
          }
          break;
        case "robotic":
          if (ps <= 15) {
            restrained_punch = "1D6";
            punch = "2D6";
            power_punch = "4D6";
            kick = "2D6";
            leap_kick = "3D6";
          } else if (ps <= 20) {
            restrained_punch = "2D6";
            punch = "1";
            power_punch = "1D6";
            kick = "1D4";
            leap_kick = "2D4";
            punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
          } else if (ps <= 25) {
            restrained_punch = "6D6";
            punch = "1D4";
            power_punch = "2D4";
            kick = "1D6";
            leap_kick = "2D6";
            punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
          } else if (ps <= 30) {
            restrained_punch = "1D4";
            punch = "1D6";
            power_punch = "2D6";
            kick = "2D4";
            leap_kick = "2D8";
            restrained_punch_unit =
              punch_unit =
              power_punch_unit =
              kick_unit =
              leap_kick_unit =
                "mdc";
          } else if (ps <= 35) {
            restrained_punch = "1D4";
            punch = "2D4";
            power_punch = "4D4";
            kick = "2D8";
            leap_kick = "4D8";
            restrained_punch_unit =
              punch_unit =
              power_punch_unit =
              kick_unit =
              leap_kick_unit =
                "mdc";
          } else if (ps <= 40) {
            restrained_punch = "1D4";
            punch = "2D6";
            power_punch = "4D6";
            kick = "3D8";
            leap_kick = "5D8";
            restrained_punch_unit =
              punch_unit =
              power_punch_unit =
              kick_unit =
              leap_kick_unit =
                "mdc";
          } else if (ps <= 50) {
            restrained_punch = "1D6";
            punch = "3D6";
            power_punch = "1D6*10";
            kick = "5D8";
            leap_kick = "1D8*10";
            restrained_punch_unit =
              punch_unit =
              power_punch_unit =
              kick_unit =
              leap_kick_unit =
                "mdc";
          } else {
            restrained_punch = "2D6";
            punch = "6D6";
            power_punch = "2D6*10";
            kick = "6D8";
            leap_kick = "2D6*10";
            restrained_punch_unit =
              punch_unit =
              power_punch_unit =
              kick_unit =
              leap_kick_unit =
                "mdc";
          }
          break;
        case "supernatural":
          if (ps <= 15) {
            restrained_punch = "1D6";
            punch = "4D6";
            power_punch = "1D4";
            power_punch_unit = "mdc";
          } else if (ps <= 20) {
            restrained_punch = "3D6";
            punch = "1D6";
            power_punch = "2D6";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 25) {
            restrained_punch = "4D6";
            punch = "2D6";
            power_punch = "4D6";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 30) {
            restrained_punch = "5D6";
            punch = "3D6";
            power_punch = "6D6";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 35) {
            restrained_punch = "5D6";
            punch = "4D6";
            power_punch = "1D4*10";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 40) {
            restrained_punch = "6D6";
            punch = "5D6";
            power_punch = "1D6*10";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 50) {
            restrained_punch = "1D6*10";
            punch = "6D6";
            power_punch = "2D4*10";
            punch_unit = power_punch_unit = "mdc";
          } else if (ps <= 60) {
            restrained_punch = "1D6";
            punch = "1D6*10";
            power_punch = "2D6*10";
            restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
          } else {
            // > 60
            const extra = Math.ceil((ps - 60) / 10) * 10;
            restrained_punch = "1D6";
            punch = `1D6*10+${extra}`;
            power_punch = `2D6*10+${extra * 2}`;
            restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
          }
          break;
      }
      const attrs = {
        ps_bonus,
        restrained_punch,
        punch,
        power_punch,
        kick,
        leap_kick,
        restrained_punch_unit,
        punch_unit,
        power_punch_unit,
        kick_unit,
        leap_kick_unit,
      };
      console.log(attrs);
      setAttrs(attrs);
    });
  });

  on("change:pb", (e) => {
    const pb_bonus =
      e.newValue >= 16
        ? e.newValue <= 26
          ? 30 + (e.newValue - 16) * 5
          : e.newValue <= 28
          ? 80 + (e.newValue - 26) * 3
          : e.newValue == 29
          ? 90
          : 92
        : 0;
    setAttrs({ pb_bonus, charm_impress: pb_bonus });
  });

  on("change:spd", (e) => {
    getAttrs(["combat_combined_attacks"], (a) => {
      const feetPerMelee = e.newValue * 15;
      const attrs = {
        run_mph: ((feetPerMelee * 4 * 60) / 5280).toFixed(1),
        run_ft_melee: feetPerMelee,
        run_ft_attack: Math.round(feetPerMelee / a.combat_combined_attacks),
      };
      setAttrs(attrs);
    });
  });

  on("change:repeating_movement:movement_mph", (e) => {
    getAttrs(["combat_combined_attacks"], (a) => {
      const feetPerMelee = Math.round((e.newValue * 5280) / 60 / 4);
      const attrs = {
        repeating_movement_movement_ft_melee: feetPerMelee,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combat_combined_attacks
        ),
      };
      setAttrs(attrs);
    });
  });

  on("change:repeating_movement:movement_ft_melee", (e) => {
    getAttrs(["combat_combined_attacks"], (a) => {
      const feetPerMelee = e.newValue;
      //const mph = Math.round((feetPerMelee * 4 * 60) / 5280);
      const mph = ((feetPerMelee * 4 * 60) / 5280).toFixed(1);
      const attrs = {
        repeating_movement_movement_mph: mph,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combat_combined_attacks
        ),
      };
      setAttrs(attrs);
    });
  });

  on("change:combat_combined_attacks", (e) => {
    getAttrs(["run_ft_melee"], (a) => {
      setAttrs({ run_ft_attack: Math.round(a.run_ft_melee / e.newValue) });
    });
    getSectionIDs("movement", (ids) => {
      const attrNames = ids.map(
        (id) => `repeating_movement_${id}_movement_ft_melee`
      );
      getAttrs(attrNames, (a) => {
        const attrs = {};
        ids.forEach((id) => {
          const row = `repeating_movement_${id}`;
          const feetPerMelee = a[`${row}_movement_ft_melee`] || 0;
          if (feetPerMelee) {
            attrs[`${row}_movement_ft_attack`] = Math.round(
              feetPerMelee / e.newValue
            );
          }
        });
        setAttrs(attrs);
      });
    });
  });

  /**
   * @todo HERE
   * */
  const combineCombat = (sectionIds) => {
    // we need to combine the values of each repeated attribute within
    // each of the sectionIds and aggregate them in the combined combat section
    // +PP +PS, and add a saving throws section with +ME +PE

    // No attribute bonuses.
    repeatingSum(
      [
        "combat_combined_attacks",
        "combat_combined_initiative",
        "combat_combined_pull",
        "combat_combined_roll",
        "combat_combined_damage",
        "combat_combined_strike_range",
      ],
      "combat",
      [
        "combat_skill_attacks",
        "combat_skill_initiative",
        "combat_skill_pull",
        "combat_skill_roll",
        "combat_skill_damage",
        "combat_skill_strike_range",
      ],
      `filter:${sectionIds.toString()}`
    );

    // PP Bonus
    repeatingSum(
      [
        "combat_combined_strike",
        "combat_combined_parry",
        "combat_combined_dodge",
        "combat_combined_throw",
        "combat_combined_disarm",
        "combat_combined_entangle",
        "combat_combined_dodge_flight",
        "combat_combined_dodge_auto",
        "combat_combined_dodge_teleport",
        "combat_combined_dodge_motion",
      ],
      "combat",
      [
        "combat_skill_strike",
        "combat_skill_parry",
        "combat_skill_dodge",
        "combat_skill_throw",
        "combat_skill_disarm",
        "combat_skill_entangle",
        "combat_skill_dodge_flight",
        "combat_skill_dodge_auto",
        "combat_skill_dodge_teleport",
        "combat_skill_dodge_motion",
      ],
      `filter:${sectionIds.toString()}`,
      "pp_bonus"
    );
    return;

    // Master list
    repeatingSum(
      [
        "combat_combined_attacks",
        "combat_combined_initiative",
        "combat_combined_strike",
        "combat_combined_parry",
        "combat_combined_dodge",
        "combat_combined_throw",
        "combat_combined_disarm",
        "combat_combined_entangle",
        "combat_combined_pull",
        "combat_combined_roll",
        "combat_combined_damage",
        "combat_combined_dodge_flight",
        "combat_combined_dodge_auto",
        "combat_combined_dodge_teleport",
        "combat_combined_dodge_motion",
        "combat_combined_strike_range",
        "combat_combined_critical",
      ],
      "combat",
      [
        "combat_skill_attacks",
        "combat_skill_initiative",
        "combat_skill_strike",
        "combat_skill_parry",
        "combat_skill_dodge",
        "combat_skill_throw",
        "combat_skill_disarm",
        "combat_skill_entangle",
        "combat_skill_pull",
        "combat_skill_roll",
        "combat_skill_damage",
        "combat_skill_dodge_flight",
        "combat_skill_dodge_auto",
        "combat_skill_dodge_teleport",
        "combat_skill_dodge_motion",
        "combat_skill_strike_range",
        "combat_skill_critical",
      ],
      `filter:${sectionIds.toString()}`,
      "pp_bonus"
    );
  };

  on(
    "change:combat_skill_base change:combat_skill_extra change:combat_skill_additional change:repeating_combat",
    (e) => {
      console.log("change:combat_skill_base");
      const combinerNames = [
        "combat_skill_base",
        "combat_skill_extra",
        "combat_skill_additional",
      ];
      getSectionIDs("combat", (ids) => {
        console.log(ids);
        const attrNames = ids.map(
          (id) => `repeating_combat_${id}_combat_skill`
        );
        getAttrs(attrNames, (repeaters) => {
          getAttrs(combinerNames, (combiners) => {
            const sectionIds = [];
            for (const [cKey, cValue] of Object.entries(combiners)) {
              console.log("c", cKey, cValue);
              const repeaterSkill = Object.keys(repeaters).find(
                (rKey) => repeaters[rKey] == cValue
              );
              console.log("repeaterSkill", repeaterSkill);
              if (repeaterSkill) {
                sectionIds.push(
                  ids.find((id) => repeaterSkill.includes(id.toLowerCase()))
                );
              }
            }
            console.log(sectionIds);
            combineCombat(sectionIds);
          });
        });
      });
    }
  );

  const buttonlist = ["core", "wp", "combat", "equipment", "skills"];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({
        sheetTab: button,
      });
    });
  });
</script>
