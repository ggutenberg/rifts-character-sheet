<main id="megaverse">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_abilities">
      Abilities
    </button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">
      Modifiers
    </button>
    <button class="metal linear" type="action" name="act_bonuses">
      Bonuses
    </button>
    <button class="metal linear" type="action" name="act_magic">Magic</button>
    <button class="metal linear" type="action" name="act_psionics">
      Psionics
    </button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
    <button class="metal linear" type="action" name="act_importexport">
      Imp/Exp
    </button>
    <img
      class="logo"
      src="https://db4sgowjqfwig.cloudfront.net/game_systems/22/assets/1100695/rifts-logo.png"
    />
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />
  <!-- inject:partials/datalists.html -->
  <datalist id="distance-units">
  <option value="m"></option>
  <option value="km"></option>
  <option value="ft"></option>
  <option value="yd"></option>
  <option value="mi"></option>
</datalist>
<datalist id="damage-units">
  <option value="MDC"></option>
  <option value="SDC"></option>
</datalist>
<datalist id="time-units">
  <option value="seconds"></option>
  <option value="melees"></option>
  <option value="minutes"></option>
  <option value="hours"></option>
  <option value="days"></option>
  <option value="weeks"></option>
  <option value="months"></option>
  <option value="years"></option>
</datalist>
<datalist id="frequency-units">
  <option value="per second"></option>
  <option value="per melee"></option>
  <option value="per minute"></option>
  <option value="per hour"></option>
  <option value="per day"></option>
  <option value="per week"></option>
  <option value="per month"></option>
  <option value="per year"></option>
</datalist>
<datalist id="spell-schools">
  <option value="Invocation"></option>
  <option value="Elemental"></option>
  <option value="Necromancy"></option>
</datalist>
<datalist id="combat-modifiers">
  <option value="Custom - Type Your Own"></option>
  <option value="Hand to Hand: Basic"></option>
  <option value="Hand to Hand: Dragon"></option>
  <option value="RPA Basic"></option>
  <option value="RPA Elite: Glitter Boy"></option>
  <option value="Weapon: NG-P7"></option>
  <option value="Weapon: TW Flame Sword"></option>
  <option value="Armor: Crusader"></option>
  <option value="Power Armor: Glitter Boy"></option>
  <option value="TW: Armor of Ithan"></option>
  <option value="Spell: Superhuman Speed"></option>
  <option value="Psionic: Sixth Sense"></option>
  <option value="Magic Amulet: Charm"></option>
</datalist>
<datalist id="weapon-proficiencies">
  <option value="W.P. Archery"></option>
  <option value="W.P. Axe"></option>
  <option value="W.P. Blunt"></option>
  <option value="W.P. Chain"></option>
  <option value="W.P. Forked"></option>
  <option value="W.P. Knife"></option>
  <option value="W.P. Grappling Hook"></option>
  <option value="W.P. Pole Arm"></option>
  <option value="W.P. Rope"></option>
  <option value="W.P. Shield"></option>
  <option value="W.P. Spear"></option>
  <option value="W.P. Staff"></option>
  <option value="W.P. Sword"></option>
  <option value="W.P. Targeting"></option>
  <option value="W.P. Whip"></option>
</datalist>
<datalist id="weapon-proficiencies-modern">
  <option value="W.P. Handguns"></option>
  <option value="W.P. Rifles"></option>
  <option value="W.P. Energy Heavy"></option>
  <option value="W.P. Energy Pistol"></option>
  <option value="W.P. Energy Rifle"></option>
  <option value="W.P. Heavy"></option>
  <option value="W.P. Speargun"></option>
  <option value="W.P. Shotgun"></option>
  <option value="W.P. Submachinegun"></option>
  <option value="W.P. Flamethrower"></option>
</datalist>

  <!-- endinject -->

  <!-- inject:partials/core.html -->
  <div class="core">
  <br />
  <h1>Character Statistics</h1>
  <div class="grid-container">
    <div class="section-one character-background">
      <label
        ><span>Character Name</span>
        <input
          id="character-name"
          type="text"
          value=""
          name="attr_character_name"
      /></label>
      <label
        ><span>True Name</span>
        <input type="text" value="" name="attr_truename_name"
      /></label>
      <label
        ><span>Race</span>
        <input type="text" value="" name="attr_character_race"
      /></label>
      <label
        ><span>Character Class</span>
        <input type="text" value="" name="attr_occ"
      /></label>
      <label
        ><span>Strength Type</span>
        <select class="" name="attr_character_ps_type" value="normal">
          <option value="1">Normal</option>
          <option value="2">Augmented</option>
          <option value="3">Robotic</option>
          <option value="4">Supernatural</option>
        </select></label
      >
      <label
        ><span>Level</span> <input type="number" name="attr_character_level"
      /></label>
      <label
        ><span>Experience</span> <input type="number" name="attr_experience"
      /></label>
      <label
        ><span>Alignment</span>
        <select class="select" name="attr_alignment" value="0">
          <option value="0"></option>
          <option value="Principled">Principled</option>
          <option value="Scrupulous">Scrupulous</option>
          <option value="Unprincipled">Unprincipled</option>
          <option value="Anarchist">Anarchist</option>
          <option value="Taoist">Taoist</option>
          <option value="Miscreant">Miscreant</option>
          <option value="Abberant">Aberrant</option>
          <option value="Diabolic">Diabolic</option>
        </select></label
      >
      <label
        ><span>Age</span>
        <input
          class="attribute"
          type="number"
          value=""
          name="attr_character_age"
      /></label>
      <label
        ><span>Gender</span>
        <input type="text" value="" name="attr_character_gender"
      /></label>
      <label
        ><span>Height</span>
        <input type="text" value="" name="attr_character_height"
      /></label>
      <label
        ><span>Weight</span>
        <input type="text" value="" name="attr_character_weight"
      /></label>
      <label
        ><span>Family Origin</span>
        <input type="text" value="" name="attr_character_familyorigin"
      /></label>
      <label
        ><span>Environment</span>
        <input value="" name="attr_character_environment"
      /></label>
      <label
        ><span>Native Language(s)</span>
        <input type="text" value="" name="attr_character_languages"
      /></label>
      <label
        ><span>Insanity, if any</span>
        <input type="text" value="" name="attr_character_insanity"
      /></label>
      <label
        ><span>Disposition</span>
        <input type="text" value="" name="attr_character_disposition"
      /></label>
    </div>

    <div class="section-two">
      <div class="ss-2a">
        <label for="iq">I.Q.</label>
        <input
          id="iq"
          type="number"
          value="0"
          name="attr_iq"
          title="Intelligence Quotient"
        />
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_iq_bonus"
          title="+ Skills %"
          readonly
        />
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_perception_bonus"
          title="+ Perception (Rifter #13, p.16)"
          readonly
        />

        <label for="mental-endurance">M.E.</label>
        <input
          id="mental-endurance"
          type="number"
          value="0"
          name="attr_me"
          title="Mental Endurance"
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_me_bonus"
          title="+ Save vs. Psionics"
          readonly
        />
        <div></div>

        <label for="mental-affinity">M.A.</label>
        <input
          id="mental-affinity"
          type="number"
          value="0"
          name="attr_ma"
          title="Mental Affinity"
        />
        <input
          type="number"
          value="0"
          name="attr_ma_bonus"
          title="% Trust/Intimidate"
          readonly
        />
        <div></div>

        <label for="physical-strength">P.S.</label>
        <input
          id="physical-strength"
          type="number"
          value="0"
          name="attr_ps"
          title="Physical Strength"
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_ps_bonus"
          title="+ SDC Damage"
          readonly
        />
        <div></div>

        <label for="physical-prowess">P.P</label>
        <input
          id="physical-prowess"
          type="number"
          value="0"
          name="attr_pp"
          title="Physical Prowess"
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_pp_bonus"
          title="+ Strike/Parry/Dodge/Entangle/Disarm"
          readonly
        />
        <div></div>

        <label for="physical-endurance">P.E.</label>
        <input
          id="physical-endurance"
          type="number"
          value="0"
          name="attr_pe"
          title="Physical Endurance"
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_pe_bonus"
          title="+ Magic/Poison/Toxins"
          readonly
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_pe_coma_bonus"
          title="+ Coma/Death %"
          readonly
        />

        <label for="physical-beauty">P.B.</label>
        <input
          id="physical-beauty"
          type="number"
          value="0"
          name="attr_pb"
          title="Physical Beauty"
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_pb_bonus"
          title="% Charm/Impress"
          readonly
        />
        <div></div>

        <label for="speed">Spd</label>
        <input
          id="speed"
          type="number"
          value="0"
          name="attr_spd"
          title="Speed"
        />
      </div>
      <div class="ss-2b">
        <label for="trust-intimidate">Trust/Intimidate</label>
        <input
          id="trust-intimidate"
          type="number"
          value="0"
          name="attr_trust_intimidate"
        /><span>%</span>

        <label for="charm-impress">Charm/Impress</label>
        <input
          id="charm-impress"
          type="number"
          value="0"
          name="attr_charm_impress"
        /><span>%</span>
      </div>
      <div class="ss-2c">
        <label for="restrained-punch">Restrained Punch</label>
        <input
          id="restrained-punch"
          type="text"
          name="attr_restrained_punch"
          value="0"
        />
        <select name="attr_restrained_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>

        <label for="punch">Punch</label>
        <input id="punch" type="text" name="attr_punch" value="0" />
        <select name="attr_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>

        <label for="power-punch">Power Punch</label>
        <input id="power-punch" type="text" name="attr_power_punch" value="0" />
        <select name="attr_power_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>

        <label for="kick">Kick</label>
        <input id="kick" type="text" name="attr_kick" value="0" />
        <select name="attr_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>

        <label for="leap-kick">Leap Kick</label>
        <input id="leap-kick" type="text" name="attr_leap_kick" value="0" />
        <select name="attr_leap_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>

        <label for="lift">Lift</label>
        <input id="lift" type="number" value="0" name="attr_lift" value="0" />
        <div></div>

        <label for="carry">Carry</label>
        <input id="carry" type="number" value="0" name="attr_carry" value="0" />
        <div></div>

        <label for="throw">Throw</label>
        <input id="throw" type="number" value="0" name="attr_throw" value="0" />
        <div></div>

        <label for="carry-max">Carry Max</label>
        <input
          id="carry-max"
          type="number"
          value="0"
          name="attr_carry_max"
        />Minutes

        <label for="carry-running">Carry (Running)</label>
        <input
          id="carry-running"
          type="number"
          value="0"
          name="attr_carry_running"
        />Minutes

        <label for="hold-max">Hold Max.</label>
        <input
          id="hold-max"
          type="number"
          value="0"
          name="attr_hold_max"
        />Melees
      </div>
    </div>
    <div class="section-three">
      <label
        ><span>Hit Points</span>
        <input type="number" value="0" name="attr_character_hp" />
      </label>
      <label>
        <span>S.D.C.</span>
        <input type="number" value="0" name="attr_character_sdc" />
      </label>
      <label
        ><span>A.R.</span
        ><input type="number" value="0" name="attr_character_ar"
      /></label>
      <label
        ><span>M.D.C.</span>
        <input type="number" value="0" name="attr_character_mdc" />
      </label>
      <label
        ><span>P.P.E.</span>
        <input type="number" value="0" name="attr_character_ppe" />
      </label>
      <label
        ><span>I.S.P.</span
        ><input type="number" value="0" name="attr_character_isp"
      /></label>
      <label
        ><span>H.F.</span><input type="number" value="0" name="attr_hf"
      /></label>
      <label
        ><span>Perception</span>
        <input id="perception" type="number" value="0" name="attr_perception" />
        <button type="roll" value="Perception: [[d20+@{perception}]]" />
      </label>
    </div>
  </div>

  <h2>Movement</h2>
  <div class="movement-container">
    <div></div>
    <label for="mph">MPH</label>
    <label for="ft-melee">Ft/Melee</label>
    <label for="ft-attack">Ft/Attack</label>
    <label for="cruising">Cruising</label>
    <label for="run-at-max">Run at Max</label>
    <label>Run</label>
    <input id="mph" type="number" value="0" readonly name="attr_run_mph" />
    <input
      id="ft-melee"
      type="number"
      value="0"
      readonly
      name="attr_run_ft_melee"
    />
    <input
      id="ft-attack"
      type="number"
      value="0"
      readonly
      name="attr_run_ft_attack"
    />
    <input id="cruising" type="number" value="0" name="attr_run_cruising" />
    <div>
      <input
        id="run-at-max"
        type="number"
        value="@{pe}/2"
        disabled="true"
        name="attr_run_at_max"
      />
      minutes
    </div>

    <label>Leaping Distance</label>
    <input type="number" name="attr_leapup" value="0" />
    <div>feet up?</div>
    <input type="number" name="attr_leapout" value="0" />
    <div>feet out?</div>
    <div></div>
  </div>
  <br />
  <div class="repeating-movement">
    <fieldset class="repeating_movement">
      <h5>Additional Movement Type</h5>
      <h5>MPH</h5>
      <h5>Ft/Melee</h5>
      <h5>Ft/Attack</h5>
      <h5>Cruising</h5>
      <h5>Max speed duration</h5>
      <input type="text" value="" name="attr_name" />
      <input type="number" value="0" name="attr_mph" />
      <input type="number" value="0" name="attr_ft_melee" />
      <input type="number" value="0" name="attr_ft_attack" readonly />
      <input type="number" value="0" name="attr_cruising" />
      <label
        ><input type="number" value="0" name="attr_dur_at_max" /> minutes</label
      >
    </fieldset>
  </div>
</div>

  <!-- endinject -->

  <br />

  <!-- inject:partials/abilities.html -->
  <div class="abilities">
  <h3>Natural Abilities / Powers</h3>
  <details>
    <summary><b>Instructions</b></summary>
    <p>
      Enter some natural abilities/powers that are neither magic nor psionic in
      nature.
    </p>
    <p>
      For Starting Damage and Damage per Level enter values that roll20 would
      use for dice rolls. Ex. "4d6", "1d6", etc.
    </p>
    <p>
      Don't forget to copy/paste the power description into the Description
      field to make life easier for your GM. Also use that field for any macros
      you may need like Strike with an arbitrary bonus.
    </p>
  </details>
  <p>Click <b>Instructions</b> for detailed instructions.</p>
  <fieldset class="repeating_abilities">
    <details>
      <summary>
        <div class="abilities-list">
          <h5>Info</h5>
          <h5>Ability</h5>
          <h5>Range</h5>
          <h5>Duration</h5>
          <h5>Frequency</h5>
          <h5>Damage</h5>
          <h5></h5>
          <h5 title="Damage Capacity">D.C.</h5>
          <h5>Skill</h5>
          <h5></h5>
          <b class="click-expand"
            ><span title="Click for more info">&nbsp;&#9432;</span></b
          >
          <input type="text" value="" name="attr_name" />
          <input type="text" value="0" name="attr_range" />
          <input type="text" value="0" name="attr_duration" />
          <input type="text" value="0" name="attr_frequency" />
          <input type="text" value="0" name="attr_damage" />
          <button
            type="roll"
            value="@{character_name} @{name} [[@{damage}]] @{damage_unit}"
          />
          <input type="text" value="0" name="attr_dc" />
          <input type="number" value="0" name="attr_percentage" readonly />
          <button
            type="roll"
            value="@{character_name} @{name} check: [[d100<@{percentage}]]"
          />
        </div>
      </summary>
      <div class="ability-details">
        <label
          ><span>Starting range</span
          ><input type="number" value="0" name="attr_range_starting"
        /></label>
        <label
          ><span>Range per level</span
          ><input type="number" value="0" name="attr_range_per_level"
        /></label>
        <label
          ><span>Range unit</span
          ><input
            type="text"
            value=""
            name="attr_range_unit"
            list="distance-units"
          />
        </label>
        <label
          ><span>Starting duration</span
          ><input type="number" value="0" name="attr_duration_starting"
        /></label>
        <label
          ><span>Duration per level</span
          ><input type="number" value="0" name="attr_duration_per_level"
        /></label>
        <label
          ><span>Duration unit</span
          ><input
            type="text"
            value=""
            name="attr_duration_unit"
            list="time-units"
          />
        </label>
        <label
          ><span>Starting frequency</span
          ><input type="number" value="0" name="attr_frequency_starting"
        /></label>
        <label
          ><span>Frequency per level</span
          ><input type="number" value="0" name="attr_frequency_per_level"
        /></label>
        <label
          ><span>Frequency unit</span
          ><input
            type="text"
            value=""
            name="attr_frequency_unit"
            list="frequency-units"
          />
        </label>
        <label
          ><span>Starting damage</span
          ><input type="text" value="0" name="attr_damage_starting"
        /></label>
        <label
          ><span>Damage per level</span
          ><input type="text" value="0" name="attr_damage_per_level"
        /></label>
        <label
          ><span>Damage unit</span
          ><input
            type="text"
            value=""
            name="attr_damage_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting D.C.</span
          ><input type="number" value="0" name="attr_dc_starting"
        /></label>
        <label
          ><span>D.C. per level</span
          ><input type="number" value="0" name="attr_dc_per_level"
        /></label>
        <label
          ><span>D.C. unit</span
          ><input
            type="text"
            value=""
            name="attr_dc_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting skill %</span
          ><input type="number" value="0" name="attr_percentage_starting"
        /></label>
        <label
          ><span>Skill % per level</span
          ><input type="number" value="0" name="attr_percentage_per_level"
        /></label>
        <label></label>
      </div>
      <label
        ><b>Description</b>
        <textarea class="full" name="attr_description" value=""></textarea>
      </label>
      <div class="macro-help">
        <label
          ><span><b>Row ID:</b></span>
          <input type="text" readonly name="attr_rowid" value=""
        /></label>
      </div>
    </details>
  </fieldset>
</div>

  <!-- endinject -->

  <!-- inject:partials/weapon_proficiencies.html -->
  <div class="wp">
  <div class="wp-container">
    <h3>Ancient Weapon Proficiencies</h3>
    <fieldset class="repeating_wp">
      <h5>Weapon Proficiency</h5>
      <h5>Strike</h5>
      <h5>Parry</h5>
      <h5>Disarm</h5>
      <h5>Throw</h5>
      <h5>Entangle</h5>
      <h5>RoF</h5>
      <h5>Level</h5>
      <h5>Row ID</h5>
      <input type="hidden" name="attr_bonus_id" value="" />
      <input type="text" list="weapon-proficiencies" name="attr_name" />
      <input type="number" value="0" name="attr_strike" />
      <input type="number" value="0" name="attr_parry" />
      <input type="number" value="0" name="attr_disarm" />
      <input type="number" value="0" name="attr_throw" />
      <input type="number" value="0" name="attr_entangle" />
      <input type="number" value="0" name="attr_rof" />
      <input type="number" value="0" name="attr_level" />
      <input type="string" value="" name="attr_rowid" readonly />
    </fieldset>
    <hr />
    <h3>Modern Weapon Proficiencies</h3>
    <fieldset class="repeating_wpmodern">
      <h5>Weapon Proficiency</h5>
      <h5>Single</h5>
      <h5>Burst</h5>
      <h5>Level</h5>
      <h5>Row ID</h5>
      <input type="hidden" name="attr_bonus_id" value="" />
      <input type="text" list="weapon-proficiencies-modern" name="attr_name" />
      <input type="number" value="0" name="attr_strike_range_single" />
      <input type="number" value="0" name="attr_strike_range_burst" />
      <input type="number" value="0" name="attr_level" />
      <input type="text" value="" name="attr_rowid" readonly />
    </fieldset>
  </div>
</div>

  <!-- endinject -->

  <div class="modifiers">
    <div class="bonuses-container">
      <h3>Modifiers</h3>
      <details>
        <summary><b>Instructions</b></summary>
        <p>
          Complete the repeating sections for your various combat skills and
          modifiers. Skill dropdowns are free-form, so you can type anything in
          them and don't need to select from the list. What's there is just a
          small sample.
        </p>
        <p>
          Any modifiers you add will appear as checkboxes on the Bonuses tab.
          Toggling them will recalculate the bonuses for all checked items.
        </p>
        <p>
          If you have additional bonuses from items, magic, training, etc., you
          can create arbitrarily named sections and apply those as well. You can
          also add weapons here, and include any strike/parry bonuses they
          provide, as well as their damage.
        </p>
      </details>
      <p>Click <b>Instructions</b> for detailed instructions.</p>
      <fieldset class="repeating_modifiers">
        <input type="hidden" name="attr_bonus_id" value="" />
        <!-- inject:partials/repeating_bonuses_details.html -->
        <details>
  <summary>
    <div class="bonus-thing-heading">
      <b class="click-expand"
        ><span title="Click for more info">&nbsp;&#9432;</span></b
      >
      <label
        ><span>Name</span>
        <input type="text" list="combat-modifiers" name="attr_name" />
      </label>
      <label
        ><span>Level</span>
        <input type="number" value="1" name="attr_level" />
      </label>
    </div>
  </summary>
  <div class="profile-management">
    <button type="action" name="act_copybonusids">Copy Selected IDs</button>
    <button type="action" name="act_checkbonusids">
      Apply this Profile to Selected IDs
    </button>
    <button type="action" name="act_updateprofile">Update Profile</button>
    <input type="text" class="full" name="attr_bonus_ids" />
    <input type="hidden" name="attr_bonus_names" />
    <span name="attr_bonus_names"></span>
  </div>
  <details class="default">
    <summary>
      <h3>Attributes</h3>
    </summary>
    <div class="bonus-type-container attributes">
      <label
        ><span>I.Q.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_iq"
          title="Intelligence Quotient"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_iq_abs" />|x|</label
        >
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_iq_bonus"
          title="+ Skills %"
          readonly
        />
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_perception_bonus"
          title="+ Perception (Rifter #13, p.16)"
          readonly
        />
      </label>
      <label
        ><span>M.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_me"
          title="Mental Endurance"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_me_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_me_bonus"
          title="+ Save vs. Psionics"
          readonly
        />
      </label>
      <label
        ><span>M.A.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ma"
          title="Mental Affinity"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ma_abs" />|x|</label
        >
        <input
          type="number"
          value="0"
          name="attr_mod_ma_bonus"
          title="% Trust/Intimidate"
          readonly
        />
      </label>
      <label
        ><span>P.S.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ps"
          title="Physical Strength"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ps_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_ps_bonus"
          title="+ SDC Damage"
          readonly
        />
      </label>
      <label
        ><span>P.P.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pp"
          title="Physical Prowess"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pp_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pp_bonus"
          title="+ Strike/Parry/Dodge/Entangle/Disarm"
          readonly
        />
      </label>
      <label
        ><span>P.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pe"
          title="Physical Endurance"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pe_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_bonus"
          title="+ Magic/Poison/Toxins"
          readonly
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_coma_bonus"
          title="+ Coma/Death %"
          readonly
        />
      </label>
      <label
        ><span>P.B.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pb"
          title="Physical Beauty"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pb_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pb_bonus"
          title="% Charm/Impress"
          readonly
        />
      </label>
      <label
        ><span>Spd</span>
        <input
          type="number"
          value="0"
          name="attr_mod_spd"
          title="Speed"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_spd_abs" />|x|</label
        ></label
      >
    </div>
    <hr />
    <div class="bonus-ps-container">
      <label class="select"
        ><span>PS Type</span>
        <select class="" name="attr_mod_ps_type" value="normal">
          <option value="1">Normal</option>
          <option value="2">Augmented</option>
          <option value="3">Robotic</option>
          <option value="4">Supernatural</option>
        </select></label
      >
      <label
        >Restrained Punch
        <input type="text" name="attr_rmod_estrained_punch" value="0" />
        <select name="attr_mod_restrained_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Punch
        <input type="text" name="attr_mod_punch" value="0" />
        <select name="attr_mod_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Power Punch
        <input type="text" name="attr_mod_power_punch" value="0" />
        <select name="attr_mod_power_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Kick
        <input type="text" name="attr_mod_kick" value="0" />
        <select name="attr_mod_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Leap Kick
        <input type="text" name="attr_mod_leap_kick" value="0" />
        <select name="attr_mod_leap_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>
      </label>

      <label
        >Lift
        <input type="number" value="0" name="attr_mod_lift" value="0" />
        <div></div>
      </label>

      <label
        >Carry
        <input type="number" value="0" name="attr_mod_carry" value="0" />
        <div></div
      ></label>

      <label
        >Throw
        <input type="number" value="0" name="attr_mod_throw" value="0" />
        <div></div
      ></label>

      <label
        >Carry Max
        <input type="number" value="0" name="attr_mod_carry_max" /><span
          >Minutes</span
        ></label
      >

      <label
        >Carry (Running)
        <input type="number" value="0" name="attr_mod_carry_running" /><span
          >Minutes</span
        ></label
      >

      <label
        >Hold Max.
        <input type="number" value="0" name="attr_mod_hold_max" /><span
          >Melees</span
        ></label
      >
    </div>
    <hr />
  </details>
  <div class="bonus-type-container">
    <label
      ><span title="Hit Points">H.P.</span
      ><input type="number" value="0" name="attr_hp"
    /></label>
    <label
      ><span>S.D.C.</span><input type="number" value="0" name="attr_sdc"
    /></label>
    <label
      ><span>A.R.</span><input type="number" value="0" name="attr_ar"
    /></label>
    <label
      ><span>M.D.C.</span><input type="number" value="0" name="attr_mdc"
    /></label>
    <label
      ><span>P.P.E.</span><input type="number" value="0" name="attr_ppe"
    /></label>
    <label
      ><span>I.S.P.</span><input type="number" value="0" name="attr_isp"
    /></label>
    <label
      ><span>H.F.</span
      ><input type="number" value="0" name="attr_mod_hf" /><label class="abs"
        ><input type="checkbox" value="1" name="attr_hf_abs" />|x|</label
      ></label
    >
  </div>
  <hr />
  <h3>Combat</h3>
  <div class="bonus-type-container">
    <label
      ><span>Attacks</span>
      <input type="number" value="0" name="attr_attacks" />
    </label>
    <label
      ><span>Initiative</span>
      <input type="number" value="0" name="attr_initiative" />
      <button type="roll" value="Initiative: [[d20+@{initiative}]]" />
    </label>
    <label
      ><span>Strike</span>
      <input type="number" value="0" name="attr_strike" />
      <button type="roll" value="Strike: [[d20+@{strike}]]" />
    </label>
    <label
      ><span>Parry</span>
      <input type="number" value="0" name="attr_parry" />
      <button type="roll" value="Parry: [[d20+@{parry}]]" />
    </label>
    <label
      ><span>Dodge</span>
      <input type="number" value="0" name="attr_dodge" />
      <button type="roll" value="Dodge: [[d20+@{dodge}]]" />
    </label>
    <label
      ><span>Throw</span>
      <input type="number" value="0" name="attr_throw" />
      <button type="roll" value="Throw: [[d20+@{throw}]]" />
    </label>
    <label
      ><span>Disarm</span>
      <input type="number" value="0" name="attr_disarm" />
      <button type="roll" value="Disarm: [[d20+@{disarm}]]" />
    </label>
    <label
      ><span>Entangle</span>
      <input type="number" value="0" name="attr_entangle" />
      <button type="roll" value="Entangle: [[d20+@{entangle}]]" />
    </label>
    <label
      ><span>Pull Punch</span>
      <input type="number" value="0" name="attr_pull" />
      <button type="roll" value="Pull Punch: [[d20+@{pull}]]" />
    </label>
    <label
      ><span>Roll w/ Impact</span>
      <input type="number" value="0" name="attr_roll" />
      <button type="roll" value="Roll w/ Impact: [[d20+@{roll}]]" />
    </label>
    <label
      ><span>Body Flip/Throw</span>
      <input type="number" value="0" name="attr_flipthrow" />
      <button type="roll" value="Body Flip/Throw: [[d20+@{flipthrow}]]" />
    </label>
    <label
      ><span>Damage</span>
      <input type="text" value="0" name="attr_damage" />
      <button
        type="roll"
        value="?{Add damage modifier?|
          None,Damage: [[@{damage}]]|
          Punch,Damage: [[@{damage}+@{punch}]]|
          P.S. Bonus,Damage: [[@{damage}+@{ps_bonus}]]
        }"
      />
    </label>
    <label
      ><span>Dodge: Flight</span>
      <input type="number" value="0" name="attr_dodge_flight" />
      <button type="roll" value="Dodge in Flight: [[d20+@{dodge_flight}]]" />
    </label>
    <label
      >Dodge: Auto
      <input type="number" value="0" name="attr_dodge_auto" />
      <button type="roll" value="Auto Dodge: [[d20+@{dodge_auto}]]" />
    </label>
    <label
      ><span>Dodge: Teleport</span>
      <input type="number" value="0" name="attr_dodge_teleport" />
      <button type="roll" value="Teleport Dodge: [[d20+@{dodge_teleport}]]" />
    </label>
    <label
      ><span>Dodge: Motion</span>
      <input type="number" value="0" name="attr_dodge_motion" />
      <button type="roll" value="Dodge in Motion: [[d20+@{dodge_motion}]]" />
    </label>
    <label
      ><span>Strike: Range</span>
      <input type="number" value="0" name="attr_strike_range" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range}]]" />
    </label>
    <label
      ><span>Range: Single</span>
      <input type="number" value="0" name="attr_strike_range_single" />
      <button
        type="roll"
        value="Range Strike: [[d20+@{strike_range_single}]]"
      />
    </label>
    <label
      ><span>Range: Burst</span>
      <input type="number" value="0" name="attr_strike_range_burst" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range_burst}]]" />
    </label>
    <label
      ><span>Range: Aimed</span>
      <input type="number" value="0" name="attr_strike_range_aimed" />
      <button
        type="roll"
        value="Range Aimed Strike: [[d20+@{strike_range_aimed}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_single"
      />
      <button
        type="roll"
        value="Range Aimed Single Strike: [[d20+@{strike_range_aimed_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Pulse Strike: [[d20+@{strike_range_aimed_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Called</span>
      <input type="number" value="0" name="attr_strike_range_called" />
      <button
        type="roll"
        value="Range Called Strike: [[d20+@{strike_range_called}]]"
      />
    </label>
    <label
      ><span>Range: Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_single"
      />
      <button
        type="roll"
        value="Range Called Single Strike: [[d20+@{strike_range_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_pulse"
      />
      <button
        type="roll"
        value="Range Called Pulse Strike: [[d20+@{strike_range_called_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_single"
      />
      <button
        type="roll"
        value="Range Aimed Called Single Strike: [[d20+@{strike_range_aimed_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Called Pulse Strike: [[d20+@{strike_range_aimed_called_pulse}]]"
      />
    </label>
    <label
      ><span>Disarm: Range</span>
      <input type="number" value="0" name="attr_disarm_range" />
      <button type="roll" value="Range Disarm: [[d20+@{disarm_range}]]" />
    </label>
    <label
      ><span>Damage: Range</span>
      <input type="text" value="0" name="attr_damage_range" />
      <button type="roll" value="Range Damage: [[@{damage_range}]]" />
    </label>
    <label
      ><span>Critical</span> <input type="number" value="" name="attr_critical"
    /></label>
    <label
      ><span>Knockout</span> <input type="number" value="" name="attr_knockout"
    /></label>
    <label
      ><span>Death Blow</span>
      <input type="number" value="0" name="attr_deathblow"
    /></label>
  </div>
  <hr />
  <h3>Saving Throws</h3>
  <div class="bonus-type-container">
    <label
      ><span>Perception</span>
      <input type="number" value="0" name="attr_perceptioncheck" />
      <button
        type="roll"
        value="Perception Check: [[d20+@{perceptioncheck}]]"
      />
    </label>
    <label
      ><span>Psionics</span>
      <input type="number" value="0" name="attr_psionics" />
      <button type="roll" value="Save vs. Psionics: [[d20+@{psionics}]]" />
    </label>
    <label
      ><span>Magic</span>
      <input type="number" value="0" name="attr_magic" />
      <button type="roll" value="Save vs. Magic: [[d20+@{magic}]]" />
    </label>
    <label
      ><span>Horror Factor</span>
      <input type="number" value="0" name="attr_horrorfactor" />
      <button
        type="roll"
        value="Save vs. Horror Factor: [[d20+@{horrorfactor}]]"
      />
    </label>
    <label
      ><span>Mind Control</span>
      <input type="number" value="0" name="attr_mindcontrol" />
      <button
        type="roll"
        value="Save vs. Mind Control: [[d20+@{mindcontrol}]]"
      />
    </label>
    <label
      ><span>Disease</span>
      <input type="number" value="0" name="attr_disease" />
      <button type="roll" value="Save vs. Disease: [[d20+@{disease}]]" />
    </label>
    <label
      ><span>Illusions</span>
      <input type="number" value="0" name="attr_illusions" />
      <button type="roll" value="Save vs. Illusions: [[d20+@{illusions}]]" />
    </label>
    <label
      ><span>Possession</span>
      <input type="number" value="0" name="attr_possession" />
      <button type="roll" value="Save vs. Possession: [[d20+@{possession}]]" />
    </label>
    <label
      ><span>Insanity</span>
      <input type="number" value="0" name="attr_insanity" />
      <button type="roll" value="Save vs. Insanity: [[d20+@{insanity}]]" />
    </label>
    <label
      ><span>Pain</span>
      <input type="number" value="0" name="attr_pain" />
      <button type="roll" value="Save vs. Pain: [[d20+@{pain}]]" />
    </label>
    <label
      ><span>Lethal Poison</span>
      <input type="number" value="0" name="attr_lethalpoison" />
      <button
        type="roll"
        value="Save vs. Lethal Poison: [[d20+@{lethalpoison}]]"
      />
    </label>
    <label
      ><span>Non-Lethal Poison</span>
      <input type="number" value="0" name="attr_nonlethalpoison" />
      <button
        type="roll"
        value="Save vs. Non-Lethal Poison: [[d20+@{nonlethalpoison}]]"
      />
    </label>
    <label
      ><span>Drugs</span>
      <input type="number" value="0" name="attr_drugs" />
      <button type="roll" value="Save vs. Drugs: [[d20+@{drugs}]]" />
    </label>
    <label
      ><span>Curses</span>
      <input type="number" value="0" name="attr_curses" />
      <button type="roll" value="Save vs. Curses: [[d20+@{curses}]]" />
    </label>
    <label
      ><span>Coma/Death</span>
      <input type="number" value="0" name="attr_comadeath" />
      <button type="roll" value="Save vs. Coma/Death: [[d100-@{comadeath}]]" />
    </label>
  </div>
  <label class="description"
    ><b>Description</b>
    <textarea class="full" name="attr_description" value=""></textarea>
  </label>
  <div class="macro-help">
    <label
      ><span><b>Row ID:</b></span>
      <input type="text" readonly name="attr_rowid" value=""
    /></label>
  </div>
</details>

        <!-- endinject -->
      </fieldset>
    </div>
  </div>

  <div class="bonuses">
    <div class="bonuses-container">
      <h3>Aggregated Bonuses</h3>
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Any combat modifiers you add on the Combat tab will appear as
            checkboxes. Toggling them will recalculate the bonuses for all
            checked items.
          </p>
          <p>
            Any Weapon Proficiencies you add on the WPs tab will appear on this
            page as well. Weapon Proficiencies <b>automatically</b> calculate
            their bonuses based on level, but no other skill (like Hand-to-Hand)
            does so yet.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. Damage adds everything together as a rollable field, and
            prompts to add Punch damage. Crit/Knockout/Death Blow use the lowest
            of the available options (ex. Crit: 17 is better than Crit: 19).
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <fieldset class="repeating_bonusselections">
          <label>
            <input type="checkbox" name="attr_enabled" value="1" />
            <span name="attr_name"></span
          ></label>
          <input type="hidden" name="attr_name" value="" />
          <input type="hidden" name="attr_bonus_id" value="" />
        </fieldset>
        <b>Selected IDs</b>
        <input class="full" type="text" name="attr_bonus_ids_output" value="" />
        <hr />
        <h3>Profiles</h3>
        <fieldset class="repeating_profileselections">
          <label>
            <input type="radio" name="attr_enabled" value="1" />
            <span name="attr_name"></span
          ></label>
          <input type="hidden" name="attr_name" value="" />
          <input type="hidden" name="attr_profile_id" value="" />
        </fieldset>
        <fieldset class="repeating_profiles">
          <!-- inject:partials/repeating_bonuses_details.html -->
          <details>
  <summary>
    <div class="bonus-thing-heading">
      <b class="click-expand"
        ><span title="Click for more info">&nbsp;&#9432;</span></b
      >
      <label
        ><span>Name</span>
        <input type="text" list="combat-modifiers" name="attr_name" />
      </label>
      <label
        ><span>Level</span>
        <input type="number" value="1" name="attr_level" />
      </label>
    </div>
  </summary>
  <div class="profile-management">
    <button type="action" name="act_copybonusids">Copy Selected IDs</button>
    <button type="action" name="act_checkbonusids">
      Apply this Profile to Selected IDs
    </button>
    <button type="action" name="act_updateprofile">Update Profile</button>
    <input type="text" class="full" name="attr_bonus_ids" />
    <input type="hidden" name="attr_bonus_names" />
    <span name="attr_bonus_names"></span>
  </div>
  <details class="default">
    <summary>
      <h3>Attributes</h3>
    </summary>
    <div class="bonus-type-container attributes">
      <label
        ><span>I.Q.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_iq"
          title="Intelligence Quotient"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_iq_abs" />|x|</label
        >
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_iq_bonus"
          title="+ Skills %"
          readonly
        />
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_perception_bonus"
          title="+ Perception (Rifter #13, p.16)"
          readonly
        />
      </label>
      <label
        ><span>M.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_me"
          title="Mental Endurance"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_me_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_me_bonus"
          title="+ Save vs. Psionics"
          readonly
        />
      </label>
      <label
        ><span>M.A.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ma"
          title="Mental Affinity"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ma_abs" />|x|</label
        >
        <input
          type="number"
          value="0"
          name="attr_mod_ma_bonus"
          title="% Trust/Intimidate"
          readonly
        />
      </label>
      <label
        ><span>P.S.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ps"
          title="Physical Strength"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ps_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_ps_bonus"
          title="+ SDC Damage"
          readonly
        />
      </label>
      <label
        ><span>P.P.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pp"
          title="Physical Prowess"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pp_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pp_bonus"
          title="+ Strike/Parry/Dodge/Entangle/Disarm"
          readonly
        />
      </label>
      <label
        ><span>P.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pe"
          title="Physical Endurance"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pe_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_bonus"
          title="+ Magic/Poison/Toxins"
          readonly
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_coma_bonus"
          title="+ Coma/Death %"
          readonly
        />
      </label>
      <label
        ><span>P.B.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pb"
          title="Physical Beauty"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pb_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pb_bonus"
          title="% Charm/Impress"
          readonly
        />
      </label>
      <label
        ><span>Spd</span>
        <input
          type="number"
          value="0"
          name="attr_mod_spd"
          title="Speed"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_spd_abs" />|x|</label
        ></label
      >
    </div>
    <hr />
    <div class="bonus-ps-container">
      <label class="select"
        ><span>PS Type</span>
        <select class="" name="attr_mod_ps_type" value="normal">
          <option value="1">Normal</option>
          <option value="2">Augmented</option>
          <option value="3">Robotic</option>
          <option value="4">Supernatural</option>
        </select></label
      >
      <label
        >Restrained Punch
        <input type="text" name="attr_rmod_estrained_punch" value="0" />
        <select name="attr_mod_restrained_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Punch
        <input type="text" name="attr_mod_punch" value="0" />
        <select name="attr_mod_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Power Punch
        <input type="text" name="attr_mod_power_punch" value="0" />
        <select name="attr_mod_power_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Kick
        <input type="text" name="attr_mod_kick" value="0" />
        <select name="attr_mod_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Leap Kick
        <input type="text" name="attr_mod_leap_kick" value="0" />
        <select name="attr_mod_leap_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>
      </label>

      <label
        >Lift
        <input type="number" value="0" name="attr_mod_lift" value="0" />
        <div></div>
      </label>

      <label
        >Carry
        <input type="number" value="0" name="attr_mod_carry" value="0" />
        <div></div
      ></label>

      <label
        >Throw
        <input type="number" value="0" name="attr_mod_throw" value="0" />
        <div></div
      ></label>

      <label
        >Carry Max
        <input type="number" value="0" name="attr_mod_carry_max" /><span
          >Minutes</span
        ></label
      >

      <label
        >Carry (Running)
        <input type="number" value="0" name="attr_mod_carry_running" /><span
          >Minutes</span
        ></label
      >

      <label
        >Hold Max.
        <input type="number" value="0" name="attr_mod_hold_max" /><span
          >Melees</span
        ></label
      >
    </div>
    <hr />
  </details>
  <div class="bonus-type-container">
    <label
      ><span title="Hit Points">H.P.</span
      ><input type="number" value="0" name="attr_hp"
    /></label>
    <label
      ><span>S.D.C.</span><input type="number" value="0" name="attr_sdc"
    /></label>
    <label
      ><span>A.R.</span><input type="number" value="0" name="attr_ar"
    /></label>
    <label
      ><span>M.D.C.</span><input type="number" value="0" name="attr_mdc"
    /></label>
    <label
      ><span>P.P.E.</span><input type="number" value="0" name="attr_ppe"
    /></label>
    <label
      ><span>I.S.P.</span><input type="number" value="0" name="attr_isp"
    /></label>
    <label
      ><span>H.F.</span
      ><input type="number" value="0" name="attr_mod_hf" /><label class="abs"
        ><input type="checkbox" value="1" name="attr_hf_abs" />|x|</label
      ></label
    >
  </div>
  <hr />
  <h3>Combat</h3>
  <div class="bonus-type-container">
    <label
      ><span>Attacks</span>
      <input type="number" value="0" name="attr_attacks" />
    </label>
    <label
      ><span>Initiative</span>
      <input type="number" value="0" name="attr_initiative" />
      <button type="roll" value="Initiative: [[d20+@{initiative}]]" />
    </label>
    <label
      ><span>Strike</span>
      <input type="number" value="0" name="attr_strike" />
      <button type="roll" value="Strike: [[d20+@{strike}]]" />
    </label>
    <label
      ><span>Parry</span>
      <input type="number" value="0" name="attr_parry" />
      <button type="roll" value="Parry: [[d20+@{parry}]]" />
    </label>
    <label
      ><span>Dodge</span>
      <input type="number" value="0" name="attr_dodge" />
      <button type="roll" value="Dodge: [[d20+@{dodge}]]" />
    </label>
    <label
      ><span>Throw</span>
      <input type="number" value="0" name="attr_throw" />
      <button type="roll" value="Throw: [[d20+@{throw}]]" />
    </label>
    <label
      ><span>Disarm</span>
      <input type="number" value="0" name="attr_disarm" />
      <button type="roll" value="Disarm: [[d20+@{disarm}]]" />
    </label>
    <label
      ><span>Entangle</span>
      <input type="number" value="0" name="attr_entangle" />
      <button type="roll" value="Entangle: [[d20+@{entangle}]]" />
    </label>
    <label
      ><span>Pull Punch</span>
      <input type="number" value="0" name="attr_pull" />
      <button type="roll" value="Pull Punch: [[d20+@{pull}]]" />
    </label>
    <label
      ><span>Roll w/ Impact</span>
      <input type="number" value="0" name="attr_roll" />
      <button type="roll" value="Roll w/ Impact: [[d20+@{roll}]]" />
    </label>
    <label
      ><span>Body Flip/Throw</span>
      <input type="number" value="0" name="attr_flipthrow" />
      <button type="roll" value="Body Flip/Throw: [[d20+@{flipthrow}]]" />
    </label>
    <label
      ><span>Damage</span>
      <input type="text" value="0" name="attr_damage" />
      <button
        type="roll"
        value="?{Add damage modifier?|
          None,Damage: [[@{damage}]]|
          Punch,Damage: [[@{damage}+@{punch}]]|
          P.S. Bonus,Damage: [[@{damage}+@{ps_bonus}]]
        }"
      />
    </label>
    <label
      ><span>Dodge: Flight</span>
      <input type="number" value="0" name="attr_dodge_flight" />
      <button type="roll" value="Dodge in Flight: [[d20+@{dodge_flight}]]" />
    </label>
    <label
      >Dodge: Auto
      <input type="number" value="0" name="attr_dodge_auto" />
      <button type="roll" value="Auto Dodge: [[d20+@{dodge_auto}]]" />
    </label>
    <label
      ><span>Dodge: Teleport</span>
      <input type="number" value="0" name="attr_dodge_teleport" />
      <button type="roll" value="Teleport Dodge: [[d20+@{dodge_teleport}]]" />
    </label>
    <label
      ><span>Dodge: Motion</span>
      <input type="number" value="0" name="attr_dodge_motion" />
      <button type="roll" value="Dodge in Motion: [[d20+@{dodge_motion}]]" />
    </label>
    <label
      ><span>Strike: Range</span>
      <input type="number" value="0" name="attr_strike_range" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range}]]" />
    </label>
    <label
      ><span>Range: Single</span>
      <input type="number" value="0" name="attr_strike_range_single" />
      <button
        type="roll"
        value="Range Strike: [[d20+@{strike_range_single}]]"
      />
    </label>
    <label
      ><span>Range: Burst</span>
      <input type="number" value="0" name="attr_strike_range_burst" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range_burst}]]" />
    </label>
    <label
      ><span>Range: Aimed</span>
      <input type="number" value="0" name="attr_strike_range_aimed" />
      <button
        type="roll"
        value="Range Aimed Strike: [[d20+@{strike_range_aimed}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_single"
      />
      <button
        type="roll"
        value="Range Aimed Single Strike: [[d20+@{strike_range_aimed_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Pulse Strike: [[d20+@{strike_range_aimed_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Called</span>
      <input type="number" value="0" name="attr_strike_range_called" />
      <button
        type="roll"
        value="Range Called Strike: [[d20+@{strike_range_called}]]"
      />
    </label>
    <label
      ><span>Range: Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_single"
      />
      <button
        type="roll"
        value="Range Called Single Strike: [[d20+@{strike_range_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_pulse"
      />
      <button
        type="roll"
        value="Range Called Pulse Strike: [[d20+@{strike_range_called_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_single"
      />
      <button
        type="roll"
        value="Range Aimed Called Single Strike: [[d20+@{strike_range_aimed_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Called Pulse Strike: [[d20+@{strike_range_aimed_called_pulse}]]"
      />
    </label>
    <label
      ><span>Disarm: Range</span>
      <input type="number" value="0" name="attr_disarm_range" />
      <button type="roll" value="Range Disarm: [[d20+@{disarm_range}]]" />
    </label>
    <label
      ><span>Damage: Range</span>
      <input type="text" value="0" name="attr_damage_range" />
      <button type="roll" value="Range Damage: [[@{damage_range}]]" />
    </label>
    <label
      ><span>Critical</span> <input type="number" value="" name="attr_critical"
    /></label>
    <label
      ><span>Knockout</span> <input type="number" value="" name="attr_knockout"
    /></label>
    <label
      ><span>Death Blow</span>
      <input type="number" value="0" name="attr_deathblow"
    /></label>
  </div>
  <hr />
  <h3>Saving Throws</h3>
  <div class="bonus-type-container">
    <label
      ><span>Perception</span>
      <input type="number" value="0" name="attr_perceptioncheck" />
      <button
        type="roll"
        value="Perception Check: [[d20+@{perceptioncheck}]]"
      />
    </label>
    <label
      ><span>Psionics</span>
      <input type="number" value="0" name="attr_psionics" />
      <button type="roll" value="Save vs. Psionics: [[d20+@{psionics}]]" />
    </label>
    <label
      ><span>Magic</span>
      <input type="number" value="0" name="attr_magic" />
      <button type="roll" value="Save vs. Magic: [[d20+@{magic}]]" />
    </label>
    <label
      ><span>Horror Factor</span>
      <input type="number" value="0" name="attr_horrorfactor" />
      <button
        type="roll"
        value="Save vs. Horror Factor: [[d20+@{horrorfactor}]]"
      />
    </label>
    <label
      ><span>Mind Control</span>
      <input type="number" value="0" name="attr_mindcontrol" />
      <button
        type="roll"
        value="Save vs. Mind Control: [[d20+@{mindcontrol}]]"
      />
    </label>
    <label
      ><span>Disease</span>
      <input type="number" value="0" name="attr_disease" />
      <button type="roll" value="Save vs. Disease: [[d20+@{disease}]]" />
    </label>
    <label
      ><span>Illusions</span>
      <input type="number" value="0" name="attr_illusions" />
      <button type="roll" value="Save vs. Illusions: [[d20+@{illusions}]]" />
    </label>
    <label
      ><span>Possession</span>
      <input type="number" value="0" name="attr_possession" />
      <button type="roll" value="Save vs. Possession: [[d20+@{possession}]]" />
    </label>
    <label
      ><span>Insanity</span>
      <input type="number" value="0" name="attr_insanity" />
      <button type="roll" value="Save vs. Insanity: [[d20+@{insanity}]]" />
    </label>
    <label
      ><span>Pain</span>
      <input type="number" value="0" name="attr_pain" />
      <button type="roll" value="Save vs. Pain: [[d20+@{pain}]]" />
    </label>
    <label
      ><span>Lethal Poison</span>
      <input type="number" value="0" name="attr_lethalpoison" />
      <button
        type="roll"
        value="Save vs. Lethal Poison: [[d20+@{lethalpoison}]]"
      />
    </label>
    <label
      ><span>Non-Lethal Poison</span>
      <input type="number" value="0" name="attr_nonlethalpoison" />
      <button
        type="roll"
        value="Save vs. Non-Lethal Poison: [[d20+@{nonlethalpoison}]]"
      />
    </label>
    <label
      ><span>Drugs</span>
      <input type="number" value="0" name="attr_drugs" />
      <button type="roll" value="Save vs. Drugs: [[d20+@{drugs}]]" />
    </label>
    <label
      ><span>Curses</span>
      <input type="number" value="0" name="attr_curses" />
      <button type="roll" value="Save vs. Curses: [[d20+@{curses}]]" />
    </label>
    <label
      ><span>Coma/Death</span>
      <input type="number" value="0" name="attr_comadeath" />
      <button type="roll" value="Save vs. Coma/Death: [[d100-@{comadeath}]]" />
    </label>
  </div>
  <label class="description"
    ><b>Description</b>
    <textarea class="full" name="attr_description" value=""></textarea>
  </label>
  <div class="macro-help">
    <label
      ><span><b>Row ID:</b></span>
      <input type="text" readonly name="attr_rowid" value=""
    /></label>
  </div>
</details>

          <!-- endinject -->
        </fieldset>
        <hr />
        <div class="hidden">
          <!-- inject:partials/combat_combined_melee.html -->
          <div class="combat-combined-bonuses">
  <label
    ><span>Attacks</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_attacks"
    />
  </label>
  <label
    ><span>S.D.C.</span
    ><input readonly type="number" value="0" name="attr_combat_combined_sdc"
  /></label>
  <label
    ><span>M.D.C.</span
    ><input readonly type="number" value="0" name="attr_combat_combined_mdc"
  /></label>
  <label
    ><span>Initiative</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_initiative"
    />
    <button
      type="roll"
      value="Initiative: [[d20+@{combat_combined_initiative} &{tracker}]]"
    />
  </label>
  <label
    ><span>Strike</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike"
    />
    <button type="roll" value="Strike: [[d20+@{combat_combined_strike}]]" />
  </label>
  <label
    ><span>Parry</span>
    <input readonly type="number" value="0" name="attr_combat_combined_parry" />
    <button type="roll" value="Parry: [[d20+@{combat_combined_parry}]]" />
  </label>
  <label
    ><span>Dodge</span>
    <input readonly type="number" value="0" name="attr_combat_combined_dodge" />
    <button type="roll" value="Dodge: [[d20+@{combat_combined_dodge}]]" />
  </label>
  <label
    ><span>Throw</span>
    <input readonly type="number" value="0" name="attr_combat_combined_throw" />
    <button type="roll" value="Throw: [[d20+@{combat_combined_throw}]]" />
  </label>
  <label
    ><span>Disarm</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_disarm"
    />
    <button type="roll" value="Disarm: [[d20+@{combat_combined_disarm}]]" />
  </label>
  <label
    ><span>Entangle</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_entangle"
    />
    <button type="roll" value="Entangle: [[d20+@{combat_combined_entangle}]]" />
  </label>
  <label
    ><span>Pull Punch</span>
    <input readonly type="number" value="0" name="attr_combat_combined_pull" />
    <button type="roll" value="Pull Punch: [[d20+@{combat_combined_pull}]]" />
  </label>
  <label
    ><span>Roll w/ Impact</span>
    <input readonly type="number" value="0" name="attr_combat_combined_roll" />
    <button
      type="roll"
      value="Roll w/ Impact: [[d20+@{combat_combined_roll}]]"
    />
  </label>
  <label
    ><span>Body Flip/Throw</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_flipthrow"
    />
    <button
      type="roll"
      value="Body Flip/Throw: [[d20+@{combat_combined_flipthrow}]]"
    />
  </label>
  <label
    ><span>Damage</span>
    <input readonly type="text" value="0" name="attr_combat_combined_damage" />
    <button
      type="roll"
      value="?{Add damage modifier?|
                None,Damage: [[@{combat_combined_damage}]]|
                Punch,Damage: [[@{combat_combined_damage}+@{punch}]]|
                P.S. Bonus,Damage: [[@{combat_combined_damage}+@{ps_bonus}]]
              }"
    />
  </label>
  <label
    ><span>Dodge: Flight</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_dodge_flight"
    />
    <button
      type="roll"
      value="Dodge in Flight: [[d20+@{combat_combined_dodge_flight}]]"
    />
  </label>
  <label
    ><span>Dodge: Auto</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_dodge_auto"
    />
    <button
      type="roll"
      value="Auto Dodge: [[d20+@{combat_combined_dodge_auto}]]"
    />
  </label>
  <label
    ><span>Dodge: Teleport</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_dodge_teleport"
    />
    <button
      type="roll"
      value="Teleport Dodge: [[d20+@{combat_combined_dodge_teleport}]]"
    />
  </label>
  <label
    ><span>Dodge: Motion</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_dodge_motion"
    />
    <button
      type="roll"
      value="Dodge in Motion: [[d20+@{combat_combined_dodge_motion}]]"
    />
  </label>
</div>
<hr />
<div class="combat-combined-bonuses">
  <label
    ><span>Critical</span>
    <input
      readonly
      type="number"
      value="20"
      name="attr_combat_combined_critical"
  /></label>
  <label
    ><span>Knockout</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_knockout"
  /></label>
  <label
    ><span>Death Blow</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_deathblow"
  /></label>
</div>

          <!-- endinject -->
          <hr />
          <!-- inject:partials/combat_combined_range.html -->
          <div class="combat-combined-bonuses">
  <label
    ><span>Strike: Range</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range"
    />
    <button
      type="roll"
      value="Range Strike: [[d20+@{combat_combined_strike_range}]]"
    />
  </label>
  <label
    ><span
      >Range: Single<span title="Includes Strike: Range">&nbsp;&#9432;</span>
    </span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_single"
    />
    <button
      type="roll"
      value="Range Strike - Single Shot: [[d20+@{combat_combined_strike_range_single}]]"
    />
  </label>
  <label
    ><span
      >Range: Burst
      <span title="Includes Strike: Range">&nbsp;&#9432;</span></span
    >
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_burst"
    />
    <button
      type="roll"
      value="Range Strike - Burst: [[d20+@{combat_combined_strike_range_burst}]]"
    />
  </label>
  <label
    ><span>Range: Aimed</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_aimed"
    />
    <button
      type="roll"
      value="Range Aimed Strike: [[d20+@{combat_combined_strike_range_aimed}]]"
    />
  </label>
  <label
    ><span
      >Range: Aimed Single<span title="Includes Range: Aimed"
        >&nbsp;&#9432;</span
      ></span
    >
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_aimed_single"
    />
    <button
      type="roll"
      value="Range Aimed Single Strike: [[d20+@{combat_combined_strike_range_aimed_single}]]"
    />
  </label>
  <label
    ><span
      >Range: Aimed Pulse<span title="Includes Range: Aimed"
        >&nbsp;&#9432;</span
      ></span
    >
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_aimed_pulse"
    />
    <button
      type="roll"
      value="Range Aimed Pulse Strike: [[d20+@{combat_combined_strike_range_aimed_pulse}]]"
    />
  </label>
  <label
    ><span>Range: Called</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_called"
    />
    <button
      type="roll"
      value="Range Called Strike: [[d20+@{combat_combined_strike_range_called}]]"
    />
  </label>
  <label
    ><span
      >Range: Called Single<span title="Includes Range: Called"
        >&nbsp;&#9432;</span
      ></span
    >
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_called_single"
    />
    <button
      type="roll"
      value="Range Called Single Strike: [[d20+@{combat_combined_strike_range_called_single}]]"
    />
  </label>
  <label
    ><span
      >Range: Called Pulse<span title="Includes Range: Called"
        >&nbsp;&#9432;</span
      ></span
    >
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_called_pulse"
    />
    <button
      type="roll"
      value="Range Called Pulse Strike: [[d20+@{combat_combined_strike_range_called_pulse}]]"
    />
  </label>
  <label
    ><span>Range: Aimed Called Single</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_aimed_called_single"
    />
    <button
      type="roll"
      value="Range Aimed Called Single Strike: [[d20+@{combat_combined_strike_range_aimed_called_single}]]"
    />
  </label>
  <label
    ><span>Range: Aimed Called Pulse</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_strike_range_aimed_called_pulse"
    />
    <button
      type="roll"
      value="Range Aimed Called Pulse Strike: [[d20+@{combat_combined_strike_range_aimed_called_pulse}]]"
    />
  </label>
  <label
    ><span>Disarm: Range</span>
    <input type="number" value="0" name="attr_combat_combined_disarm_range" />
    <button
      type="roll"
      value="?{Add Called Shot modifier|
                Called Single,Called Single Disarm: [[d20+@{combat_combined_disarm_range}+@{combat_combined_strike_range_called_single}]]|
                Called Pulse,Called Pulse Disarm: [[d20+@{combat_combined_disarm_range}+@{combat_combined_strike_range_called_pulse}]]|
                Aimed Called Single,Aimed Called Pulse Single: [[d20+@{combat_combined_disarm_range}+@{combat_combined_strike_range_aimed_called_single}]]|
                Aimed Called Pulse,Aimed Called Pulse Disarm: [[d20+@{combat_combined_disarm_range}+@{combat_combined_strike_range_aimed_called_pulse}]]
              }"
    />
  </label>
  <label
    ><span>Damage: Range</span>
    <input
      readonly
      type="text"
      value="0"
      name="attr_combat_combined_damage_range"
    />
    <button
      type="roll"
      value="Range Damage: [[@{combat_combined_damage_range}]]"
    />
  </label>
</div>

          <!-- endinject -->
          <hr />
          <!-- inject:partials/combat_combined_saving_throws.html -->
          <h4>Saving Throws</h4>
<div class="combat-combined-bonuses">
  <label
    ><span>Perception</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_perceptioncheck"
    />
    <button
      type="roll"
      value="Perception Check: [[d20+@{combat_combined_perceptioncheck}]]"
    />
  </label>
  <label
    ><span>Psionics</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_psionics"
    />
    <button
      type="roll"
      value="Save vs. Psionics: [[d20+@{combat_combined_psionics}]]"
    />
  </label>
  <label
    ><span>Magic</span>
    <input readonly type="number" value="0" name="attr_combat_combined_magic" />
    <button
      type="roll"
      value="Save vs. Magic: [[d20+@{combat_combined_magic}]]"
    />
  </label>
  <label
    ><span>Horror Factor</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_horrorfactor"
    />
    <button
      type="roll"
      value="Save vs. Horror Factor: [[d20+@{combat_combined_horrorfactor}]]"
    />
  </label>
  <label
    ><span>Mind Control</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_mindcontrol"
    />
    <button
      type="roll"
      value="Save vs. Mind Control: [[d20+@{combat_combined_mindcontrol}]]"
    />
  </label>
  <label
    ><span>Disease</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_disease"
    />
    <button
      type="roll"
      value="Save vs. Disease: [[{d20+@{combat_combined_disease}}>13]]"
    />
  </label>
  <label
    ><span>Illusions</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_illusions"
    />
    <button
      type="roll"
      value="Save vs. Illusions: [[d20+@{combat_combined_illusions}]]"
    />
  </label>
  <label
    ><span>Possession</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_possession"
    />
    <button
      type="roll"
      value="Save vs. Possession: [[d20+@{combat_combined_possession}]]"
    />
  </label>
  <label
    ><span>Insanity</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_insanity"
    />
    <button
      type="roll"
      value="Save vs. Insanity: [[d20+@{combat_combined_insanity}]]"
    />
  </label>
  <label
    ><span>Pain</span>
    <input readonly type="number" value="0" name="attr_combat_combined_pain" />
    <button
      type="roll"
      value="Save vs. Pain: [[d20+@{combat_combined_pain}]]"
    />
  </label>
  <label
    ><span>Lethal Poison</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_lethalpoison"
    />
    <button
      type="roll"
      value="Save vs. Lethal Poison: [[{d20+@{combat_combined_lethalpoison}}>13]]"
    />
  </label>
  <label
    ><span>Non-Lethal Poison</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_nonlethalpoison"
    />
    <button
      type="roll"
      value="Save vs. Non-Lethal Poison: [[{d20+@{combat_combined_nonlethalpoison}}>15]]"
    />
  </label>
  <label
    ><span>Drugs</span>
    <input readonly type="number" value="0" name="attr_combat_combined_drugs" />
    <button
      type="roll"
      value="Save vs. Drugs: [[{d20+@{combat_combined_drugs}}>14]]"
    />
  </label>
  <label
    ><span>Curses</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_curses"
    />
    <button
      type="roll"
      value="Save vs. Curses: [[{d20+@{combat_combined_curses}}>14]]"
    />
  </label>
  <label
    ><span>Coma/Death</span>
    <input
      readonly
      type="number"
      value="0"
      name="attr_combat_combined_comadeath"
    />
    <button
      type="roll"
      value="Save vs. Coma/Death: [[d100-@{combat_combined_comadeath}]]"
    />
  </label>
</div>

          <!-- endinject -->
        </div>
      </div>
      <div class="">
        <h3>Bonus Sources</h3>
        <fieldset class="repeating_bonuses">
          <input type="hidden" name="attr_selection_id" value="" />
          <!-- inject:partials/repeating_bonuses_details.html -->
          <details>
  <summary>
    <div class="bonus-thing-heading">
      <b class="click-expand"
        ><span title="Click for more info">&nbsp;&#9432;</span></b
      >
      <label
        ><span>Name</span>
        <input type="text" list="combat-modifiers" name="attr_name" />
      </label>
      <label
        ><span>Level</span>
        <input type="number" value="1" name="attr_level" />
      </label>
    </div>
  </summary>
  <div class="profile-management">
    <button type="action" name="act_copybonusids">Copy Selected IDs</button>
    <button type="action" name="act_checkbonusids">
      Apply this Profile to Selected IDs
    </button>
    <button type="action" name="act_updateprofile">Update Profile</button>
    <input type="text" class="full" name="attr_bonus_ids" />
    <input type="hidden" name="attr_bonus_names" />
    <span name="attr_bonus_names"></span>
  </div>
  <details class="default">
    <summary>
      <h3>Attributes</h3>
    </summary>
    <div class="bonus-type-container attributes">
      <label
        ><span>I.Q.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_iq"
          title="Intelligence Quotient"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_iq_abs" />|x|</label
        >
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_iq_bonus"
          title="+ Skills %"
          readonly
        />
        <input
          class="attribute-bonus"
          type="number"
          value="0"
          name="attr_mod_perception_bonus"
          title="+ Perception (Rifter #13, p.16)"
          readonly
        />
      </label>
      <label
        ><span>M.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_me"
          title="Mental Endurance"
        />
        <label class="abs"
          ><input type="checkbox" value="1" name="attr_me_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_me_bonus"
          title="+ Save vs. Psionics"
          readonly
        />
      </label>
      <label
        ><span>M.A.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ma"
          title="Mental Affinity"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ma_abs" />|x|</label
        >
        <input
          type="number"
          value="0"
          name="attr_mod_ma_bonus"
          title="% Trust/Intimidate"
          readonly
        />
      </label>
      <label
        ><span>P.S.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_ps"
          title="Physical Strength"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_ps_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_ps_bonus"
          title="+ SDC Damage"
          readonly
        />
      </label>
      <label
        ><span>P.P.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pp"
          title="Physical Prowess"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pp_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pp_bonus"
          title="+ Strike/Parry/Dodge/Entangle/Disarm"
          readonly
        />
      </label>
      <label
        ><span>P.E.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pe"
          title="Physical Endurance"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pe_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_bonus"
          title="+ Magic/Poison/Toxins"
          readonly
        />
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pe_coma_bonus"
          title="+ Coma/Death %"
          readonly
        />
      </label>
      <label
        ><span>P.B.</span>
        <input
          type="number"
          value="0"
          name="attr_mod_pb"
          title="Physical Beauty"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_pb_abs" />|x|</label
        >
        <input
          class="attribute"
          type="number"
          value="0"
          name="attr_mod_pb_bonus"
          title="% Charm/Impress"
          readonly
        />
      </label>
      <label
        ><span>Spd</span>
        <input
          type="number"
          value="0"
          name="attr_mod_spd"
          title="Speed"
        /><label class="abs"
          ><input type="checkbox" value="1" name="attr_spd_abs" />|x|</label
        ></label
      >
    </div>
    <hr />
    <div class="bonus-ps-container">
      <label class="select"
        ><span>PS Type</span>
        <select class="" name="attr_mod_ps_type" value="normal">
          <option value="1">Normal</option>
          <option value="2">Augmented</option>
          <option value="3">Robotic</option>
          <option value="4">Supernatural</option>
        </select></label
      >
      <label
        >Restrained Punch
        <input type="text" name="attr_rmod_estrained_punch" value="0" />
        <select name="attr_mod_restrained_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Punch
        <input type="text" name="attr_mod_punch" value="0" />
        <select name="attr_mod_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Power Punch
        <input type="text" name="attr_mod_power_punch" value="0" />
        <select name="attr_mod_power_punch_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Kick
        <input type="text" name="attr_mod_kick" value="0" />
        <select name="attr_mod_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select></label
      >

      <label
        >Leap Kick
        <input type="text" name="attr_mod_leap_kick" value="0" />
        <select name="attr_mod_leap_kick_unit" value="sdc">
          <option value="sdc">SDC</option>
          <option value="mdc">MDC</option>
        </select>
      </label>

      <label
        >Lift
        <input type="number" value="0" name="attr_mod_lift" value="0" />
        <div></div>
      </label>

      <label
        >Carry
        <input type="number" value="0" name="attr_mod_carry" value="0" />
        <div></div
      ></label>

      <label
        >Throw
        <input type="number" value="0" name="attr_mod_throw" value="0" />
        <div></div
      ></label>

      <label
        >Carry Max
        <input type="number" value="0" name="attr_mod_carry_max" /><span
          >Minutes</span
        ></label
      >

      <label
        >Carry (Running)
        <input type="number" value="0" name="attr_mod_carry_running" /><span
          >Minutes</span
        ></label
      >

      <label
        >Hold Max.
        <input type="number" value="0" name="attr_mod_hold_max" /><span
          >Melees</span
        ></label
      >
    </div>
    <hr />
  </details>
  <div class="bonus-type-container">
    <label
      ><span title="Hit Points">H.P.</span
      ><input type="number" value="0" name="attr_hp"
    /></label>
    <label
      ><span>S.D.C.</span><input type="number" value="0" name="attr_sdc"
    /></label>
    <label
      ><span>A.R.</span><input type="number" value="0" name="attr_ar"
    /></label>
    <label
      ><span>M.D.C.</span><input type="number" value="0" name="attr_mdc"
    /></label>
    <label
      ><span>P.P.E.</span><input type="number" value="0" name="attr_ppe"
    /></label>
    <label
      ><span>I.S.P.</span><input type="number" value="0" name="attr_isp"
    /></label>
    <label
      ><span>H.F.</span
      ><input type="number" value="0" name="attr_mod_hf" /><label class="abs"
        ><input type="checkbox" value="1" name="attr_hf_abs" />|x|</label
      ></label
    >
  </div>
  <hr />
  <h3>Combat</h3>
  <div class="bonus-type-container">
    <label
      ><span>Attacks</span>
      <input type="number" value="0" name="attr_attacks" />
    </label>
    <label
      ><span>Initiative</span>
      <input type="number" value="0" name="attr_initiative" />
      <button type="roll" value="Initiative: [[d20+@{initiative}]]" />
    </label>
    <label
      ><span>Strike</span>
      <input type="number" value="0" name="attr_strike" />
      <button type="roll" value="Strike: [[d20+@{strike}]]" />
    </label>
    <label
      ><span>Parry</span>
      <input type="number" value="0" name="attr_parry" />
      <button type="roll" value="Parry: [[d20+@{parry}]]" />
    </label>
    <label
      ><span>Dodge</span>
      <input type="number" value="0" name="attr_dodge" />
      <button type="roll" value="Dodge: [[d20+@{dodge}]]" />
    </label>
    <label
      ><span>Throw</span>
      <input type="number" value="0" name="attr_throw" />
      <button type="roll" value="Throw: [[d20+@{throw}]]" />
    </label>
    <label
      ><span>Disarm</span>
      <input type="number" value="0" name="attr_disarm" />
      <button type="roll" value="Disarm: [[d20+@{disarm}]]" />
    </label>
    <label
      ><span>Entangle</span>
      <input type="number" value="0" name="attr_entangle" />
      <button type="roll" value="Entangle: [[d20+@{entangle}]]" />
    </label>
    <label
      ><span>Pull Punch</span>
      <input type="number" value="0" name="attr_pull" />
      <button type="roll" value="Pull Punch: [[d20+@{pull}]]" />
    </label>
    <label
      ><span>Roll w/ Impact</span>
      <input type="number" value="0" name="attr_roll" />
      <button type="roll" value="Roll w/ Impact: [[d20+@{roll}]]" />
    </label>
    <label
      ><span>Body Flip/Throw</span>
      <input type="number" value="0" name="attr_flipthrow" />
      <button type="roll" value="Body Flip/Throw: [[d20+@{flipthrow}]]" />
    </label>
    <label
      ><span>Damage</span>
      <input type="text" value="0" name="attr_damage" />
      <button
        type="roll"
        value="?{Add damage modifier?|
          None,Damage: [[@{damage}]]|
          Punch,Damage: [[@{damage}+@{punch}]]|
          P.S. Bonus,Damage: [[@{damage}+@{ps_bonus}]]
        }"
      />
    </label>
    <label
      ><span>Dodge: Flight</span>
      <input type="number" value="0" name="attr_dodge_flight" />
      <button type="roll" value="Dodge in Flight: [[d20+@{dodge_flight}]]" />
    </label>
    <label
      >Dodge: Auto
      <input type="number" value="0" name="attr_dodge_auto" />
      <button type="roll" value="Auto Dodge: [[d20+@{dodge_auto}]]" />
    </label>
    <label
      ><span>Dodge: Teleport</span>
      <input type="number" value="0" name="attr_dodge_teleport" />
      <button type="roll" value="Teleport Dodge: [[d20+@{dodge_teleport}]]" />
    </label>
    <label
      ><span>Dodge: Motion</span>
      <input type="number" value="0" name="attr_dodge_motion" />
      <button type="roll" value="Dodge in Motion: [[d20+@{dodge_motion}]]" />
    </label>
    <label
      ><span>Strike: Range</span>
      <input type="number" value="0" name="attr_strike_range" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range}]]" />
    </label>
    <label
      ><span>Range: Single</span>
      <input type="number" value="0" name="attr_strike_range_single" />
      <button
        type="roll"
        value="Range Strike: [[d20+@{strike_range_single}]]"
      />
    </label>
    <label
      ><span>Range: Burst</span>
      <input type="number" value="0" name="attr_strike_range_burst" />
      <button type="roll" value="Range Strike: [[d20+@{strike_range_burst}]]" />
    </label>
    <label
      ><span>Range: Aimed</span>
      <input type="number" value="0" name="attr_strike_range_aimed" />
      <button
        type="roll"
        value="Range Aimed Strike: [[d20+@{strike_range_aimed}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_single"
      />
      <button
        type="roll"
        value="Range Aimed Single Strike: [[d20+@{strike_range_aimed_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Pulse Strike: [[d20+@{strike_range_aimed_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Called</span>
      <input type="number" value="0" name="attr_strike_range_called" />
      <button
        type="roll"
        value="Range Called Strike: [[d20+@{strike_range_called}]]"
      />
    </label>
    <label
      ><span>Range: Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_single"
      />
      <button
        type="roll"
        value="Range Called Single Strike: [[d20+@{strike_range_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_called_pulse"
      />
      <button
        type="roll"
        value="Range Called Pulse Strike: [[d20+@{strike_range_called_pulse}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Single</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_single"
      />
      <button
        type="roll"
        value="Range Aimed Called Single Strike: [[d20+@{strike_range_aimed_called_single}]]"
      />
    </label>
    <label
      ><span>Range: Aimed Called Pulse</span>
      <input
        readonly
        type="number"
        value="0"
        name="attr_strike_range_aimed_called_pulse"
      />
      <button
        type="roll"
        value="Range Aimed Called Pulse Strike: [[d20+@{strike_range_aimed_called_pulse}]]"
      />
    </label>
    <label
      ><span>Disarm: Range</span>
      <input type="number" value="0" name="attr_disarm_range" />
      <button type="roll" value="Range Disarm: [[d20+@{disarm_range}]]" />
    </label>
    <label
      ><span>Damage: Range</span>
      <input type="text" value="0" name="attr_damage_range" />
      <button type="roll" value="Range Damage: [[@{damage_range}]]" />
    </label>
    <label
      ><span>Critical</span> <input type="number" value="" name="attr_critical"
    /></label>
    <label
      ><span>Knockout</span> <input type="number" value="" name="attr_knockout"
    /></label>
    <label
      ><span>Death Blow</span>
      <input type="number" value="0" name="attr_deathblow"
    /></label>
  </div>
  <hr />
  <h3>Saving Throws</h3>
  <div class="bonus-type-container">
    <label
      ><span>Perception</span>
      <input type="number" value="0" name="attr_perceptioncheck" />
      <button
        type="roll"
        value="Perception Check: [[d20+@{perceptioncheck}]]"
      />
    </label>
    <label
      ><span>Psionics</span>
      <input type="number" value="0" name="attr_psionics" />
      <button type="roll" value="Save vs. Psionics: [[d20+@{psionics}]]" />
    </label>
    <label
      ><span>Magic</span>
      <input type="number" value="0" name="attr_magic" />
      <button type="roll" value="Save vs. Magic: [[d20+@{magic}]]" />
    </label>
    <label
      ><span>Horror Factor</span>
      <input type="number" value="0" name="attr_horrorfactor" />
      <button
        type="roll"
        value="Save vs. Horror Factor: [[d20+@{horrorfactor}]]"
      />
    </label>
    <label
      ><span>Mind Control</span>
      <input type="number" value="0" name="attr_mindcontrol" />
      <button
        type="roll"
        value="Save vs. Mind Control: [[d20+@{mindcontrol}]]"
      />
    </label>
    <label
      ><span>Disease</span>
      <input type="number" value="0" name="attr_disease" />
      <button type="roll" value="Save vs. Disease: [[d20+@{disease}]]" />
    </label>
    <label
      ><span>Illusions</span>
      <input type="number" value="0" name="attr_illusions" />
      <button type="roll" value="Save vs. Illusions: [[d20+@{illusions}]]" />
    </label>
    <label
      ><span>Possession</span>
      <input type="number" value="0" name="attr_possession" />
      <button type="roll" value="Save vs. Possession: [[d20+@{possession}]]" />
    </label>
    <label
      ><span>Insanity</span>
      <input type="number" value="0" name="attr_insanity" />
      <button type="roll" value="Save vs. Insanity: [[d20+@{insanity}]]" />
    </label>
    <label
      ><span>Pain</span>
      <input type="number" value="0" name="attr_pain" />
      <button type="roll" value="Save vs. Pain: [[d20+@{pain}]]" />
    </label>
    <label
      ><span>Lethal Poison</span>
      <input type="number" value="0" name="attr_lethalpoison" />
      <button
        type="roll"
        value="Save vs. Lethal Poison: [[d20+@{lethalpoison}]]"
      />
    </label>
    <label
      ><span>Non-Lethal Poison</span>
      <input type="number" value="0" name="attr_nonlethalpoison" />
      <button
        type="roll"
        value="Save vs. Non-Lethal Poison: [[d20+@{nonlethalpoison}]]"
      />
    </label>
    <label
      ><span>Drugs</span>
      <input type="number" value="0" name="attr_drugs" />
      <button type="roll" value="Save vs. Drugs: [[d20+@{drugs}]]" />
    </label>
    <label
      ><span>Curses</span>
      <input type="number" value="0" name="attr_curses" />
      <button type="roll" value="Save vs. Curses: [[d20+@{curses}]]" />
    </label>
    <label
      ><span>Coma/Death</span>
      <input type="number" value="0" name="attr_comadeath" />
      <button type="roll" value="Save vs. Coma/Death: [[d100-@{comadeath}]]" />
    </label>
  </div>
  <label class="description"
    ><b>Description</b>
    <textarea class="full" name="attr_description" value=""></textarea>
  </label>
  <div class="macro-help">
    <label
      ><span><b>Row ID:</b></span>
      <input type="text" readonly name="attr_rowid" value=""
    /></label>
  </div>
</details>

          <!-- endinject -->
        </fieldset>
      </div>
    </div>
  </div>

  <!-- inject:partials/skills.html -->
  <div class="skills">
  <h3>Skills</h3>
  <p>Note that skills include IQ bonus.</p>
  <fieldset class="repeating_skills">
    <details>
      <summary>
        <div class="values">
          <h5>Info</h5>
          <h5>Skill</h5>
          <h5>Category</h5>
          <h5>Base</h5>
          <h5>Bonus</h5>
          <h5>Per Level</h5>
          <h5>Level</h5>
          <h5>Total</h5>
          <h5></h5>
          <b class="click-expand"
            ><span title="Click for more info">&nbsp;&#9432;</span></b
          >
          <input type="text" value="" name="attr_name" />
          <select name="attr_category" value="occ">
            <option value="occ">O.C.C.</option>
            <option value="related">O.C.C. Related</option>
            <option value="secondary">Secondary</option>
          </select>
          <input type="number" value="0" name="attr_base" />
          <input type="number" value="0" name="attr_bonus" />
          <input type="number" value="0" name="attr_perlevel" />
          <input type="number" value="1" name="attr_level" />
          <input type="number" value="0" name="attr_total" readonly />
          <button
            type="roll"
            value="@{character_name} @{name} check: [[d100<@{total}]]"
          />
        </div>
      </summary>
      <textarea name="attr_description" value=""></textarea>
      <div class="macro-help">
        <label
          ><span><b>Row ID:</b></span>
          <input type="text" readonly name="attr_rowid" value=""
        /></label>
      </div>
    </details>
  </fieldset>
</div>

  <!-- endinject -->

  <!-- inject:partials/magic.html -->
  <div class="magic">
  <h3>Magic</h3>
  <details>
    <summary><b>Instructions</b></summary>
    <p>
      Enter a Spell name and its PPE. Optionally set the School and Spell Level.
      Then expand the Details, and fill in the applicable values. They will
      calculate and populate Range, Damage, Duration, and Skill if applicable.
    </p>
    <p>
      For Starting Damage and Damage per Level enter values that roll20 would
      use for dice rolls. Ex. "4d6", "1d6", etc.
    </p>
    <p>
      Press the Cast button to remove the PPE from the Current PPE input field.
      Click Reset PPE to set Current PPE back to the value on the Core tab. Note
      the roll button beside Damage and Skill.
    </p>
    <p>
      Don't forget to copy/paste the spell description into the Description
      field to make life easier for your GM. Also use that field for any macros
      you may need like Strike with an arbitrary bonus.
    </p>
  </details>
  <p>Click <b>Instructions</b> for detailed instructions.</p>
  <label
    ><span>Current P.P.E.</span>
    <input type="number" name="attr_currentppe" value="0" />
    <button type="action" name="act_resetppe">Reset P.P.E.</button>
  </label>
  <fieldset class="repeating_magic">
    <div class="spells-list">
      <h5>Spell</h5>
      <h5>Spell Level</h5>
      <h5>Range</h5>
      <h5>Duration</h5>
      <h5>Damage</h5>
      <h5></h5>
      <h5 title="Damage Capacity">D.C.</h5>
      <h5>Skill</h5>
      <h5></h5>
      <h5>P.P.E.</h5>
      <h5></h5>
      <input type="text" value="" name="attr_name" />
      <input type="number" value="1" name="attr_spell_level" />
      <input type="text" value="0" name="attr_range" />
      <input type="text" value="0" name="attr_duration" />
      <input type="text" value="0" name="attr_damage" />
      <button
        type="roll"
        value="@{character_name} @{name} [[@{damage}]] @{damage_unit}"
      />
      <input type="text" value="0" name="attr_dc" />
      <input type="number" value="0" name="attr_percentage" readonly />
      <button
        type="roll"
        value="@{character_name} @{name} check: [[d100<@{percentage}]]"
      />
      <input type="number" value="0" name="attr_ppe" />
      <button type="action" name="act_usespell">Cast</button>
    </div>
    <details>
      <summary>
        <b>Details for <span name="attr_name"></span></b>
      </summary>
      <div class="spell-details">
        <label
          ><span>Starting range</span
          ><input type="number" value="0" name="attr_range_starting"
        /></label>
        <label
          ><span>Range per level</span
          ><input type="number" value="0" name="attr_range_per_level"
        /></label>
        <label
          ><span>Range unit</span
          ><input
            type="text"
            value=""
            name="attr_range_unit"
            list="distance-units"
          />
        </label>
        <label
          ><span>Starting duration</span
          ><input type="number" value="0" name="attr_duration_starting"
        /></label>
        <label
          ><span>Duration per level</span
          ><input type="number" value="0" name="attr_duration_per_level"
        /></label>
        <label
          ><span>Duration unit</span
          ><input
            type="text"
            value=""
            name="attr_duration_unit"
            list="time-units"
          />
        </label>
        <label
          ><span>Starting damage</span
          ><input type="text" value="0" name="attr_damage_starting"
        /></label>
        <label
          ><span>Damage per level</span
          ><input type="text" value="0" name="attr_damage_per_level"
        /></label>
        <label
          ><span>Damage unit</span
          ><input
            type="text"
            value=""
            name="attr_damage_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting D.C.</span
          ><input type="number" value="0" name="attr_dc_starting"
        /></label>
        <label
          ><span>D.C. per level</span
          ><input type="number" value="0" name="attr_dc_per_level"
        /></label>
        <label
          ><span>D.C. unit</span
          ><input
            type="text"
            value=""
            name="attr_dc_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting skill %</span
          ><input type="number" value="0" name="attr_percentage_starting"
        /></label>
        <label
          ><span>Skill % per level</span
          ><input type="number" value="0" name="attr_percentage_per_level"
        /></label>
        <label
          ><span>School</span
          ><input
            type="text"
            value=""
            name="attr_school"
            list="spell-schools"
          />
        </label>
      </div>
      <label
        ><b>Description</b>
        <textarea class="full" name="attr_description" value=""></textarea>
      </label>
      <div class="macro-help">
        <label
          ><span><b>Row ID:</b></span>
          <input type="text" readonly name="attr_rowid" value=""
        /></label>
      </div>
    </details>
  </fieldset>
</div>

  <!-- endinject -->

  <!-- inject:partials/psionics.html -->
  <div class="psionics">
  <h3>Psionics</h3>
  <details>
    <summary><b>Instructions</b></summary>
    <p>
      Enter a Psionic name and its ISP. Then expand the Details, and fill in the
      applicable values. They will calculate and populate Range, Damage,
      Duration, and Skill if applicable.
    </p>
    <p>
      For Starting Damage and Damage per Level enter values that roll20 would
      use for dice rolls. Ex. "4d6", "1d6", etc.
    </p>
    <p>
      Press the Use button to remove the ISP from the Current ISP input field.
      Click Reset ISP to set Current ISP back to the value on the Core tab. Note
      the roll button beside Damage and Skill.
    </p>
    <p>
      Don't forget to copy/paste the power description into the Description
      field to make life easier for your GM. Also use that field for any macros
      you may need like Strike with an arbitrary bonus.
    </p>
  </details>
  <p>Click <b>Instructions</b> for detailed instructions.</p>
  <label
    ><span>Current I.S.P.</span>
    <input type="number" name="attr_currentisp" value="0" />
    <button type="action" name="act_resetisp">Reset I.S.P.</button>
  </label>
  <fieldset class="repeating_psionics">
    <div class="psionics-list">
      <h5>Psionic</h5>
      <h5>Range</h5>
      <h5>Duration</h5>
      <h5>Damage</h5>
      <h5></h5>
      <h5 title="Damage Capacity">D.C.</h5>
      <h5>Skill</h5>
      <h5></h5>
      <h5>I.S.P.</h5>
      <h5></h5>
      <input type="text" value="" name="attr_name" />
      <input type="text" value="0" name="attr_range" />
      <input type="text" value="0" name="attr_duration" />
      <input type="text" value="0" name="attr_damage" />
      <button
        type="roll"
        value="@{character_name} @{name} [[@{damage}]] @{damage_unit}"
      />
      <input type="text" value="0" name="attr_dc" />
      <input type="number" value="0" name="attr_percentage" readonly />
      <button
        type="roll"
        value="@{character_name} @{name} check: [[d100<@{percentage}]]"
      />
      <input type="number" value="0" name="attr_isp" />
      <button type="action" name="act_usepsionic">Use</button>
    </div>
    <details>
      <summary>
        <b>Details for <span name="attr_name"></span></b>
      </summary>
      <div class="psionic-details">
        <label
          ><span>Starting range</span
          ><input type="number" value="0" name="attr_range_starting"
        /></label>
        <label
          ><span>Range per level</span
          ><input type="number" value="0" name="attr_range_per_level"
        /></label>
        <label
          ><span>Range unit</span
          ><input
            type="text"
            value=""
            name="attr_range_unit"
            list="distance-units"
          />
        </label>
        <label
          ><span>Starting duration</span
          ><input type="number" value="0" name="attr_duration_starting"
        /></label>
        <label
          ><span>Duration per level</span
          ><input type="number" value="0" name="attr_duration_per_level"
        /></label>
        <label
          ><span>Duration unit</span
          ><input
            type="text"
            value=""
            name="attr_duration_unit"
            list="time-units"
          />
        </label>
        <label
          ><span>Starting damage</span
          ><input type="text" value="0" name="attr_damage_starting"
        /></label>
        <label
          ><span>Damage per level</span
          ><input type="text" value="0" name="attr_damage_per_level"
        /></label>
        <label
          ><span>Damage unit</span
          ><input
            type="text"
            value=""
            name="attr_damage_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting D.C.</span
          ><input type="number" value="0" name="attr_dc_starting"
        /></label>
        <label
          ><span>D.C. per level</span
          ><input type="number" value="0" name="attr_dc_per_level"
        /></label>
        <label
          ><span>D.C. unit</span
          ><input
            type="text"
            value=""
            name="attr_dc_unit"
            list="damage-units"
          />
        </label>
        <label
          ><span>Starting skill %</span
          ><input type="number" value="0" name="attr_percentage_starting"
        /></label>
        <label
          ><span>Skill % per level</span
          ><input type="number" value="0" name="attr_percentage_per_level"
        /></label>
        <label></label>
      </div>
      <label
        ><b>Description</b>
        <textarea class="full" name="attr_description" value=""></textarea>
      </label>
      <div class="macro-help">
        <label
          ><span><b>Row ID:</b></span>
          <input type="text" readonly name="attr_rowid" value=""
        /></label>
      </div>
    </details>
  </fieldset>
</div>

  <!-- endinject -->

  <div class="equipment">
    <h3>Equipment</h3>
    <p>Free form equipment list for now.</p>
    <textarea class="full tall" name="attr_equipment"></textarea>
  </div>

  <div class="importexport">
    <h3>Import/Export</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Click the <b>Export</b> button to get a JSON object representing your
        character. Paste a valid JSON object and click <b>Import</b> to import a
        character.
      </p>
      <p>
        In order to know what the valid fields are, complete all the fields with
        at least one of each repeating section and do an Export.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <button type="action" name="act_import">Import</button>
    <button type="action" name="act_export">Export</button>
    <textarea class="full tall" name="attr_importexport"></textarea>
  </div>
</main>
<script type="text/worker">
  // Change from javascript to worker before upload

  /* inject:js/async.js */
  function setActiveCharacterId(charId) {
  var oldAcid = getActiveCharacterId();
  var ev = new CustomEvent("message");
  ev.data = { id: "0", type: "setActiveCharacter", data: charId };
  self.dispatchEvent(ev);
  return oldAcid;
}
var _sIn = setInterval;
setInterval = function (callback, timeout) {
  var acid = getActiveCharacterId();
  _sIn(function () {
    var prevAcid = setActiveCharacterId(acid);
    callback();
    setActiveCharacterId(prevAcid);
  }, timeout);
};
var _sto = setTimeout;
setTimeout = function (callback, timeout) {
  var acid = getActiveCharacterId();
  _sto(function () {
    var prevAcid = setActiveCharacterId(acid);
    callback();
    setActiveCharacterId(prevAcid);
  }, timeout);
};
function getAttrsAsync(props) {
  var acid = getActiveCharacterId(); //save the current activeCharacterID in case it has changed when the promise runs
  var prevAcid = null; //local variable defined here, because it needs to be shared across the promise callbacks defined below
  return new Promise((resolve, reject) => {
    prevAcid = setActiveCharacterId(acid); //in case the activeCharacterId has changed, restore it to what we were expecting and save the current value to restore later
    try {
      getAttrs(props, (values) => {
        resolve(values);
      });
    } catch {
      reject();
    }
  }).finally(() => {
    setActiveCharacterId(prevAcid); //restore activeCharcterId to what it was when the promise first ran
  });
}
//use the same pattern for each of the following...
function setAttrsAsync(propObj, options) {
  var acid = getActiveCharacterId();
  var prevAcid = null;
  return new Promise((resolve, reject) => {
    prevAcid = setActiveCharacterId(acid);
    try {
      setAttrs(propObj, options, (values) => {
        resolve(values);
      });
    } catch {
      reject();
    }
  }).finally(() => {
    setActiveCharacterId(prevAcid);
  });
}

function getSectionIDsAsync(sectionName) {
  var acid = getActiveCharacterId();
  var prevAcid = null;
  return new Promise((resolve, reject) => {
    prevAcid = setActiveCharacterId(acid);
    try {
      getSectionIDs(sectionName, (values) => {
        resolve(values);
      });
    } catch {
      reject();
    }
  }).finally(() => {
    setActiveCharacterId(prevAcid);
  });
}
function getSingleAttrAsync(prop) {
  var acid = getActiveCharacterId();
  var prevAcid = null;
  return new Promise((resolve, reject) => {
    prevAcid = setActiveCharacterId(acid);
    try {
      getAttrs([prop], (values) => {
        resolve(values[prop]);
      });
    } catch {
      reject();
    }
  }).finally(() => {
    setActiveCharacterId(prevAcid);
  });
}

  /* endinject */

  /* inject:js/definitions.js */
  const WP = {
  "w.p. archery": [
    { strike: 1, parry: 1, rof: 2 },
    { strike: 1, disarm: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    { disarm: 1, rof: 1 },
    { strike: 1 },
    {},
    { strike: 1, rof: 1 },
    {},
    { strike: 1, disarm: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    { disarm: 1 },
  ],
  "w.p. axe": [
    {},
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
  ],
  "w.p. blunt": [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    { throw: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    {},
    { throw: 1 },
  ],
  "w.p. chain": [
    { strike: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    {},
  ],
  "w.p. forked": [
    { strike: 1, parry: 1, entangle: 1 },
    {},
    { strike: 1, parry: 1, entangle: 1 },
    { throw: 1 },
    { strike: 1, entangle: 1 },
    { parry: 1 },
    {},
    { strike: 1, entangle: 1 },
    {},
    { parry: 1, throw: 1 },
    { strike: 1, entangle: 1 },
    {},
    { strike: 1, parry: 1, entangle: 1 },
    {},
    { throw: 1 },
  ],
  "w.p. knife": [
    { parry: 1, throw: 1 },
    { strike: 1 },
    { parry: 1, throw: 1 },
    { strike: 1 },
    {},
    { parry: 1, throw: 1 },
    { strike: 1 },
    { throw: 1 },
    { parry: 1 },
    { strike: 1, throw: 1 },
    {},
    { parry: 1 },
    { strike: 1, throw: 1 },
    {},
    {},
  ],
  "w.p. grappling hook": [
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    {},
  ],
  "w.p. pole arm": [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    {},
  ],
  "w.p. rope": [
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    {},
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    {},
    {},
    { strike: 1 },
  ],
  "w.p. shield": [
    { parry: 1 },
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    { parry: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    {},
  ],
  "w.p. spear": [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    { throw: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    {},
  ],
  "w.p. staff": [
    { strike: 1 },
    { parry: 1 },
    { strike: 1 },
    {},
    { parry: 1, throw: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1, throw: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    { throw: 1 },
  ],
  "w.p. sword": [
    { strike: 1 },
    { parry: 1 },
    { strike: 1 },
    { parry: 1, throw: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    { throw: 1 },
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1, throw: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
  ],
  "w.p. targeting": [
    { strike: 1 },
    { damage: 1 },
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    { damage: 1 },
    {},
    { strike: 1 },
    {},
    {},
    {},
    {},
    {},
  ],
  "w.p. whip": [
    {},
    { strike: 1, entangle: 1, disarm: 1, damage: 1 },
    {},
    { strike: 1, entangle: 1, disarm: 1, damage: 1 },
    {},
    {},
    { strike: 1, entangle: 1, disarm: 1 },
    { damage: 1 },
    {},
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    { damage: 1 },
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    {},
  ],
  "w.p. handguns": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
  ],
  "w.p. rifles": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    {},
  ],
  "w.p. energy heavy": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
  ],
  "w.p. energy pistol": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
  ],
  "w.p. energy rifle": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
  ],
  "w.p. heavy": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
  ],
  "w.p. speargun": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1 },
  ],
  "w.p. shotgun": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
  ],
  "w.p. submachinegun": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
  ],
  "w.p. flamethrower": [
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1, strike_range_burst: 1 },
  ],
};

const WP_KEYS = {
  wp: [
    "name",
    "level",
    "strike",
    "parry",
    "disarm",
    "rof",
    "throw",
    "entangle",
  ],
  wpmodern: [
    "name",
    "level",
    "strike_range_single",
    "disarm",
    "strike_range_burst",
  ],
};

const ATTRIBUTE_KEYS = [
  "mod_iq",
  "iq_abs",
  "mod_iq_bonus",
  "mod_perception_bonus",
  "mod_me",
  "mod_me_bonus",
  "me_abs",
  "mod_ma",
  "mod_ma_bonus",
  "ma_abs",
  "mod_ps",
  "mod_ps_bonus",
  "ps_abs",
  "mod_pp",
  "mod_pp_bonus",
  "pp_abs",
  "mod_pe",
  "mod_pe_bonus",
  "mod_pe_coma_bonus",
  "pe_abs",
  "mod_pb",
  "mod_pb_bonus",
  "pb_abs",
  "mod_spd",
  "spd_abs",
  "mod_ps_type",
  "mod_restrained_punch",
  "mod_punch",
  "mod_power_punch",
  "mod_kick",
  "mod_leap_kick",
  "mod_lift",
  "mod_carry",
  "mod_throw",
  "mod_carry_max",
  "mod_carry_running",
  "mod_hold_max",
  "hp",
  "sdc",
  "ar",
  "mdc",
  "ps_type",
  "ppe",
  "isp",
  "mod_hf",
  "hf_abs",
];

const COMBAT_KEYS = [
  // "selection_id",
  "name",
  "level",
  "attacks",
  "sdc",
  "mdc",
  "initiative",
  "strike",
  "parry",
  "dodge",
  "throw",
  "disarm",
  "entangle",
  "pull",
  "roll",
  "damage",
  "dodge_flight",
  "dodge_auto",
  "dodge_teleport",
  "dodge_motion",
  "strike_range",
  "strike_range_single",
  "strike_range_burst",
  "strike_range_aimed",
  "strike_range_aimed_single",
  "strike_range_aimed_pulse",
  "strike_range_called",
  "strike_range_called_single",
  "strike_range_called_pulse",
  "strike_range_aimed_called_single",
  "strike_range_aimed_called_pulse",
  "disarm_range",
  "damage_range",
  "critical",
  "knockout",
  "deathblow",
  "flipthrow",
  "description",
];
const SAVE_KEYS_ATTRIBUTE_BONUSES = {
  me_bonus: ["psionics", "insanity"],
  pe_bonus: [
    "magic",
    "lethalpoison",
    "nonlethalpoison",
    "disease",
    "pain",
    "drugs",
  ],
  pe_coma_bonus: ["comadeath"],
  perception: ["perceptioncheck"],
  none: ["horrorfactor", "mindcontrol", "illusions", "possession", "curses"],
};
const SAVE_KEYS = Object.values(SAVE_KEYS_ATTRIBUTE_BONUSES).reduce(
  (acc, cur) => acc.concat(cur),
  []
);
const COMBAT_SAVE_KEYS = COMBAT_KEYS.concat(SAVE_KEYS, ATTRIBUTE_KEYS);
const SKILL_KEYS = ["name", "base", "bonus", "perlevel", "level", "total"];

const ABILITIES_REPEATERS = ["magic", "psionics", "abilities"];

const MAGIC_KEYS = [
  "name",
  "school",
  "spell_level",
  "range",
  "damage",
  "duration",
  "percentage",
  "ppe",
  "range_starting",
  "range_per_level",
  "range_units",
  "damage_starting",
  "damage_per_level",
  "damage_units",
  "dc_starting",
  "dc_per_level",
  "dc_units",
  "duration_starting",
  "duration_per_level",
  "duration_units",
  "percentage_starting",
  "percentage_per_level",
  "description",
];

const PSIONICS_KEYS = [
  "name",
  "range",
  "damage",
  "duration",
  "percentage",
  "isp",
  "range_starting",
  "range_per_level",
  "range_units",
  "damage_starting",
  "damage_per_level",
  "damage_units",
  "dc_starting",
  "dc_per_level",
  "dc_units",
  "duration_starting",
  "duration_per_level",
  "duration_units",
  "percentage_starting",
  "percentage_per_level",
  "description",
];

const ABILITIES_KEYS = [
  "name",
  "range",
  "damage",
  "duration",
  "percentage",
  "range_starting",
  "range_per_level",
  "range_units",
  "damage_starting",
  "damage_per_level",
  "damage_units",
  "dc_starting",
  "dc_per_level",
  "dc_units",
  "duration_starting",
  "duration_per_level",
  "duration_units",
  "frequency_starting",
  "frequency_per_level",
  "frequency_units",
  "percentage_starting",
  "percentage_per_level",
  "description",
];

const CORE_KEYS = [
  "character_name",
  "truename_name",
  "character_race",
  "occ",
  "character_ps_type",
  "character_level",
  "experience",
  "alignment",
  "character_age",
  "character_gender",
  "character_height",
  "character_weight",
  "character_familyorigin",
  "character_environment",
  "character_languages",
  "character_insanity",
  "character_disposition",
  "iq",
  "iq_bonus",
  "perception_bonus",
  "me",
  "me_bonus",
  "ma",
  "ma_bonus",
  "ps",
  "ps_bonus",
  "pp",
  "pp_bonus",
  "pe",
  "pe_bonus",
  "pe_coma_bonus",
  "pb",
  "pb_bonus",
  "spd",
  "trust_intimidate",
  "charm_impress",
  "restrained_punch",
  "restrained_punch_unit",
  "punch",
  "punch_unit",
  "power_punch",
  "power_punch_unit",
  "kick",
  "kick_unit",
  "leap_kick",
  "leap_kick_unit",
  "lift",
  "carry",
  "throw",
  "carry_max",
  "carry_running",
  "hold_max",
  "character_hp",
  "character_sdc",
  "character_ar",
  "character_mdc",
  "character_ppe",
  "character_isp",
  "hf",
  "perception",
  "run_mph",
  "run_ft_melee",
  "run_ft_attack",
  "run_cruising",
  "run_at_max",
  "leapup",
  "leapout",
  "equipment",
];

const MOVEMENT_KEYS = ["name", "mph", "ft_melee", "cruising", "dur_at_max"];

const EQUIPMENT_KEYS = ["equipment"];

const SECTIONS = {
  wp: WP_KEYS.wp,
  wpmodern: WP_KEYS.wpmodern,
  skills: SKILL_KEYS,
  combat: COMBAT_SAVE_KEYS, // deprecated
  modifiers: COMBAT_SAVE_KEYS,
  magic: MAGIC_KEYS,
  psionics: PSIONICS_KEYS,
  movement: MOVEMENT_KEYS,
  // equipment: EQUIPMENT_KEYS,
};

  /* endinject */

  /* inject:js/utils.js */
  /**
 * Aggregates repeating values
 * @param {string[]} destinations An array of field names to output to
 * @param {string} section A repeating section name
 * @param {string[]} fields An array of fields to aggregate into the associated destination
 * @param  {...any} extras Some extra stuff
 * If an extra is an object, it will be used for extendedProps.
 * Currently this only includes `callback` which gets run after `setAttrs()`
 */
async function repeatingSumAsync(destinations, section, fields, ...extras) {
  const isNumber = (value) => parseFloat(value).toString() === value.toString();
  const isOption = (value) =>
    [...checks.valid, ...checks.roundtypes].includes(value);
  const isRounding = (value) => checks.roundtypes.includes(value);
  const isFraction = (value) =>
    value.includes("/") && !(value.includes(",") || value.includes("|"));
  const getTrimmed = (value) => value.toLowerCase().replace(/\s/g, "");
  const getRounded = (type, value, pow) =>
    (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(
      Math.max(0, pow)
    );
  const getFraction = (value /*{ console.log(`value: ${value}`); */) =>
    parseInt(value.split("/")[0]) / parseInt(value.split("/")[1]);
  const getMultiplier = (value, rounding = 1) =>
    "undefined" === typeof value
      ? rounding
        ? 0
        : 1
      : isNumber(value)
      ? parseFloat(value)
      : isFraction(value)
      ? getFraction(value)
      : value;
  if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
  if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
  const fields_trimmed = fields.map((field) => getTrimmed(field).split(":")[0]);
  const subfields = fields_trimmed.slice(0, destinations.length);
  const checks = {
    valid: ["multiplier"],
    roundtypes: ["ceil", "round", "floor"],
  };
  let properties = { attributes: {}, options: {} };
  let extendedProps = {};
  extras.forEach((extra) => {
    if (extra.constructor.name === "Object") {
      extendedProps = extra;
      return;
    }
    const [prop, v] = getTrimmed(extra).split(":");
    const multiplier_maybe = getMultiplier(v, isRounding(prop));
    const obj = isNumber(multiplier_maybe)
      ? subfields.reduce((obj, field) => {
          obj[field] = multiplier_maybe;
          return obj;
        }, {})
      : multiplier_maybe.split(",").reduce((obj, item) => {
          const [stat, value] = item.split("|");
          const multiplier = getMultiplier(value, isRounding(prop));
          obj[stat] = multiplier;
          return obj;
        }, {});
    properties[isOption(prop) ? "options" : "attributes"][prop] = obj;
  });
  const idArray = await getSectionIDsAsync(`repeating_${section}`);
  const attrArray = idArray.reduce(
    (m, id) => [
      ...m,
      ...fields_trimmed.map((field) => `repeating_${section}_${id}_${field}`),
    ],
    []
  );
  let filteredAttrArray = attrArray;
  if (properties.attributes.filter) {
    filteredAttrArray = attrArray.filter((attr) =>
      Object.keys(properties.attributes.filter).some(
        (sectionId) => sectionId && attr.includes(sectionId)
      )
    );
  }
  const v = await getAttrsAsync([
    ...filteredAttrArray,
    ...Object.keys(properties.attributes),
  ]);
  const getValue = (section, id, field) =>
    v[`repeating_${section}_${id}_${field}`] === "on"
      ? 1
      : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
  const commonMultipliers =
    fields.length <= destinations.length
      ? []
      : fields.splice(destinations.length, fields.length - destinations.length);
  const output = destinations.reduce((obj, destination, index) => {
    let sumTotal = idArray.reduce(
      (total, id) =>
        total +
        getValue(section, id, fields_trimmed[index]) *
          commonMultipliers.reduce(
            (subtotal, mult) =>
              subtotal *
              (!mult.includes(":") ||
              mult.split(":")[1].split(",").includes(fields_trimmed[index])
                ? getValue(section, id, mult.split(":")[0])
                : 1),
            1
          ),
      0
    );
    sumTotal *=
      properties.options.hasOwnProperty("multiplier") &&
      Object.keys(properties.options.multiplier).includes(fields_trimmed[index])
        ? parseFloat(properties.options.multiplier[fields_trimmed[index]]) || 0
        : 1;
    sumTotal += Object.entries(properties.attributes).reduce(
      (total, [key, value]) =>
        (total += value.hasOwnProperty(fields_trimmed[index])
          ? parseFloat(v[key] || 0) *
            (parseFloat(value[fields_trimmed[index]]) || 1)
          : 0),
      0
    );
    checks.roundtypes.forEach((type) => {
      if (properties.options.hasOwnProperty(type)) {
        if (
          Object.keys(properties.options[type]).includes(fields_trimmed[index])
        ) {
          sumTotal = getRounded(
            type,
            sumTotal,
            +properties.options[type][fields_trimmed[index]] || 0
          );
        } else if (
          properties.options[type] == "0" ||
          !isNaN(+properties.options[type] || "x")
        ) {
          sumTotal = getRounded(type, sumTotal, +properties.options[type]);
        }
      }
    });
    obj[destination] = sumTotal;
    return obj;
  }, {});
  await setAttrsAsync(output);
}

/**
 * Aggregates repeating values
 * @param {string[]} destinations An array of field names to output to
 * @param {string} section A repeating section name
 * @param {string[]} fields An array of fields to aggregate into the associated destination
 * @param  {...any} extras Some extra stuff
 * If an extra is an object, it will be used for extendedProps.
 * Currently this only includes `callback` which gets run after `setAttrs()`
 */
function repeatingSum(destinations, section, fields, ...extras) {
  const isNumber = (value) => parseFloat(value).toString() === value.toString();
  const isOption = (value) =>
    [...checks.valid, ...checks.roundtypes].includes(value);
  const isRounding = (value) => checks.roundtypes.includes(value);
  const isFraction = (value) =>
    value.includes("/") && !(value.includes(",") || value.includes("|"));
  const getTrimmed = (value) => value.toLowerCase().replace(/\s/g, "");
  const getRounded = (type, value, pow) =>
    (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(
      Math.max(0, pow)
    );
  const getFraction = (value /*{ console.log(`value: ${value}`); */) =>
    parseInt(value.split("/")[0]) / parseInt(value.split("/")[1]);
  const getMultiplier = (value, rounding = 1) =>
    "undefined" === typeof value
      ? rounding
        ? 0
        : 1
      : isNumber(value)
      ? parseFloat(value)
      : isFraction(value)
      ? getFraction(value)
      : value;
  if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
  if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
  const fields_trimmed = fields.map((field) => getTrimmed(field).split(":")[0]);
  const subfields = fields_trimmed.slice(0, destinations.length);
  const checks = {
    valid: ["multiplier"],
    roundtypes: ["ceil", "round", "floor"],
  };
  let properties = { attributes: {}, options: {} };
  let extendedProps = {};
  extras.forEach((extra) => {
    if (extra.constructor.name === "Object") {
      extendedProps = extra;
      return;
    }
    const [prop, v] = getTrimmed(extra).split(":");
    const multiplier_maybe = getMultiplier(v, isRounding(prop));
    const obj = isNumber(multiplier_maybe)
      ? subfields.reduce((obj, field) => {
          obj[field] = multiplier_maybe;
          return obj;
        }, {})
      : multiplier_maybe.split(",").reduce((obj, item) => {
          const [stat, value] = item.split("|");
          const multiplier = getMultiplier(value, isRounding(prop));
          obj[stat] = multiplier;
          return obj;
        }, {});
    properties[isOption(prop) ? "options" : "attributes"][prop] = obj;
  });
  getSectionIDs(`repeating_${section}`, (idArray) => {
    const attrArray = idArray.reduce(
      (m, id) => [
        ...m,
        ...fields_trimmed.map((field) => `repeating_${section}_${id}_${field}`),
      ],
      []
    );
    let filteredAttrArray = attrArray;
    if (properties.attributes.filter) {
      filteredAttrArray = attrArray.filter((attr) =>
        Object.keys(properties.attributes.filter).some(
          (sectionId) => sectionId && attr.includes(sectionId)
        )
      );
    }
    getAttrs(
      [...filteredAttrArray, ...Object.keys(properties.attributes)],
      (v) => {
        const getValue = (section, id, field) =>
          v[`repeating_${section}_${id}_${field}`] === "on"
            ? 1
            : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
        const commonMultipliers =
          fields.length <= destinations.length
            ? []
            : fields.splice(
                destinations.length,
                fields.length - destinations.length
              );
        const output = destinations.reduce((obj, destination, index) => {
          let sumTotal = idArray.reduce(
            (total, id) =>
              total +
              getValue(section, id, fields_trimmed[index]) *
                commonMultipliers.reduce(
                  (subtotal, mult) =>
                    subtotal *
                    (!mult.includes(":") ||
                    mult
                      .split(":")[1]
                      .split(",")
                      .includes(fields_trimmed[index])
                      ? getValue(section, id, mult.split(":")[0])
                      : 1),
                  1
                ),
            0
          );
          sumTotal *=
            properties.options.hasOwnProperty("multiplier") &&
            Object.keys(properties.options.multiplier).includes(
              fields_trimmed[index]
            )
              ? parseFloat(
                  properties.options.multiplier[fields_trimmed[index]]
                ) || 0
              : 1;
          sumTotal += Object.entries(properties.attributes).reduce(
            (total, [key, value]) =>
              (total += value.hasOwnProperty(fields_trimmed[index])
                ? parseFloat(v[key] || 0) *
                  (parseFloat(value[fields_trimmed[index]]) || 1)
                : 0),
            0
          );
          checks.roundtypes.forEach((type) => {
            if (properties.options.hasOwnProperty(type)) {
              if (
                Object.keys(properties.options[type]).includes(
                  fields_trimmed[index]
                )
              ) {
                sumTotal = getRounded(
                  type,
                  sumTotal,
                  +properties.options[type][fields_trimmed[index]] || 0
                );
              } else if (
                properties.options[type] == "0" ||
                !isNaN(+properties.options[type] || "x")
              ) {
                sumTotal = getRounded(
                  type,
                  sumTotal,
                  +properties.options[type]
                );
              }
            }
          });
          obj[destination] = sumTotal;
          return obj;
        }, {});
        setAttrs(
          output,
          {},
          extendedProps.callback ? extendedProps.callback : () => {}
        );
      }
    );
  });
}

async function repeatingPickBestAsync({
  destinations,
  section,
  fields,
  defaultValues,
  ranks,
  filter,
}) {
  console.log("repeatingPickBestAsync", {
    destinations,
    section,
    fields,
    defaultValues,
    ranks,
    filter,
  });
  const sectionIds = await getSectionIDsAsync(`repeating_${section}`);
  const attrArray = sectionIds.reduce(
    (m, id) => [
      ...m,
      ...fields.map((field) => `repeating_${section}_${id}_${field}`),
    ],
    []
  );
  let filteredAttrArray = attrArray;
  if (filter) {
    filteredAttrArray = attrArray.filter((attr) =>
      filter.some((sectionId) => sectionId && attr.includes(sectionId))
    );
  }
  const a = await getAttrsAsync(filteredAttrArray);
  const output = destinations.reduce((acc, cur, i) => {
    acc[cur] = Object.keys(a)
      .filter((val) => {
        // the 4th part of `val` needs to match fields[i]
        const [, , , ...attrParts] = val.split("_");
        const attr = attrParts.join("_");
        return attr == fields[i];
      })
      .reduce((accVal, attrCur) => {
        if (+a[attrCur] == 0) {
          return accVal;
        }

        if (+accVal != 0) {
          if (ranks[i] === "high") {
            return +a[attrCur] > +accVal ? a[attrCur] : accVal;
          } else {
            return +a[attrCur] < +accVal ? a[attrCur] : accVal;
          }
        } else {
          return a[attrCur];
        }
      }, defaultValues[i]);
    return acc;
  }, {});
  await setAttrsAsync(output);
}

async function repeatingStringConcatAsync({
  destinations,
  section,
  fields,
  filter,
}) {
  console.log({
    destinations,
    section,
    fields,
    filter,
  });
  const sectionIds = await getSectionIDsAsync(`repeating_${section}`);
  const attrArray = sectionIds.reduce(
    (m, id) => [
      ...m,
      ...fields.map((field) => `repeating_${section}_${id}_${field}`),
    ],
    []
  );
  let filteredAttrArray = attrArray;
  if (filter) {
    filteredAttrArray = attrArray.filter((attr) =>
      filter.some((sectionId) => sectionId && attr.includes(sectionId))
    );
  }
  const a = await getAttrsAsync(filteredAttrArray);
  const output = destinations.reduce((acc, cur, i) => {
    acc[cur] = Object.keys(a)
      .filter((val) => {
        // the 4th part of `val` needs to match fields[i]
        const [, , , ...attrParts] = val.split("_");
        const attr = attrParts.join("_");
        return attr == fields[i];
      })
      .reduce((attrAcc, attrCur) => {
        return a[attrCur] == "" || a[attrCur] == "0"
          ? attrAcc
          : `${a[attrCur]}+${attrAcc}`.replace(/\+$/, "");
      }, "");
    return acc;
  }, {});
  await setAttrsAsync(output);
}

function getBiAttributeBonus(attr) {
  const bonus = attr > 15 ? Math.ceil((Math.min(attr, 30) - 15) / 2) : 0;
  return bonus;
}

function mergeAndAddObjects(data) {
  const result = {};
  data.forEach((obj) => {
    for (let [key, value] of Object.entries(obj)) {
      if (result[key]) {
        result[key] += value;
      } else {
        result[key] = value;
      }
    }
  });
  return result;
}

  /* endinject */

  /* inject:js/bonuses.js */
  /**
 * @todo same issue as in movement.js - which profile takes precedence?
 */
on("change:repeating_profiles:attacks", async (e) => {
  console.log("change:repeating_profiles:attacks", e);
  const movementIds = await getSectionIDsAsync("movement");
  const attrNames = movementIds.map(
    (id) => `repeating_movement_${id}_ft_melee`
  );
  const attrs = {};
  const a = await getAttrsAsync(attrNames.concat(["run_ft_melee"]));
  attrs.run_ft_attack = Math.round(a.run_ft_melee / e.newValue);
  movementIds.forEach((id) => {
    const row = `repeating_movement_${id}`;
    const feetPerMelee = a[`${row}_ft_melee`] || 0;
    if (feetPerMelee) {
      attrs[`${row}_ft_attack`] = Math.round(feetPerMelee / e.newValue);
    }
  });
  await setAttrsAsync(attrs);
});

async function addStrikeRangeToCombinedAsync(rowPrefix) {
  console.log("addStrikeRangeToCombinedAsync", rowPrefix);
  const a = await getAttrsAsync([
    `${rowPrefix}_strike_range`,
    `${rowPrefix}_strike_range_single`,
    `${rowPrefix}_strike_range_burst`,
    `${rowPrefix}_strike_range_aimed`,
    `${rowPrefix}_strike_range_called`,
  ]);
  const strikeRangeSingle =
    +a[`${rowPrefix}_strike_range`] + +a[`${rowPrefix}_strike_range_single`];
  const strikeRangeBurst =
    +a[`${rowPrefix}_strike_range`] + +a[`${rowPrefix}_strike_range_burst`];
  const strikeRangeAimedSingle =
    strikeRangeSingle + +a[`${rowPrefix}_strike_range_aimed`] + 2;
  const strikeRangeAimedPulse = Math.floor(strikeRangeAimedSingle / 2);
  const strikeRangeCalledSingle =
    strikeRangeSingle + a[`${rowPrefix}_strike_range_called`];
  const strikeRangeCalledPulse = Math.floor(strikeRangeCalledSingle / 2);
  const strikeRangeAimedCalledSingle =
    strikeRangeAimedSingle + +a[`${rowPrefix}_strike_range_called`];
  const strikeRangeAimedCalledPulse = Math.floor(
    strikeRangeAimedCalledSingle / 2
  );
  const attrs = {
    [`${rowPrefix}_strike_range_single`]: strikeRangeSingle,
    [`${rowPrefix}_strike_range_burst`]: strikeRangeBurst,
    [`${rowPrefix}_strike_range_aimed_single`]: strikeRangeAimedSingle,
    [`${rowPrefix}_strike_range_aimed_pulse`]: strikeRangeAimedPulse,
    [`${rowPrefix}_strike_range_called_single`]: strikeRangeCalledSingle,
    [`${rowPrefix}_strike_range_called_pulse`]: strikeRangeCalledPulse,
    [`${rowPrefix}_strike_range_aimed_called_single`]:
      strikeRangeAimedCalledSingle,
    [`${rowPrefix}_strike_range_aimed_called_pulse`]:
      strikeRangeAimedCalledPulse,
  };
  console.log(attrs);
  await setAttrsAsync(attrs);
}

async function repeatingAbsoluteAttributes(rowIds, destinationPrefix) {
  console.log("repeatingAbsoluteAttributes", rowIds, destinationPrefix);
  const fields = ["iq", "me", "ma", "ps", "pp", "pe", "pb", "spd", "hf"];
  const fieldNames = rowIds.reduce((acc, rowId) => {
    const absFieldNames = fields.map(
      (f) => `repeating_bonuses_${rowId}_${f}_abs`
    );
    const attFieldNames = fields.map(
      (f) => `repeating_bonuses_${rowId}_mod_${f}`
    );
    return acc.concat(absFieldNames, attFieldNames);
  }, []);
  const a = await getAttrsAsync(fieldNames);

  fields.forEach(async (field) => {
    let fieldAbsValue = null;
    rowIds.forEach((rowId) => {
      const rowFieldAbs = a[`repeating_bonuses_${rowId}_${field}_abs`];
      if (Boolean(Number(rowFieldAbs)) == true) {
        rowFieldValue = a[`repeating_bonuses_${rowId}_mod_${field}`];
        fieldAbsValue =
          fieldAbsValue > rowFieldValue ? fieldAbsValue : rowFieldValue;
      }
    });
    if (fieldAbsValue) {
      // compare the modified absolute value against the original attribute
      const coreValue = (await getAttrsAsync([field]))[field];
      const newValue = coreValue > fieldAbsValue ? coreValue : fieldAbsValue;
      const attr = {
        [`${destinationPrefix}_mod_${field}`]: newValue,
      };
      await setAttrsAsync(attr);
    } else {
      // repeatingSum
      const rsaDestinations = [`${destinationPrefix}_mod_${field}`];
      const rsaFields = [`mod_${field}`];
      await repeatingSumAsync(
        rsaDestinations,
        "bonuses",
        rsaFields,
        `filter:${rowIds.toString()}`,
        field
      );
    }
  });
}

async function combineBonuses(rowIds, destinationPrefix) {
  // we need to combine the values of each repeated attribute within
  // each of the sectionIds and aggregate them in the combined combat section
  // +PP +PS, and add a saving throws section with +ME +PE

  console.log("combineBonuses", rowIds, destinationPrefix);

  await repeatingAbsoluteAttributes(rowIds, destinationPrefix);

  await repeatingStringConcatAsync({
    destinations: [
      `${destinationPrefix}_damage`,
      `${destinationPrefix}_damage_range`,
    ],
    section: "bonuses",
    fields: ["damage", "damage_range"],
    filter: rowIds,
  });

  const pickBestFields = [
    "ar",
    "hf",
    "ps_type",
    "critical",
    "knockout",
    "deathblow",
  ];
  const psType = (await getAttrsAsync(["character_ps_type"])).character_ps_type;
  await repeatingPickBestAsync({
    destinations: pickBestFields.map(
      (field) => `${destinationPrefix}_${field}`
    ),
    section: "bonuses",
    fields: pickBestFields,
    defaultValues: [0, 0, psType, 20, 0, 0],
    ranks: ["high", "high", "high", "low", "low", "low"],
    filter: rowIds,
  });

  const noAttributeBonusFields = [
    "hp",
    "sdc",
    "mdc",
    "ppe",
    "isp",
    "attacks",
    "initiative",
    "pull",
    "roll",
    "strike_range",
    "strike_range_single",
    "strike_range_burst",
    "strike_range_aimed",
    "strike_range_called",
    "disarm_range",
  ];
  // No attribute bonuses.
  await repeatingSumAsync(
    noAttributeBonusFields.map((field) => `${destinationPrefix}_${field}`),
    "bonuses",
    noAttributeBonusFields,
    `filter:${rowIds.toString()}`
  );
  await addStrikeRangeToCombinedAsync(destinationPrefix);

  const ppBonusFields = [
    "strike",
    "parry",
    "dodge",
    "throw",
    "disarm",
    "entangle",
    "dodge_flight",
    "dodge_auto",
    "dodge_teleport",
    "dodge_motion",
    "flipthrow",
  ];
  await repeatingSumAsync(
    ppBonusFields.map((field) => `${destinationPrefix}_${field}`),
    "bonuses",
    ppBonusFields,
    `filter:${rowIds.toString()}`,
    "pp_bonus"
  );

  // Saving Throws
  Object.entries(SAVE_KEYS_ATTRIBUTE_BONUSES).forEach(
    async ([attributeBonus, saves]) => {
      const destinations = saves.map((save) => `${destinationPrefix}_${save}`);
      const section = "bonuses";
      const fields = saves;
      await repeatingSumAsync(
        destinations,
        section,
        fields,
        `filter:${rowIds.toString()}`,
        attributeBonus
      );
    }
  );
}

function removeBonusSelectionsRow(bonusRowId, callback = null) {
  getAttrs([`repeating_bonuses_${bonusRowId}_selection_id`], (a) => {
    removeRepeatingRow(
      `repeating_bonusselections_${
        a[`repeating_bonuses_${bonusRowId}_selection_id`]
      }`
    );
    if (typeof callback == "function") {
      callback();
    }
  });
}

function removeBonusRows(bonusRowId, callback = null) {
  removeBonusSelectionsRow(bonusRowId, () => {
    removeRepeatingRow(`repeating_bonuses_${bonusRowId}`);
    if (typeof callback == "function") {
      callback();
    }
  });
}

on("remove:repeating_wp remove:repeating_wpmodern", (e) => {
  console.log("remove wp", e);
  // const [r, section, rowId] = e.sourceAttribute.split('_');
  const bonusRowId = e.removedInfo[`${e.sourceAttribute}_bonus_id`];
  removeBonusRows(bonusRowId);
});

on("remove:repeating_bonuses", (e) => {
  console.log("remove:repeating_bonuses", e);
  // remove repeating_selections row with the same index
  const bonusRowId = e.removedInfo[`${e.sourceAttribute}_bonus_id`];
  // removeBonusSelectionsRow(bonusRowId);
});

on("change:_reorder:combat", (e) => {
  // reorder repeating_bonusselections to match
  console.log("change:_reorder:combat", e);
});

async function outputSelectedBonusIds() {
  const bonusselectionsIds = await getSectionIDsAsync("bonusselections");
  const checkboxNames = bonusselectionsIds.map(
    (id) => `repeating_bonusselections_${id}_enabled`
  );
  const bonusIdNames = bonusselectionsIds.map(
    (id) => `repeating_bonusselections_${id}_bonus_id`
  );
  const attrNames = checkboxNames.concat(bonusIdNames);
  const a = await getAttrsAsync(attrNames);
  const bonusRowIds = bonusselectionsIds.reduce((acc, id) => {
    const prefix = `repeating_bonusselections_${id}`;
    if (Boolean(Number(a[`${prefix}_enabled`])) == true) {
      acc.push(a[`${prefix}_bonus_id`]);
    }
    return acc;
  }, []);
  await setAttrsAsync({ bonus_ids_output: bonusRowIds.toString() });
}

on("change:repeating_bonusselections:enabled", async (e) => {
  console.log("change:repeating_bonusselections:enabled", e);
  outputSelectedBonusIds();
});

/**
 * Not done!
 * @param {*} name
 * @param {*} prefix
 * @param {*} refRowId
 */
function insertSelection(name, prefix, refRowId) {
  console.log("insertSelection", name, prefix, rowId);
  const selectionRowId = generateRowID();
  const attrs = {};
  attrs[`${prefix}_${selectionRowId}_ref_id`] = refRowId;
  attrs[`${prefix}_${selectionRowId}_name`] = name;
}

function insertSelectionSync(name, bonusRowId) {
  console.log("insertSelection", name, bonusRowId);
  const selectionRowId = generateRowID();
  const attrs = {};
  attrs[`repeating_bonusselections_${selectionRowId}_bonus_id`] = bonusRowId;
  attrs[`repeating_bonusselections_${selectionRowId}_name`] = name;
  attrs[`repeating_bonuses_${bonusRowId}_selection_id`] = selectionRowId;
  console.log(attrs);
  setAttrs(attrs);
}

async function updateSelection(name, prefix) {
  console.log("updateSelection", name, prefix);
  const attrs = {};
  attrs[`${prefix}_name`] = name;
  await setAttrsAsync(attrs);
}

function updateSelectionSync(name, selectionRowId) {
  console.log("updateSelectionSync", selectionRowId, name);
  const attrs = {};
  attrs[`repeating_bonusselections_${selectionRowId}_name`] = name;
  setAttrs(attrs);
}

on("change:repeating_bonuses:name", (e) => {
  console.log("change:repeating_bonuses:name", e);
  const [r, section, rowId] = e.sourceAttribute.split("_");
  const selectionIdKey = `repeating_bonuses_${rowId}_selection_id`;
  getAttrs([selectionIdKey], (a) => {
    console.log(a);
    if (a[selectionIdKey]) {
      updateSelectionSync(e.newValue, a[selectionIdKey]);
    } else {
      insertSelectionSync(e.newValue, rowId);
    }
  });
});

on("change:repeating_profiles:name", async (e) => {
  console.log("change:repeating_profiles:name", e);
  const [r, section, rowId] = e.sourceAttribute.split("_");
  const selectionIdKey = `${r}_${section}_${rowId}_selection_id`;
  const a = await getAttrsAsync([selectionIdKey]);
  console.log(a);
  // ???
});

on("change:repeating_profiles:mod_iq", async (e) => {
  console.log("change:repeating_profiles:mod_iq", e);
  await iqBonus(e.newValue, "repeating_profiles_mod_");
});

  /* endinject */

  /* inject:js/wps.js */
  function addWpToBonuses(section, rowId, wpName) {
  console.log("addWpToBonuses", section, rowId);
  if (!section || !rowId || !wpName) {
    return;
  }
  const wpActions = WP_KEYS[section];
  const wpAttrs = wpActions.map(
    (action) => `repeating_${section}_${rowId}_${action}`
  );
  const wpCombatId = `repeating_${section}_${rowId}_bonus_id`;
  wpAttrs.push(wpCombatId);
  getAttrs(wpAttrs, (a) => {
    const attrs = {};
    let combatRowId;
    if (a[wpCombatId]) {
      combatRowId = a[wpCombatId];
    } else {
      combatRowId = generateRowID();
      attrs[wpCombatId] = combatRowId;
    }
    COMBAT_SAVE_KEYS.forEach((key) => {
      attrs[`repeating_bonuses_${combatRowId}_${key}`] =
        a[`repeating_${section}_${rowId}_${key}`] || 0;
    });
    setAttrs(attrs);
  });
}

function setWpRow(section, name, keyPrefix, level) {
  console.log("setWpRow", name, keyPrefix, level);
  const attrs = {};
  const levelBonuses = WP[name.toLowerCase()].slice(0, level);
  const totalBonuses = mergeAndAddObjects(levelBonuses);
  WP_KEYS[section].forEach((action) => {
    if (action == "name") return; // kick out on name
    const key = `${keyPrefix}_${action}`;
    attrs[key] = action in totalBonuses ? totalBonuses[action] : 0;
  });
  attrs[`${keyPrefix}_level`] = level;
  setAttrs(attrs);
}

function setWp({
  section,
  wpName,
  newCharacterLevel,
  oldCharacterLevel,
  newWpLevel,
  rowId,
  callback,
}) {
  console.log("setWp", {
    section,
    wpName,
    newCharacterLevel,
    oldCharacterLevel,
    newWpLevel,
    rowId,
    callback,
  });
  const keyPrefix = rowId
    ? `repeating_${section}_${rowId}`
    : `repeating_${section}`;
  if (newWpLevel) {
    setWpRow(section, wpName, keyPrefix, newWpLevel);
    if (callback) {
      callback(section, rowId, wpName);
    }
  } else if (!rowId) {
    setWpRow(section, wpName, keyPrefix, newCharacterLevel);
    if (callback) {
      callback(section, rowId, wpName);
    }
  } else {
    getAttrs([`${keyPrefix}_level`], (a) => {
      const oldWpLevel = a[`${keyPrefix}_level`];
      if (oldCharacterLevel) {
        const delta = oldCharacterLevel - oldWpLevel;
        if (delta != 0) {
          newWpLevel = newCharacterLevel - delta;
          setWpRow(section, wpName, keyPrefix, newWpLevel);
        } else {
          setWpRow(section, wpName, keyPrefix, newCharacterLevel);
        }
      } else {
        setWpRow(section, wpName, keyPrefix, newCharacterLevel);
      }
      if (callback) {
        callback(section, rowId, wpName);
      }
    });
  }
}

function updateWeaponProficiencies(
  section,
  newCharacterLevel,
  oldCharacterLevel
) {
  getSectionIDs(section, (ids) => {
    const attrNames = ids.map((id) => `repeating_${section}_${id}_name`);
    getAttrs(attrNames, (a) => {
      ids.forEach((id) => {
        setWp({
          section,
          wpName: a[`repeating_${section}_${id}_name`].toLowerCase(),
          newCharacterLevel,
          oldCharacterLevel,
          rowId: id,
        });
      });
    });
  });
}

function updateWeaponProficiency(section, source, newWpLevel) {
  getSectionIDs(section, (ids) => {
    const rowId = ids.find(
      (id) => `repeating_${section}_${id}_level`.toLowerCase() == source
    );
    getAttrs([`repeating_${section}_${rowId}_name`], (a) => {
      setWp({
        section,
        wpName: a[`repeating_${section}_${rowId}_name`],
        newWpLevel,
        rowId: rowId,
        callback: addWpToBonuses,
      });
    });
  });
}

on("change:repeating_wp:level change:repeating_wpmodern:level", (e) => {
  const section = e.sourceAttribute.split("_")[1];
  updateWeaponProficiency(section, e.sourceAttribute, e.newValue);
});

on("change:repeating_wp:name change:repeating_wpmodern:name", (e) => {
  console.log("change:repeating_wp:name change:repeating_wpmodern:name", e);
  const [r, section, rowId, attr] = e.sourceAttribute.split("_");
  const wpName = e.newValue.toLowerCase();
  const wpLevelKey = `repeating_${section}_level`;
  setAttrs({ [`repeating_${section}_rowid`]: `repeating_${section}_${rowId}` });
  getAttrs(["character_level", wpLevelKey], (a) => {
    if (Boolean(a[wpLevelKey]) && +a[wpLevelKey] != 0) {
      setWp({
        section,
        wpName,
        rowId,
        newWpLevel: a[wpLevelKey],
        callback: addWpToBonuses,
      });
    } else {
      const attrs = {};
      attrs[`repeating_${section}_level`] = a.character_level;
      setAttrs(attrs);
    }
  });
});

  /* endinject */

  /* inject:js/modifiers.js */
  /**
 * User adds a thing to repeating_modifiers
 * -> addModifierToBonuses
 * -> triggers "change:repeating_bonuses:name"
 * -> addBonusToSelections
 */

function addModifierToBonuses(section, rowId) {
  console.log("addModifierToBonuses", section, rowId);
  if (!section || !rowId) {
    return;
  }

  const thingBonusId = `repeating_${section}_${rowId}_bonus_id`;
  const thingAttrs = COMBAT_SAVE_KEYS.map(
    (key) => `repeating_${section}_${rowId}_${key}`
  );
  thingAttrs.push(thingBonusId);
  getAttrs(thingAttrs, (a) => {
    console.log(a);
    const attrs = {};
    let bonusRowId;
    if (a[thingBonusId]) {
      bonusRowId = a[thingBonusId];
    } else {
      bonusRowId = generateRowID();
      attrs[thingBonusId] = bonusRowId;
    }
    COMBAT_SAVE_KEYS.forEach((key) => {
      attrs[`repeating_bonuses_${bonusRowId}_${key}`] =
        a[`repeating_${section}_${rowId}_${key}`] || 0;
    });
    setAttrs(attrs);
  });
}

on("change:repeating_modifiers", (e) => {
  console.log("change:repeating_modifiers", e);
  const sourceParts = e.sourceAttribute.split("_");
  if (
    e.sourceAttribute.endsWith("_bonus_id") ||
    e.sourceAttribute.endsWith("_rowid") ||
    sourceParts.length < 4
  ) {
    return;
  }
  const [r, section, rowId] = sourceParts;
  //   addModifierToBonuses(section, rowId);
  setAttrs(
    { [`repeating_modifiers_rowid`]: `repeating_modifiers_${rowId}_` },
    {},
    () => addModifierToBonuses(section, rowId)
  );
});

on("remove:repeating_modifiers", (e) => {
  console.log("remove:repeating_modifiers", e);
  // remove repeating_bonusselections row with the same index
  const bonusRowId = e.removedInfo[`${e.sourceAttribute}_bonus_id`];
  removeBonusRows(bonusRowId);
});

  /* endinject */

  /* inject:js/profiles.js */
  async function updateProfile(rowId) {
  const bonusIds = (
    await getAttrsAsync(["repeating_profiles_bonus_ids"])
  ).repeating_profiles_bonus_ids.split(",");
  console.log(bonusIds);
  const bonusNameKeys = bonusIds.map((id) => `repeating_bonuses_${id}_name`);
  const a = await getAttrsAsync(bonusNameKeys);
  const names = Object.values(a).reduce((acc, cur) => `${acc} ${cur}`, "");
  await setAttrsAsync({ [`repeating_profiles_${rowId}_bonus_names`]: names });
  await combineBonuses(bonusIds, `repeating_profiles_${rowId}`);
}

on("clicked:repeating_profiles:copybonusids", (e) => {
  console.log("clicked:copybonusids", e);
  getAttrs(["bonus_ids_output"], (a) => {
    const attrs = {};
    attrs[`repeating_profiles_bonus_ids`] = a.bonus_ids_output;
    setAttrs(attrs);
  });
});

on(
  "clicked:repeating_profiles:updateprofile change:repeating_profiles:bonus_ids",
  async (e) => {
    console.log("clicked:repeating_profiles:updateprofile", e);
    const [r, section, rowId] = e.sourceAttribute.split("_");
    await updateProfile(rowId);
  }
);

  /* endinject */

  /* inject:js/attributes.js */
  async function iqBonus(value, prefix = "") {
  const iq_bonus = value > 15 ? value - 14 : 0;
  const perception_bonus = getBiAttributeBonus(value);
  await setAttrsAsync({
    [`${prefix}iq_bonus`]: iq_bonus,
    [`${prefix}perception_bonus`]: perception_bonus,
  });
  await updateSkills();
}

on("change:iq", async (e) => {
  await iqBonus(e.newValue);
  // const iq_bonus = e.newValue > 15 ? e.newValue - 14 : 0;
  // const perception_bonus = getBiAttributeBonus(e.newValue);
  // setAttrs({ iq_bonus, perception_bonus }, {}, updateSkills);
});

on("change:me change:pp change:pe", (e) => {
  console.log("change:me change:pp change:pe");
  const bonus = getBiAttributeBonus(e.newValue);
  const attrs = {};
  attrs[`${e.sourceAttribute}_bonus`] = bonus;
  if (e.sourceAttribute == "pe") {
    attrs["pe_coma_bonus"] =
      e.newValue >= 16
        ? e.newValue <= 18
          ? 4 + (e.newValue - 16)
          : e.newValue <= 30
          ? 8 + (e.newValue - 19) * 2
          : 30 + (e.newValue - 30)
        : 0;
  }
  setAttrs(attrs);
});

on("change:ma", (e) => {
  const ma_bonus =
    e.newValue >= 16
      ? e.newValue <= 24
        ? 40 + (e.newValue - 16) * 5
        : e.newValue <= 27
        ? 80 + (e.newValue - 24) * 4
        : e.newValue <= 29
        ? 92 + (e.newValue - 27) * 2
        : 97
      : 0;
  setAttrs({ ma_bonus, trust_intimidate: ma_bonus });
});

on("change:ps change:character_ps_type", (e) => {
  getAttrs(["ps", "character_ps_type"], (a) => {
    const ps = a.ps;
    const ps_type = a.character_ps_type;
    const ps_bonus = ps > 15 ? ps - 15 : 0;

    let restrained_punch = (punch = power_punch = kick = leap_kick = "");
    let restrained_punch_unit =
      (punch_unit =
      power_punch_unit =
      kick_unit =
      leap_kick_unit =
        "sdc");

    switch (ps_type) {
      case "1":
        punch = "1D4";
        kick = "1D4";
        break;
      case "2":
        if (ps < 24) {
          // nop
        } else if (ps == 24) {
          power_punch = "1";
          power_punch_unit = "mdc";
        } else if (ps <= 27) {
          power_punch = "1D4";
          power_punch_unit = "mdc";
        } else if (ps <= 30) {
          power_punch = "1D6";
          power_punch_unit = "mdc";
        } else if (ps <= 40) {
          power_punch = "2D4";
          power_punch_unit = "mdc";
        } else if (ps <= 50) {
          restrained_punch = "3D6";
          punch = "1D4";
          punch_unit = "mdc";
          power_punch = "3D4";
          power_punch_unit = "mdc";
        } else {
          restrained_punch = "4D6";
          punch = "1D8";
          punch_unit = "mdc";
          power_punch = "4D4";
          power_punch_unit = "mdc";
        }
        break;
      case "3":
        if (ps <= 15) {
          restrained_punch = "1D6";
          punch = "2D6";
          power_punch = "4D6";
          kick = "2D6";
          leap_kick = "3D6";
        } else if (ps <= 20) {
          restrained_punch = "2D6";
          punch = "1";
          power_punch = "1D6";
          kick = "1D4";
          leap_kick = "2D4";
          punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
        } else if (ps <= 25) {
          restrained_punch = "6D6";
          punch = "1D4";
          power_punch = "2D4";
          kick = "1D6";
          leap_kick = "2D6";
          punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
        } else if (ps <= 30) {
          restrained_punch = "1D4";
          punch = "1D6";
          power_punch = "2D6";
          kick = "2D4";
          leap_kick = "2D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 35) {
          restrained_punch = "1D4";
          punch = "2D4";
          power_punch = "4D4";
          kick = "2D8";
          leap_kick = "4D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 40) {
          restrained_punch = "1D4";
          punch = "2D6";
          power_punch = "4D6";
          kick = "3D8";
          leap_kick = "5D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 50) {
          restrained_punch = "1D6";
          punch = "3D6";
          power_punch = "1D6*10";
          kick = "5D8";
          leap_kick = "1D8*10";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else {
          restrained_punch = "2D6";
          punch = "6D6";
          power_punch = "2D6*10";
          kick = "6D8";
          leap_kick = "2D6*10";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        }
        break;
      case "4":
        if (ps <= 15) {
          restrained_punch = "1D6";
          punch = "4D6";
          power_punch = "1D4";
          power_punch_unit = "mdc";
        } else if (ps <= 20) {
          restrained_punch = "3D6";
          punch = "1D6";
          power_punch = "2D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 25) {
          restrained_punch = "4D6";
          punch = "2D6";
          power_punch = "4D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 30) {
          restrained_punch = "5D6";
          punch = "3D6";
          power_punch = "6D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 35) {
          restrained_punch = "5D6";
          punch = "4D6";
          power_punch = "1D4*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 40) {
          restrained_punch = "6D6";
          punch = "5D6";
          power_punch = "1D6*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 50) {
          restrained_punch = "1D6*10";
          punch = "6D6";
          power_punch = "2D4*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 60) {
          restrained_punch = "1D6";
          punch = "1D6*10";
          power_punch = "2D6*10";
          restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
        } else {
          // > 60
          const extra = Math.ceil((ps - 60) / 10) * 10;
          restrained_punch = "1D6";
          punch = `1D6*10+${extra}`;
          power_punch = `2D6*10+${extra * 2}`;
          restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
        }
        break;
    }
    const attrs = {
      ps_bonus,
      restrained_punch,
      punch,
      power_punch,
      kick,
      leap_kick,
      restrained_punch_unit,
      punch_unit,
      power_punch_unit,
      kick_unit,
      leap_kick_unit,
    };
    setAttrs(attrs);
  });
});

on("change:pb", (e) => {
  const pb_bonus =
    e.newValue >= 16
      ? e.newValue <= 26
        ? 30 + (e.newValue - 16) * 5
        : e.newValue <= 28
        ? 80 + (e.newValue - 26) * 3
        : e.newValue == 29
        ? 90
        : 92
      : 0;
  setAttrs({ pb_bonus, charm_impress: pb_bonus });
});

on("change:spd", (e) => {
  getAttrs(["combat_combined_attacks"], (a) => {
    const feetPerMelee = e.newValue * 15;
    const attrs = {
      run_mph: ((feetPerMelee * 4 * 60) / 5280).toFixed(1),
      run_ft_melee: feetPerMelee,
      run_ft_attack: Math.round(feetPerMelee / a.combat_combined_attacks),
    };
    setAttrs(attrs);
  });
});

  /* endinject */

  /* inject:js/skills.js */
  async function updateSkill(rowId, iqBonusKey = "iq_bonus") {
  const row = `repeating_skills_${rowId}`;
  const skillAttrs = SKILL_KEYS.map((key) => `${row}_${key}`);
  console.log(skillAttrs);
  const a = await getAttrsAsync(skillAttrs.concat([iqBonusKey]));
  console.log(a);
  const attrs = {};
  const total =
    +a[`${row}_base`] +
    +a[iqBonusKey] +
    +a[`${row}_bonus`] +
    (+a[`${row}_level`] - 1) * +a[`${row}_perlevel`];
  console.log(total);
  attrs[`${row}_total`] = total;
  await setAttrsAsync(attrs);
}

async function updateSkills() {
  const ids = await getSectionIDsAsync("skills");
  for (const id of ids) {
    await updateSkill(id);
  }
}

function updateSkillLevels(newCharacterLevel, oldCharacterLevel) {
  const delta = newCharacterLevel - oldCharacterLevel;
  getSectionIDs("skills", (ids) => {
    const attrNames = ids.map((id) => `repeating_skills_${id}_level`);
    getAttrs(attrNames, (a) => {
      const attrs = {};
      ids.forEach((id) => {
        attrs[`repeating_skills_${id}_level`] =
          +a[`repeating_skills_${id}_level`] + delta;
      });
      setAttrs(attrs);
    });
  });
}

on("change:repeating_skills", (e) => {
  console.log("change:repeating_skills", e);
  if (e.sourceAttribute.endsWith("_name")) return;
  const sourceParts = e.sourceAttribute.split("_");
  // Return if no attribute is changed and it's the row itself
  if (sourceParts.length < 4) return;
  const [r, section, rowId] = sourceParts;
  updateSkill(rowId);
});

on("change:repeating_skills:name", (e) => {
  const [r, section, rowId, attr] = e.sourceAttribute.split("_");
  getAttrs(["character_level"], (a) => {
    console.log(a);
    const attrs = {
      repeating_skills_level: a.character_level,
      [`repeating_${section}_rowid`]: `repeating_${section}_${rowId}`,
    };
    console.log(attrs);
    setAttrs(attrs);
  });
});

  /* endinject */

  /* inject:js/magic_psionics.js */
  on("clicked:repeating_magic:usespell", (e) => {
  console.log(e);
  getAttrs(["repeating_magic_ppe", "currentppe"], (a) => {
    console.log(a);
    setAttrs({ currentppe: a.currentppe - a.repeating_magic_ppe });
  });
});

on("clicked:resetppe", (e) => {
  console.log(e);
  getAttrs(["character_ppe"], (a) => {
    setAttrs({ currentppe: a.character_ppe });
  });
});

on("clicked:repeating_psionics:usepsionic", (e) => {
  console.log(e);
  getAttrs(["repeating_psionics_isp", "currentisp"], (a) => {
    console.log(a);
    setAttrs({ currentisp: a.currentisp - a.repeating_psionics_isp });
  });
});

on("clicked:resetisp", (e) => {
  console.log(e);
  getAttrs(["character_isp"], (a) => {
    setAttrs({ currentisp: a.character_isp });
  });
});

function calculateRangeDuration(row) {
  const attrNames = ["starting", "per_level", "unit"].map(
    (subProp) => `${row}_${subProp}`
  );
  console.log(attrNames);
  getAttrs(attrNames.concat(["character_level"]), (a) => {
    console.log(a);
    const value =
      +a[`${row}_starting`] + (+a.character_level - 1) * +a[`${row}_per_level`];
    const unit = a[`${row}_unit`];
    const valueWithUnits = `${value} ${unit}`;
    setAttrs({ [row]: valueWithUnits });
  });
}

function calculatePercentage(row) {
  const attrNames = ["starting", "per_level"].map(
    (subProp) => `${row}_${subProp}`
  );
  getAttrs(attrNames.concat(["character_level"]), (a) => {
    console.log(a);
    const value =
      +a[`${row}_starting`] + (+a.character_level - 1) * +a[`${row}_per_level`];
    setAttrs({ [row]: value });
  });
}

function calculateDamage(row) {
  const attrNames = ["starting", "per_level", "unit"].map(
    (subProp) => `${row}_${subProp}`
  );
  getAttrs(attrNames.concat(["character_level"]), (a) => {
    console.log(a);
    const perLevel = a[`${row}_per_level`];
    const repeats = perLevel
      ? `+${perLevel}`.repeat(a.character_level - 1)
      : "";
    const value = `${a[`${row}_starting`]}${repeats}`;
    setAttrs({ [row]: value });
  });
}

function updateMagicPsionicsLevels() {
  ABILITIES_REPEATERS.forEach((section) => {
    getSectionIDs(section, (ids) => {
      ids.forEach((id) => {
        const row = `repeating_${section}_${id}`;
        calculateDamage(`${row}_damage`);
        calculatePercentage(`${row}_percentage`);
        calculateRangeDuration(`${row}_range`);
        calculateRangeDuration(`${row}_duration`);
      });
    });
  });
}

const nameListeners = ABILITIES_REPEATERS.map(
  (repeater) => `change:repeating_${repeater}:name`
).join(" ");

const damageListeners = ABILITIES_REPEATERS.reduce((acc, cur) => {
  acc.push(`change:repeating_${cur}:damage_starting`);
  acc.push(`change:repeating_${cur}:damage_unit`);
  acc.push(`change:repeating_${cur}:damage_per_level`);
  return acc;
}, []).join(" ");

const percentageListeners = ABILITIES_REPEATERS.reduce((acc, cur) => {
  acc.push(`change:repeating_${cur}:percentage_starting`);
  acc.push(`change:repeating_${cur}:percentage_per_level`);
  return acc;
}, []).join(" ");

const rangeDurationFrequencyDcListeners = ABILITIES_REPEATERS.reduce(
  (acc, cur) => {
    ["range", "duration", "frequency", "dc"].forEach((property) => {
      acc.push(`change:repeating_${cur}:${property}_starting`);
      acc.push(`change:repeating_${cur}:${property}_unit`);
      acc.push(`change:repeating_${cur}:${property}_per_level`);
    });
    return acc;
  },
  []
).join(" ");

on(damageListeners, (e) => {
  console.log(e);
  const [r, section] = e.sourceAttribute.split("_");
  const row = `${r}_${section}_damage`;
  calculateDamage(row);
});

on(percentageListeners, (e) => {
  console.log(e);
  const [r, section] = e.sourceAttribute.split("_");
  const row = `${r}_${section}_percentage`;
  calculatePercentage(row);
});

on(rangeDurationFrequencyDcListeners, (e) => {
  console.log(e);
  const [r, section, rowId, property] = e.sourceAttribute.split("_");
  const row = `${r}_${section}_${property}`;
  calculateRangeDuration(row);
});

on(nameListeners, (e) => {
  const [r, section, rowId] = e.sourceAttribute.split("_");
  const attrs = {};
  attrs[`${r}_${section}_rowid`] = `${r}_${section}_${rowId}_`;
  setAttrs(attrs);
});

  /* endinject */

  /* inject:js/movement.js */
  /**
 * @todo how is this going to work with multiple profiles?
 * Which profile's attack count do we use?
 * Have one selected as "active" or "default"?
 * Or select within the Movement section which profile to refer to?
 * I like the idea of radio buttons in the Movement section
 * that let you select a profile
 */

on("change:repeating_movement:mph", (e) => {
  getAttrs(["combat_combined_attacks"], (a) => {
    const feetPerMelee = Math.round((e.newValue * 5280) / 60 / 4);
    const attrs = {
      repeating_movement_ft_melee: feetPerMelee,
      repeating_movement_ft_attack: Math.round(
        feetPerMelee / a.combat_combined_attacks
      ),
    };
    setAttrs(attrs);
  });
});

on("change:repeating_movement:ft_melee", (e) => {
  getAttrs(["combat_combined_attacks"], (a) => {
    const feetPerMelee = e.newValue;
    //const mph = Math.round((feetPerMelee * 4 * 60) / 5280);
    const mph = ((feetPerMelee * 4 * 60) / 5280).toFixed(1);
    const attrs = {
      repeating_movement_mph: mph,
      repeating_movement_ft_attack: Math.round(
        feetPerMelee / a.combat_combined_attacks
      ),
    };
    setAttrs(attrs);
  });
});

  /* endinject */

  /* inject:js/import_export.js */
  (function () {
  function getRepeatingRows(section, callback) {
    getSectionIDs(section, (ids) => {
      const attrNames = ids.reduce((acc, id) => {
        SECTIONS[section].forEach((key) => {
          acc.push(`repeating_${section}_${id}_${key}`);
        });
        return acc;
      }, []);
      getRepeatingSectionArray(section, ids, attrNames, callback);
    });
  }

  function getRepeatingSectionArray(section, rowIds, attrNames, callback) {
    let sectionArray = [];
    getAttrs(attrNames, (attrs) => {
      rowIds.forEach((rowId) => {
        const wpObj = Object.keys(attrs).reduce((acc, attr) => {
          if (attr.includes(rowId)) {
            acc[attr.replace(`repeating_${section}_${rowId}_`, "")] =
              attrs[attr];
          }
          return acc;
        }, {});
        sectionArray.push(wpObj);
      });
      callback(sectionArray);
    });
  }

  on("clicked:export", (e) => {
    console.log("export", e);
    const attrs = {};
    getRepeatingRows("wp", (wpSectionArray) => {
      attrs.wp = wpSectionArray;

      getRepeatingRows("wpmodern", (wpmodernSectionArray) => {
        attrs.wpmodern = wpmodernSectionArray;

        getRepeatingRows("skills", (skillsSectionArray) => {
          attrs.skills = skillsSectionArray;

          getRepeatingRows("combat", (combatSectionArray) => {
            attrs.combat = combatSectionArray;

            getRepeatingRows("magic", (magicSectionArray) => {
              attrs.magic = magicSectionArray;

              getRepeatingRows("psionics", (psionicsSectionArray) => {
                attrs.psionics = psionicsSectionArray;

                getRepeatingRows("movement", (movementSectionArray) => {
                  attrs.movement = movementSectionArray;

                  getAttrs(CORE_KEYS, (coreAttrs) => {
                    Object.entries(coreAttrs).forEach(
                      ([key, val]) => (attrs[key] = val)
                    );

                    setAttrs({ importexport: JSON.stringify(attrs, null, 2) });
                  });
                });
              });
            });
          });
        });
      });
    });
  });

  function setRepeatingRows(section, data, callback) {
    console.log("setRepeatingRows", section, data);
    if (!data) return callback();
    console.log("continuing setRepeatingRows", section);
    const attrs = data.reduce((acc, row) => {
      const rowId = generateRowID();
      Object.entries(row).forEach(([key, val]) => {
        acc[`repeating_${section}_${rowId}_${key}`] = val;
      });
      return acc;
    }, {});
    setAttrs(attrs, {}, callback);
  }

  on("clicked:import", (e) => {
    console.log("import", e);
    getAttrs(["importexport"], (a) => {
      const data = JSON.parse(a.importexport);
      console.log(data);
      setRepeatingRows("wp", data.wp, () => {
        delete data.wp;
        setRepeatingRows("wpmodern", data.wpmodern, () => {
          delete data.wpmodern;
          setRepeatingRows("skills", data.skills, () => {
            delete data.skills;
            setRepeatingRows("modifiers", data.modifiers, () => {
              delete data.modifiers;
              setRepeatingRows("magic", data.magic, () => {
                delete data.magic;
                setRepeatingRows("psionics", data.psionics, () => {
                  delete data.psionics;
                  setRepeatingRows("movement", data.movement, () => {
                    delete data.movement;
                    setAttrs(data);
                  });
                });
              });
            });
          });
        });
      });
    });
  });
})();

  /* endinject */

  /**
   * Add attributes, PS type, ISP, PPE, HP, SDC, MDC, etc. to Bonuses
   * [x] Allow for an "absolute" value
   * [x] Add additional field(s) to Profile for aggregate attribute bonuses
   * [] Use a "text" input and allow for values like `*2` or `/2`
   * Aggregate Logic:
   * - PS includes type
   * - HP, SDC, AR, MDC are grouped on their own Armor row w/ Name
   * - PPE, ISP are grouped on their own "Mana"? row w/ Name
   *
   *
   * @todo consider spells/gear that modifies attributes (either as a modifier or an absolute value),
   *    modifies PS type, modifies PPE
   * @todo Magic - include checkbox beside each spell to add it as a row on the Combat tab
   * @todo Psionics - include checkbox beside each psionic to add it as a row on the Combat tab
   * @todo Armor tab / repeater; Armor checkboxes in Aggregate Bonuses, and Armor list (name, MDC) underneath
   *    Aggregate Bonuses checkboxes that show and hide based on the check
   *    - Magic and Psionics also provide armor. so you have to add the spell and then have a button to add it to the Armor tab
   *      Hitting "cast" should use up the PPE and check the checkbox. This should also apply to spell which have a duration and provide bonuses.
   *      Buttons: Cast | Cast and add to modifiers | Cast and add to armor
   * @todo add Ammo/Uses to Combat, Magic
   * @todo add import status - add an attribute and update count on each callback, or just once at the end indicating completion
   *
   * @todo Import isn't setting Skill level properly, probably because it's already "1"
   * @todo when Aggregate Attacks change, recalculate ft/attack fields
   *
   * Questions
   * - Paratrooper gets a save vs. Torture. What is this?
   *
   * @todo standardize/improve markup on Core tab
   *
   * @todo add an active combat section above Aggregate bonuses
   *    - track attacks
   *    - track ammo (roll20 has something for this)
   *    - track MDC - for each aggregate MDC modifier, track it separately in a repeater. allow the user to reorder, and deduct from bottom to top
   *
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   *
   * @todo better better build process with imports/file modules
   *
   * To get Character ID, `getAttrs(["character_id"])`
   * */

  /**
   * This one could be a doozy
   * */
  on("change:character_level", (e) => {
    console.log("change:character_level", e.newValue, e.previousValue);
    // Update WPs
    updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    updateSkillLevels(+e.newValue, +e.previousValue);
    updateMagicPsionicsLevels();
  });

  const buttonlist = [
    "core",
    "wp",
    "combat",
    "bonuses",
    "equipment",
    "skills",
    "magic",
    "psionics",
    "importexport",
    "abilities",
  ];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({ sheetTab: button });
    });
  });
</script>
