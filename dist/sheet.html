<main id="megaverse">
  <div>
    <button class="metal linear" type="action" name="act_core">Core</button>
    <button class="metal linear" type="action" name="act_skills">Skills</button>
    <button class="metal linear" type="action" name="act_wp">WPs</button>
    <button class="metal linear" type="action" name="act_combat">Combat</button>
    <button class="metal linear" type="action" name="act_magic">Magic</button>
    <button class="metal linear" type="action" name="act_psionics">
      Psionics
    </button>
    <button class="metal linear" type="action" name="act_equipment">
      Equipment
    </button>
  </div>
  <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core" />

  <datalist id="distance-units">
    <option value="m"></option>
    <option value="km"></option>
    <option value="ft"></option>
    <option value="yd"></option>
    <option value="mi"></option>
  </datalist>
  <datalist id="damage-units">
    <option value="MDC"></option>
    <option value="SDC"></option>
  </datalist>
  <datalist id="time-units">
    <option value="seconds"></option>
    <option value="melees"></option>
    <option value="minutes"></option>
    <option value="hours"></option>
    <option value="days"></option>
    <option value="months"></option>
    <option value="years"></option>
  </datalist>
  <datalist id="spell-schools">
    <option value="Invocation"></option>
    <option value="Elemental"></option>
    <option value="Necromancy"></option>
  </datalist>

  <div class="core">
    Palladium Rifts Character Sheet <br />
    <h1>Character Statistics</h1>
    <div class="grid-container">
      <div class="section-one character-background">
        <label
          ><span>Character Name</span>
          <input
            id="character-name"
            type="text"
            value=""
            name="attr_character_name"
        /></label>
        <label
          ><span>True Name</span>
          <input type="text" value="" name="attr_truename_name"
        /></label>
        <label
          ><span>Race</span>
          <input type="text" value="" name="attr_character_race"
        /></label>
        <label
          ><span>O.C.C.</span> <input type="text" value="" name="attr_occ"
        /></label>
        <label
          ><span>Strength Type</span>
          <select class="" name="attr_ps_type" value="normal">
            <option value="normal">Normal</option>
            <option value="augmented">Augmented</option>
            <option value="robotic">Robotic</option>
            <option value="supernatural">Supernatural</option>
          </select></label
        >
        <label
          ><span>Level</span> <input type="number" name="attr_level"
        /></label>
        <label
          ><span>Experience</span> <input type="number" name="attr_experience"
        /></label>
        <label
          ><span>Alignment</span>
          <select class="select" name="attr_alignment_select" value="0">
            <option value="0"></option>
            <option value="Principled">Principled</option>
            <option value="Scrupulous">Scrupulous</option>
            <option value="Unprincipled">Unprincipled</option>
            <option value="Anarchist">Anarchist</option>
            <option value="Taoist">Taoist</option>
            <option value="Miscreant">Miscreant</option>
            <option value="Abberant">Aberrant</option>
            <option value="Diabolic">Diabolic</option>
          </select></label
        >
        <label
          ><span>Age</span>
          <input
            class="attribute"
            type="number"
            value=""
            name="attr_character_age"
        /></label>
        <label
          ><span>Gender</span>
          <input type="text" value="" name="attr_character_gender"
        /></label>
        <label
          ><span>Height</span>
          <input type="text" value="" name="attr_character_height"
        /></label>
        <label
          ><span>Weight</span>
          <input type="text" value="" name="attr_character_weight"
        /></label>
        <label
          ><span>Family Origin</span>
          <input type="text" value="" name="attr_character_familyorigin"
        /></label>
        <label
          ><span>Environment</span>
          <input value="" name="attr_character_environment"
        /></label>
        <label
          ><span>Native Language(s)</span>
          <input type="text" value="" name="attr_character_languages"
        /></label>
        <label
          ><span>Insanity, if any</span>
          <input type="text" value="" name="attr_character_insanity"
        /></label>
        <label
          ><span>Disposition</span>
          <input type="text" value="" name="attr_character_disposition"
        /></label>
      </div>

      <div class="section-two">
        <div class="ss-2a">
          <label for="iq">I.Q.</label>
          <input
            id="iq"
            type="number"
            value=""
            name="attr_iq"
            title="Intelligence Quotient"
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_iq_bonus"
            title="+ Skills %"
            readonly
          />
          <input
            class="attribute-bonus"
            type="number"
            value="0"
            name="attr_perception_bonus"
            title="+ Perception (Rifter #13, p.16)"
            readonly
          />

          <label for="mental-endurance">M.E.</label>
          <input
            id="mental-endurance"
            type="number"
            value=""
            name="attr_me"
            title="Mental Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_me_bonus"
            title="+ Save vs. Psionics"
            readonly
          />
          <div></div>

          <label for="mental-affinity">M.A.</label>
          <input
            id="mental-affinity"
            type="number"
            value=""
            name="attr_ma"
            title="Mental Affinity"
          />
          <input
            type="number"
            value="0"
            name="attr_ma_bonus"
            title="% Trust/Intimidate"
            readonly
          />
          <div></div>

          <label for="physical-strength">P.S.</label>
          <input
            id="physical-strength"
            type="number"
            value=""
            name="attr_ps"
            title="Physical Strength"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_ps_bonus"
            title="+ SDC Damage"
            readonly
          />
          <div></div>

          <label for="physical-prowess">P.P</label>
          <input
            id="physical-prowess"
            type="number"
            value=""
            name="attr_pp"
            title="Physical Prowess"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pp_bonus"
            title="+ Strike/Parry/Dodge/Entangle/Disarm"
            readonly
          />
          <div></div>

          <label for="physical-endurance">P.E.</label>
          <input
            id="physical-endurance"
            type="number"
            value=""
            name="attr_pe"
            title="Physical Endurance"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_bonus"
            title="+ Magic/Poison/Toxins"
            readonly
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pe_coma_bonus"
            title="+ Coma/Death %"
            readonly
          />

          <label for="physical-beauty">P.B.</label>
          <input
            id="physical-beauty"
            type="number"
            value=""
            name="attr_pb"
            title="Physical Beauty"
          />
          <input
            class="attribute"
            type="number"
            value="0"
            name="attr_pb_bonus"
            title="% Charm/Impress"
            readonly
          />
          <div></div>

          <label for="speed">Spd</label>
          <input
            id="speed"
            type="number"
            value=""
            name="attr_spd"
            title="Speed"
          />
        </div>
        <div class="ss-2b">
          <label for="trust-intimidate">Trust/Intimidate</label>
          <input
            id="trust-intimidate"
            type="number"
            value=""
            name="attr_trust_intimidate"
          /><span>%</span>

          <label for="charm-impress">Charm/Impress</label>
          <input
            id="charm-imporess"
            type="number"
            value=""
            name="attr_charm_impress"
          /><span>%</span>
        </div>
        <div class="ss-2c">
          <label for="restrained-punch">Restrained Punch</label>
          <input
            id="restrained-punch"
            type="text"
            name="attr_restrained_punch"
          />
          <select name="attr_restrained_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="punch">Punch</label>
          <input id="punch" type="text" name="attr_punch" />
          <select name="attr_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="power-punch">Power Punch</label>
          <input id="power-punch" type="text" name="attr_power_punch" />
          <select name="attr_power_punch_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="kick">Kick</label>
          <input id="kick" type="text" name="attr_kick" />
          <select name="attr_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="leap-kick">Leap Kick</label>
          <input id="leap-kick" type="text" name="attr_leap_kick" />
          <select name="attr_leap_kick_unit" value="sdc">
            <option value="sdc">SDC</option>
            <option value="mdc">MDC</option>
          </select>

          <label for="lift">Lift</label>
          <input id="lift" type="number" value="" name="attr_lift" />
          <div></div>

          <label for="carry">Carry</label>
          <input id="carry" type="number" value="" name="attr_carry" />
          <div></div>

          <label for="throw">Throw</label>
          <input id="throw" type="number" value="" name="attr_throw" />
          <div></div>

          <label for="carry-max">Carry Max</label>
          <input
            id="carry-max"
            type="number"
            value=""
            name="attr_carry_max"
          />Minutes

          <label for="carry-running">Carry (Running)</label>
          <input
            id="carry-running"
            type="number"
            value=""
            name="attr_carry_running"
          />Minutes

          <label for="hold-max">Hold Max.</label>
          <input
            id="hold-max"
            type="number"
            value=""
            name="attr_hold_max"
          />Melees
        </div>
      </div>
      <div class="section-three">
        <label
          ><span>Hit Points</span>
          <input type="number" value="" name="attr_character_hp" />
        </label>
        <label>
          <span>S.D.C.</span>
          <input type="number" value="" name="attr_character_sdc" />
        </label>
        <label
          ><span>M.D.C.</span>
          <input type="number" value="" name="attr_character_mdc" />
        </label>
        <label
          ><span>P.P.E.</span>
          <input type="number" value="" name="attr_character_ppe" />
        </label>
        <label
          ><span>A.R.</span
          ><input type="number" value="" name="attr_character_ar"
        /></label>
        <label
          ><span>I.S.P.</span
          ><input type="number" value="" name="attr_character_isp"
        /></label>
        <label
          ><span>H.F.</span
          ><input type="number" value="" name="attr_character_hf"
        /></label>
        <label
          ><span>Perception</span>
          <input id="perception" type="number" value"0" name="attr_perception"
          />
          <button type="roll" value="Perception: [[d20+@{perception}]]" />
        </label>
      </div>
    </div>

    <h2>Movement</h2>
    <div class="movement-container">
      <div></div>
      <label for="mph">MPH</label>
      <label for="ft-melee">Ft/Melee</label>
      <label for="ft-attack">Ft/Attack</label>
      <label for="cruising">Cruising</label>
      <label for="run-at-max">Run at Max</label>
      <label>Run</label>
      <input id="mph" type="number" value="" readonly name="attr_run_mph" />
      <input
        id="ft-melee"
        type="number"
        value=""
        readonly
        name="attr_run_ft_melee"
      />
      <input
        id="ft-attack"
        type="number"
        value=""
        readonly
        name="attr_run_ft_attack"
      />
      <input id="cruising" type="number" value="" name="attr_run_cruising" />
      <div>
        <input
          id="run-at-max"
          type="number"
          value="@{pe}/2"
          disabled="true"
          name="attr_run_at_max"
        />
        minutes
      </div>

      <label for="leaing-distance">Leaping Distance</label>
      <input type="number" name="attr_leapup" value="" />
      <div>feet up?</div>
      <input type="number" name="attr_leapout" value="" />
      <div>feet out?</div>
      <div></div>

      <label>Additional Movement Type</label>
      <label>MPH</label>
      <label>Ft/Melee</label>
      <label>Ft/Attack</label>
      <label>Cruising</label>
      <label>Run at Max</label>

      <input type="text" value="" name="attr_movement_name" />
      <input type="number" value="" name="attr_movement_mph" />
      <input type="number" value="" name="attr_movement_ft_melee" />
      <input type="number" value="" name="attr_movement_ft_attack" readonly />
      <input type="number" value="" name="attr_movement_cruising" />
      <div>
        <input type="number" value="" name="attr_movement_at_max" /> minutes
      </div>
    </div>
  </div>
  <br />

  <div class="wp">
    <div class="wp-container">
      <h3>Ancient Weapon Proficiencies</h3>
      <fieldset class="repeating_wp">
        <h5>Weapon Proficiency</h5>
        <h5>Strike</h5>
        <h5></h5>
        <h5>Parry</h5>
        <h5></h5>
        <h5>Disarm</h5>
        <h5></h5>
        <h5>Throw</h5>
        <h5></h5>
        <h5>Entangle</h5>
        <h5></h5>
        <h5>RoF</h5>
        <h5>Level</h5>
        <input type="hidden" name="attr_combat_id" value="" />
        <input type="text" list="weaponProficiencies" name="attr_skill" />
        <datalist id="weaponProficiencies">
          <option value="Archery"></option>
          <option value="Axe"></option>
          <option value="Blunt"></option>
          <option value="Chain"></option>
          <option value="Forked"></option>
          <option value="Knife"></option>
          <option value="Grappling Hook"></option>
          <option value="Pole Arm"></option>
          <option value="Rope"></option>
          <option value="Shield"></option>
          <option value="Spear"></option>
          <option value="Staff"></option>
          <option value="Sword"></option>
          <option value="Targeting"></option>
          <option value="Whip"></option>
        </datalist>
        <input type="number" value="" name="attr_strike" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{strike}+@{combat_combined_strike}]]"
        ></button>
        <input type="number" value="" name="attr_parry" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{parry}+@{combat_combined_parry}]]"
        ></button>
        <input type="number" value="" name="attr_disarm" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{disarm}+@{combat_combined_disarm}]]"
        ></button>
        <input type="number" value="" name="attr_throw" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{throw}+@{combat_combined_throw}]]"
        ></button>
        <input type="number" value="" name="attr_entangle" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{entangle}+@{combat_combined_entangle}]]"
        ></button>
        <input type="number" value="" name="attr_rof" />
        <input type="number" value="" name="attr_skill_level" />
      </fieldset>
      <hr />
      <h3>Modern Weapon Proficiencies</h3>
      <fieldset class="repeating_wpmodern">
        <h5>Weapon Proficiency</h5>
        <h5>Strike</h5>
        <h5></h5>
        <h5>Burst</h5>
        <h5></h5>
        <h5>Level</h5>
        <input type="hidden" name="attr_combat_id" value="" />
        <input type="text" list="weaponProficienciesModern" name="attr_skill" />
        <datalist id="weaponProficienciesModern">
          <option value="Handguns"></option>
          <option value="Rifles"></option>
          <option value="Energy Heavy"></option>
          <option value="Energy Pistol"></option>
          <option value="Energy Rifle"></option>
          <option value="Heavy"></option>
          <option value="Speargun"></option>
          <option value="Shotgun"></option>
          <option value="Submachinegun"></option>
          <option value="Flamethrower"></option>
        </datalist>
        <input type="number" value="" name="attr_strike_range_single" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{strike_range_single}+@{combat_combined_strike_range}]]"
        ></button>
        <input type="number" value="" name="attr_burst" />
        <button
          type="roll"
          value="@{wpname}: [[d20+@{burst}+@{combat_combined_burst}]]"
        ></button>
        <input type="number" value="" name="attr_skill_level" />
      </fieldset>
    </div>
  </div>

  <div class="combat">
    <div class="combat-container">
      <div class="combat-combined">
        <details>
          <summary><b>Instructions</b></summary>
          <p>
            Complete the repeating sections for your various combat skills.
            Skill dropdowns are free-form, so you can type anything in them and
            don't need to select from the list. What's there is just a small
            sample.
          </p>
          <p>
            Any skills you add will appear as checkboxes. Toggling them will
            recalculate the bonuses for all checked items.
          </p>
          <p>
            Any Weapon Proficiencies you add on the WPs tab will appear on this
            page as well. Weapon Proficiencies <b>automatically</b> calculate
            their bonuses based on level, but no other skill (like Hand-to-Hand)
            does so yet.
          </p>
          <p>
            If you have additional bonuses from items, magic, training, etc.,
            you can create arbitrarily named sections and apply those as well.
          </p>
          <p>
            Note that PP bonus is added to Strike, Parry, Dodge, Throw, Disarm,
            Entangle, Dodge: Flight, Dodge: Auto, Dodge: Teleport, and Dodge:
            Motion. PS bonus isn't added to Damage because it could be
            non-Normal. Crit should be the lowest of the available options (ex.
            Crit: 17 is better than Crit: 19), but hasn't been implemented so
            needs to be set manually.
          </p>
        </details>
        <p>Click <b>Instructions</b> for detailed instructions.</p>
        <p>
          The Add/Modify buttons below will eventually disappear, as this
          section is dynamic. Unless you're using them for debugging or testing,
          don't touch them, as it may cause unpredictable behavior.
        </p>
        <fieldset class="repeating_combatselections">
          <label>
            <input type="checkbox" name="attr_skill_check" value="1" />
            <span name="attr_skill"></span
          ></label>
          <input type="hidden" name="attr_skill" value="" />
          <input type="hidden" name="attr_combat_id" value="" />
          <input type="hidden" name="attr_bonus_section" value="" />
        </fieldset>
        <br />
        <h3>Aggregated Bonuses</h3>
        <div class="combat-combined-bonuses">
          <label
            ><span>Attacks</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_attacks"
            />
          </label>
          <label
            ><span>Initiative</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_initiative"
            />
            <button
              type="roll"
              value="Initiative: [[d20+@{combat_combined_initiative}]]"
            />
          </label>
          <label
            ><span>Strike</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_strike"
            />
            <button
              type="roll"
              value="Strike: [[d20+@{combat_combined_strike}]]"
            />
          </label>
          <label
            ><span>Parry</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_parry"
            />
            <button
              type="roll"
              value="Parry: [[d20+@{combat_combined_parry}]]"
            />
          </label>
          <label
            ><span>Dodge</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_dodge"
            />
            <button
              type="roll"
              value="Dodge: [[d20+@{combat_combined_dodge}]]"
            />
          </label>
          <label
            ><span>Throw</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_throw"
            />
            <button
              type="roll"
              value="Throw: [[d20+@{combat_combined_throw}]]"
            />
          </label>
          <label
            ><span>Disarm</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_disarm"
            />
            <button
              type="roll"
              value="Disarm: [[d20+@{combat_combined_disarm}]]"
            />
          </label>
          <label
            ><span>Entangle</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_entangle"
            />
            <button
              type="roll"
              value="Entangle: [[d20+@{combat_combined_entangle}]]"
            />
          </label>
          <label
            ><span>Pull Punch</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_pull"
            />
            <button
              type="roll"
              value="Pull Punch: [[d20+@{combat_combined_pull}]]"
            />
          </label>
          <label
            ><span>Roll w/ Impact</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_roll"
            />
            <button
              type="roll"
              value="Roll w/ Impact: [[d20+@{combat_combined_roll}]]"
            />
          </label>
          <label
            ><span>Damage</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_damage"
            />
            <div></div>
          </label>
          <label
            ><span>Dodge: Flight</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_dodge_flight"
            />
            <button
              type="roll"
              value="Dodge in Flight: [[d20+@{combat_combined_dodge_flight}]]"
            />
          </label>
          <label
            ><span>Dodge: Auto</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_dodge_auto"
            />
            <button
              type="roll"
              value="Auto Dodge: [[d20+@{combat_combined_dodge_auto}]]"
            />
          </label>
          <label
            ><span>Dodge: Teleport</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_dodge_teleport"
            />
            <button
              type="roll"
              value="Teleport Dodge: [[d20+@{combat_combined_dodge_teleport}]]"
            />
          </label>
          <label
            ><span>Dodge: Motion</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_dodge_motion"
            />
            <button
              type="roll"
              value="Dodge in Motion: [[d20+@{combat_combined_dodge_motion}]]"
            />
          </label>
          <label
            ><span>Strike: Range</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_strike_range"
            />
            <button
              type="roll"
              value="Range Strike: [[d20+@{combat_combined_strike_range}]]"
            />
          </label>
          <label
            ><span>Range: Single</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_strike_range_single"
            />
            <button
              type="roll"
              value="Range Strike - Single Shot: [[d20+@{combat_combined_strike_range_single}]]"
            />
          </label>
          <label
            ><span>Burst</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_burst"
            />
            <button
              type="roll"
              value="Range Strike - Burst: [[d20+@{combat_combined_burst}]]"
            />
          </label>
          <label
            ><span>Critical</span>
            <input type="number" value="" name="attr_combat_combined_critical"
          /></label>
        </div>
        <hr />
        <h4>Saving Throws</h4>
        <div class="combat-combined-bonuses">
          <label
            ><span>Psionics</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_psionics"
            />
            <button
              type="roll"
              value="Save vs. Psionics: [[d20+@{combat_combined_psionics}]]"
            />
          </label>
          <label
            ><span>Magic</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_magic"
            />
            <button
              type="roll"
              value="Save vs. Magic: [[d20+@{combat_combined_magic}]]"
            />
          </label>
          <label
            ><span>Poison</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_poison"
            />
            <button
              type="roll"
              value="Save vs. Poison: [[d20+@{combat_combined_poison}]]"
            />
          </label>
          <label
            ><span>Horror Factor</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_horrorfactor"
            />
            <button
              type="roll"
              value="Save vs. Horror Factor: [[d20+@{combat_combined_horrorfactor}]]"
            />
          </label>
          <label
            ><span>Mind Control</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_mindcontrol"
            />
            <button
              type="roll"
              value="Save vs. Mind Control: [[d20+@{combat_combined_mindcontrol}]]"
            />
          </label>
          <label
            ><span>Disease</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_disease"
            />
            <button
              type="roll"
              value="Save vs. Disease: [[d20+@{combat_combined_disease}]]"
            />
          </label>
          <label
            ><span>Illusions</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_illusions"
            />
            <button
              type="roll"
              value="Save vs. Illusions: [[d20+@{combat_combined_illusions}]]"
            />
          </label>
          <label
            ><span>Possession</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_possession"
            />
            <button
              type="roll"
              value="Save vs. Possession: [[d20+@{combat_combined_possession}]]"
            />
          </label>
          <label
            ><span>Insanity</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_insanity"
            />
            <button
              type="roll"
              value="Save vs. Insanity: [[d20+@{combat_combined_insanity}]]"
            />
          </label>
          <label
            ><span>Torture</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_torture"
            />
            <button
              type="roll"
              value="Save vs. Torture: [[d20+@{combat_combined_torture}]]"
            />
          </label>
          <label
            ><span>Fatigue</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_fatigue"
            />
            <button
              type="roll"
              value="Save vs. Fatigue: [[d20+@{combat_combined_fatigue}]]"
            />
          </label>
          <label
            ><span>Toxins</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_toxins"
            />
            <button
              type="roll"
              value="Save vs. Toxins: [[d20+@{combat_combined_toxins}]]"
            />
          </label>
          <label
            ><span>Coma/Death</span>
            <input
              readonly
              type="number"
              value=""
              name="attr_combat_combined_comadeath"
            />
            <button
              type="roll"
              value="Save vs. Coma/Death: [[d100+@{combat_combined_comadeath}]]"
            />
          </label>
        </div>
      </div>
      <hr />
      <h3>Combat Skills</h3>
      <fieldset class="repeating_combat">
        <div class="bonus-type-container">
          <input type="hidden" name="attr_combat_selection_id" value="" />
          <label
            ><span>Skill</span>
            <input type="text" list="handToHand" name="attr_skill" />
            <datalist id="handToHand">
              <option value="Custom - Type Your Own"></option>
              <option value="Basic"></option>
              <option value="Expert"></option>
              <option value="Martial Arts"></option>
              <option value="Assassin"></option>
              <option value="Commando"></option>
              <option value="Dragon"></option>
              <option value="RPA Basic"></option>
              <option value="RPA Elite: Flying PA"></option>
              <option value="RPA Elite: Ground PA"></option>
              <option value="RPA Elite: Heavy Vehicle"></option>
              <option value="RPA Elite: Heavy Ground"></option>
              <option value="RPA Elite: Light Ground"></option>
              <option value="RPA Elite: Glitter Boy"></option>
              <option value="Spell: Superhuman Speed"></option>
              <option value="Psionic: Sixth Sense"></option>
              <option value="Magic Amulet: Charm"></option>
            </datalist>
          </label>
          <label
            ><span>Level</span>
            <input type="number" value="" name="attr_skill_level" />
          </label>
          <div></div>
          <div></div>
        </div>
        <details>
          <summary>
            <b>Expand <span name="attr_skill"></span></b>
          </summary>
          <div class="bonus-type-container">
            <label
              ><span>Attacks</span>
              <input type="number" value="" name="attr_attacks" />
            </label>
            <label
              ><span>Initiative</span>
              <input type="number" value="" name="attr_initiative" />
              <button type="roll" value="Initiative: [[d20+@{initiative}]]" />
            </label>
            <label
              ><span>Strike</span>
              <input type="number" value="" name="attr_strike" />
              <button type="roll" value="Strike: [[d20+@{strike}]]" />
            </label>
            <label
              ><span>Parry</span>
              <input type="number" value="" name="attr_parry" />
              <button type="roll" value="Parry: [[d20+@{parry}]]" />
            </label>
            <label
              ><span>Dodge</span>
              <input type="number" value="" name="attr_dodge" />
              <button type="roll" value="Dodge: [[d20+@{dodge}]]" />
            </label>
            <label
              ><span>Throw</span>
              <input type="number" value="" name="attr_throw" />
              <button type="roll" value="Throw: [[d20+@{throw}]]" />
            </label>
            <label
              ><span>Disarm</span>
              <input type="number" value="" name="attr_disarm" />
              <button type="roll" value="Disarm: [[d20+@{disarm}]]" />
            </label>
            <label
              ><span>Entangle</span>
              <input type="number" value="" name="attr_entangle" />
              <button type="roll" value="Entangle: [[d20+@{entangle}]]" />
            </label>
            <label
              ><span>Pull Punch</span>
              <input type="number" value="" name="attr_pull" />
              <button type="roll" value="Pull Punch: [[d20+@{pull}]]" />
            </label>
            <label
              ><span>Roll w/ Impact</span>
              <input type="number" value="" name="attr_roll" />
              <button type="roll" value="Roll w/ Impact: [[d20+@{roll}]]" />
            </label>
            <label
              ><span>Damage</span>
              <input type="number" value="" name="attr_damage" />
              <div></div>
            </label>
            <label
              ><span>Dodge: Flight</span>
              <input type="number" value="" name="attr_dodge_flight" />
              <button
                type="roll"
                value="Dodge in Flight: [[d20+@{dodge_flight}]]"
              />
            </label>
            <label
              >Dodge: Auto
              <input type="number" value="" name="attr_dodge_auto" />
              <button type="roll" value="Auto Dodge: [[d20+@{dodge_auto}]]" />
            </label>
            <label
              ><span>Dodge: Teleport</span>
              <input type="number" value="" name="attr_dodge_teleport" />
              <button
                type="roll"
                value="Teleport Dodge: [[d20+@{dodge_teleport}]]"
              />
            </label>
            <label
              ><span>Dodge: Motion</span>
              <input type="number" value="" name="attr_dodge_motion" />
              <button
                type="roll"
                value="Dodge in Motion: [[d20+@{dodge_motion}]]"
              />
            </label>
            <label
              ><span>Strike: Range</span>
              <input type="number" value="" name="attr_strike_range" />
              <button
                type="roll"
                value="Range Strike: [[d20+@{strike_range}]]"
              />
            </label>
            <label
              ><span>Range: Single</span>
              <input type="number" value="" name="attr_strike_range_single" />
              <button
                type="roll"
                value="Range Strike: [[d20+@{strike_range_single}]]"
              />
            </label>
            <label
              ><span>Range: Burst</span>
              <input type="number" value="" name="attr_burst" />
              <button type="roll" value="Range Strike: [[d20+@{burst}]]" />
            </label>
            <label
              ><span>Critical</span>
              <input type="number" value="" name="attr_critical"
            /></label>
          </div>
          <h4>Saving Throws</h4>
          <div class="bonus-type-container">
            <label
              ><span>Psionics</span>
              <input type="number" value="" name="attr_psionics" />
              <button
                type="roll"
                value="Save vs. Psionics: [[d20+@{psionics}]]"
              />
            </label>
            <label
              ><span>Magic</span>
              <input type="number" value="" name="attr_magic" />
              <button type="roll" value="Save vs. Magic: [[d20+@{magic}]]" />
            </label>
            <label
              ><span>Poison</span>
              <input type="number" value="" name="attr_poison" />
              <button type="roll" value="Save vs. Poison: [[d20+@{poison}]]" />
            </label>
            <label
              ><span>Horror Factor</span>
              <input type="number" value="" name="attr_horrorfactor" />
              <button
                type="roll"
                value="Save vs. Horror Factor: [[d20+@{horrorfactor}]]"
              />
            </label>
            <label
              ><span>Mind Control</span>
              <input type="number" value="" name="attr_mindcontrol" />
              <button
                type="roll"
                value="Save vs. Mind Control: [[d20+@{mindcontrol}]]"
              />
            </label>
            <label
              ><span>Disease</span>
              <input type="number" value="" name="attr_disease" />
              <button
                type="roll"
                value="Save vs. Disease: [[d20+@{disease}]]"
              />
            </label>
            <label
              ><span>Illusions</span>
              <input type="number" value="" name="attr_illusions" />
              <button
                type="roll"
                value="Save vs. Illusions: [[d20+@{illusions}]]"
              />
            </label>
            <label
              ><span>Possession</span>
              <input type="number" value="" name="attr_possession" />
              <button
                type="roll"
                value="Save vs. Possession: [[d20+@{possession}]]"
              />
            </label>
            <label
              ><span>Insanity</span>
              <input type="number" value="" name="attr_insanity" />
              <button
                type="roll"
                value="Save vs. Insanity: [[d20+@{insanity}]]"
              />
            </label>
            <label
              ><span>Torture</span>
              <input type="number" value="" name="attr_torture" />
              <button
                type="roll"
                value="Save vs. Torture: [[d20+@{torture}]]"
              />
            </label>
            <label
              ><span>Fatigue</span>
              <input type="number" value="" name="attr_fatigue" />
              <button
                type="roll"
                value="Save vs. Fatigue: [[d20+@{fatigue}]]"
              />
            </label>
            <label
              ><span>Toxins</span>
              <input type="number" value="" name="attr_toxins" />
              <button type="roll" value="Save vs. Toxins: [[d20+@{toxins}]]" />
            </label>
            <label
              ><span>Coma/Death</span>
              <input type="number" value="" name="attr_comadeath" />
              <button
                type="roll"
                value="Save vs. Coma/Death: [[d100+@{comadeath}]]"
              />
            </label>
          </div>
          <h4>Macro Help</h4>
          <div class="macro-help">
            <label
              ><span><b>Row ID:</b></span>
              <input type="text" readonly name="attr_rowid" value=""
            /></label>
          </div>
        </details>
      </fieldset>
    </div>
  </div>

  <div class="skills">
    <h3>Skills</h3>
    <p>Note that skills include IQ bonus.</p>
    <fieldset class="repeating_skills">
      <div class="values">
        <h5>Skill</h5>
        <h5>Category</h5>
        <h5>Base</h5>
        <h5>Bonus</h5>
        <h5>Per Level</h5>
        <h5>Level</h5>
        <h5>Total</h5>
        <h5></h5>
        <input type="text" value="" name="attr_skill" />
        <select name="attr_category" value="occ">
          <option value="occ">O.C.C.</option>
          <option value="related">O.C.C. Related</option>
          <option value="secondary">Secondary</option>
        </select>
        <input type="number" value="0" name="attr_base" />
        <input type="number" value="0" name="attr_bonus" />
        <input type="number" value="0" name="attr_perlevel" />
        <input type="number" value="0" name="attr_skilllevel" />
        <input type="number" value="0" name="attr_total" />
        <button
          type="roll"
          value="@{character_name} @{skill} check: [[d100<@{total}]]"
        />
      </div>
      <details>
        <summary>
          <b>Describe <span name="attr_skill"></span></b>
        </summary>
        <textarea name="attr_description" value=""></textarea>
      </details>
    </fieldset>
  </div>

  <div class="magic">
    <h3>Magic</h3>
    <details>
      <summary><b>Instructions</b></summary>
      <p>
        Enter a Spell name and its PPE. Optionally set the School and Spell
        Level. Then expand the Details, and fill in the applicable values. They
        will calculate and populate Range, Damage, Duration, and Skill if
        applicable.
      </p>
      <p>
        For Starting Damage and Damage per Level enter values that roll20 would
        use for dice rolls. Ex. "4d6", "1d6", etc.
      </p>
      <p>
        Press the Cast button to remove the PPE from the Current PPE input
        field. Click Reset PPE to set Current PPE back to the value on the Core
        tab. Note the roll button beside Damage and Skill.
      </p>
      <p>
        Don't forget to copy/paste the spell description into the Description
        field to make life easier for your GM. Also use that field for any
        macros you may need like Strike with an arbitrary bonus.
      </p>
    </details>
    <p>Click <b>Instructions</b> for detailed instructions.</p>
    <label
      ><span>Current P.P.E.</span>
      <input type="number" name="attr_currentppe" value="0" />
      <button type="action" name="act_resetppe">Reset P.P.E.</button>
    </label>
    <fieldset class="repeating_magic">
      <div class="spells-list">
        <h5>Spell</h5>
        <h5>School</h5>
        <h5>Spell Level</h5>
        <h5>Range</h5>
        <h5>Damage</h5>
        <h5></h5>
        <h5>Duration</h5>
        <h5>Skill</h5>
        <h5></h5>
        <h5>P.P.E.</h5>
        <h5></h5>
        <input type="text" value="" name="attr_skill" />
        <input type="text" value="" name="attr_school" list="spell-schools" />
        <input type="number" value="0" name="attr_spell_level" />
        <input type="text" value="" name="attr_range" />
        <input type="text" value="" name="attr_damage" />
        <button
          type="roll"
          value="@{character_name} @{skill} [[@{damage}]] @{damage_unit}"
        />
        <input type="text" value="" name="attr_duration" />
        <input type="number" value="" name="attr_percentage" />
        <button
          type="roll"
          value="@{character_name} @{skill} check: [[d100<@{percentage}]]"
        />
        <input type="number" value="0" name="attr_ppe" />
        <button type="action" name="act_usespell">Cast</button>
      </div>
      <details>
        <summary>
          <b>Details for <span name="attr_skill"></span></b>
        </summary>
        <div class="spell-details">
          <label
            ><span>Starting range</span
            ><input type="number" value="0" name="attr_range_starting"
          /></label>
          <label
            ><span>Range per level</span
            ><input type="number" value="0" name="attr_range_per_level"
          /></label>
          <label
            ><span>Range unit</span
            ><input
              type="text"
              value=""
              name="attr_range_unit"
              list="distance-units"
            />
          </label>
          <label
            ><span>Starting damage</span
            ><input type="text" value="" name="attr_damage_starting"
          /></label>
          <label
            ><span>Damage per level</span
            ><input type="text" value="" name="attr_damage_per_level"
          /></label>
          <label
            ><span>Damage unit</span
            ><input
              type="text"
              value=""
              name="attr_damage_unit"
              list="damage-units"
            />
          </label>
          <label
            ><span>Starting duration</span
            ><input type="number" value="0" name="attr_duration_starting"
          /></label>
          <label
            ><span>Duration per level</span
            ><input type="number" value="0" name="attr_duration_per_level"
          /></label>
          <label
            ><span>Duration unit</span
            ><input
              type="text"
              value=""
              name="attr_duration_unit"
              list="time-units"
            />
          </label>
          <label
            ><span>Starting skill %</span
            ><input type="number" value="0" name="attr_percentage_starting"
          /></label>
          <label
            ><span>Skill % per level</span
            ><input type="number" value="0" name="attr_percentage_per_level"
          /></label>
          <label></label>
        </div>
        <label
          ><b>Description</b>
          <textarea class="full" name="attr_description" value=""></textarea>
        </label>
      </details>
    </fieldset>
  </div>

  <div class="equipment">Equipment Coming Soon!</div>
  <div class="psionics">Psionics Coming Soon!</div>
</main>
<script type="text/worker">
  // Change from javascript to worker before upload

  // DEFINITIONS
  const WP = {
  archery: [
    { strike: 1, parry: 1, rof: 2 },
    { strike: 1, disarm: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    { disarm: 1, rof: 1 },
    { strike: 1 },
    {},
    { strike: 1, rof: 1 },
    {},
    { strike: 1, disarm: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    {},
    { strike: 1, rof: 1 },
    { disarm: 1 },
  ],
  axe: [
    {},
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
  ],
  blunt: [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    { throw: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    {},
    { throw: 1 },
  ],
  chain: [
    { strike: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    {},
  ],
  forked: [
    { strike: 1, parry: 1, entangle: 1 },
    {},
    { strike: 1, parry: 1, entangle: 1 },
    { throw: 1 },
    { strike: 1, entangle: 1 },
    { parry: 1 },
    {},
    { strike: 1, entangle: 1 },
    {},
    { parry: 1, throw: 1 },
    { strike: 1, entangle: 1 },
    {},
    { strike: 1, parry: 1, entangle: 1 },
    {},
    { throw: 1 },
  ],
  knife: [
    { parry: 1, throw: 1 },
    { strike: 1 },
    { parry: 1, throw: 1 },
    { strike: 1 },
    {},
    { parry: 1, throw: 1 },
    { strike: 1 },
    { throw: 1 },
    { parry: 1 },
    { strike: 1, throw: 1 },
    {},
    { parry: 1 },
    { strike: 1, throw: 1 },
    {},
    {},
  ],
  "grappling hook": [
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    { strike: 1, entangle: 1 },
    {},
    {},
    {},
  ],
  "pole arm": [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    { strike: 1, parry: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    {},
  ],
  rope: [
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    {},
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    {},
    {},
    { strike: 1 },
  ],
  shield: [
    { parry: 1 },
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    {},
    { parry: 1 },
    { strike: 1 },
    {},
    { parry: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    {},
  ],
  spear: [
    { strike: 1, parry: 1 },
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1, throw: 1 },
    {},
    {},
    { strike: 1, parry: 1 },
    { throw: 1 },
    {},
    { strike: 1, parry: 1 },
    {},
    { throw: 1 },
    {},
  ],
  staff: [
    { strike: 1 },
    { parry: 1 },
    { strike: 1 },
    {},
    { parry: 1, throw: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1, throw: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    { throw: 1 },
  ],
  sword: [
    { strike: 1 },
    { parry: 1 },
    { strike: 1 },
    { parry: 1, throw: 1 },
    {},
    { strike: 1 },
    { parry: 1 },
    { throw: 1 },
    { strike: 1 },
    { parry: 1 },
    {},
    { strike: 1, throw: 1 },
    { parry: 1 },
    {},
    { strike: 1 },
  ],
  targeting: [
    { strike: 1 },
    { damage: 1 },
    { strike: 1 },
    {},
    {},
    {},
    { strike: 1 },
    { damage: 1 },
    {},
    { strike: 1 },
    {},
    {},
    {},
    {},
    {},
  ],
  whip: [
    {},
    { strike: 1, entangle: 1, disarm: 1, damage: 1 },
    {},
    { strike: 1, entangle: 1, disarm: 1, damage: 1 },
    {},
    {},
    { strike: 1, entangle: 1, disarm: 1 },
    { damage: 1 },
    {},
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    { damage: 1 },
    { strike: 1, entangle: 1, disarm: 1 },
    {},
    {},
  ],
  handguns: [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
  ],
  rifles: [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    {},
  ],
  "energy heavy": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
  ],
  "energy pistol": [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
  ],
  "energy rifle": [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    { strike_range_single: 1 },
    {},
  ],
  heavy: [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
  ],
  speargun: [
    {},
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1 },
  ],
  shotgun: [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
  ],
  submachinegun: [
    { strike_range_single: 1 },
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, burst: 1 },
  ],
  flamethrower: [
    {},
    { strike_range_single: 1 },
    {},
    {},
    { strike_range_single: 1, burst: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1 },
    {},
    {},
    {},
    {},
    { strike_range_single: 1, burst: 1 },
  ],
};

const WP_KEYS = {
  wp: [
    "skill",
    "skill_level",
    "strike",
    "parry",
    "disarm",
    "rof",
    "throw",
    "entangle",
  ],
  wpmodern: ["skill", "skill_level", "strike_range_single", "disarm", "burst"],
};

const COMBAT_KEYS = [
  "selection_id",
  "skill",
  "skill_level",
  "attacks",
  "initiative",
  "strike",
  "parry",
  "dodge",
  "throw",
  "disarm",
  "entangle",
  "pull",
  "roll",
  "damage",
  "dodge_flight",
  "dodge_auto",
  "dodge_teleport",
  "dodge_motion",
  "strike_range",
  "strike_range_single",
  "burst",
  "critical",
];
const SAVE_KEYS_ATTRIBUTE_BONUSES = {
  me_bonus: ["psionics", "insanity"],
  pe_bonus: ["magic", "poison", "disease", "torture", "fatigue", "toxins"],
  pe_coma_bonus: ["comadeath"],
  none: ["horrorfactor", "mindcontrol", "illusions", "possession"],
};
const SAVE_KEYS = Object.values(SAVE_KEYS_ATTRIBUTE_BONUSES).reduce(
  (acc, cur) => acc.concat(),
  []
);
const COMBAT_SAVE_KEYS = COMBAT_KEYS.concat(SAVE_KEYS);
const SKILL_KEYS = [
  "skill",
  "base",
  "bonus",
  "perlevel",
  "skilllevel",
  "total",
];

  // END DEFINITIONS

  // UTILS
  function repeatingSum(destinations, section, fields, ...extras) {
  const isNumber = (value) => parseFloat(value).toString() === value.toString();
  const isOption = (value) =>
    [...checks.valid, ...checks.roundtypes].includes(value);
  const isRounding = (value) => checks.roundtypes.includes(value);
  const isFraction = (value) =>
    value.includes("/") && !(value.includes(",") || value.includes("|"));
  const getTrimmed = (value) => value.toLowerCase().replace(/\s/g, "");
  const getRounded = (type, value, pow) =>
    (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(
      Math.max(0, pow)
    );
  const getFraction = (value /*{ console.log(`value: ${value}`); */) =>
    parseInt(value.split("/")[0]) / parseInt(value.split("/")[1]);
  const getMultiplier = (value, rounding = 1) =>
    "undefined" === typeof value
      ? rounding
        ? 0
        : 1
      : isNumber(value)
      ? parseFloat(value)
      : isFraction(value)
      ? getFraction(value)
      : value;
  if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
  if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
  const fields_trimmed = fields.map((field) => getTrimmed(field).split(":")[0]);
  const subfields = fields_trimmed.slice(0, destinations.length);
  const checks = {
    valid: ["multiplier"],
    roundtypes: ["ceil", "round", "floor"],
  };
  let properties = { attributes: {}, options: {} };
  extras.forEach((extra) => {
    const [prop, v] = getTrimmed(extra).split(":");
    const multiplier_maybe = getMultiplier(v, isRounding(prop));
    const obj = isNumber(multiplier_maybe)
      ? subfields.reduce((obj, field) => {
          obj[field] = multiplier_maybe;
          return obj;
        }, {})
      : multiplier_maybe.split(",").reduce((obj, item) => {
          const [stat, value] = item.split("|");
          const multiplier = getMultiplier(value, isRounding(prop));
          obj[stat] = multiplier;
          return obj;
        }, {});
    properties[isOption(prop) ? "options" : "attributes"][prop] = obj;
  });
  getSectionIDs(`repeating_${section}`, (idArray) => {
    const attrArray = idArray.reduce(
      (m, id) => [
        ...m,
        ...fields_trimmed.map((field) => `repeating_${section}_${id}_${field}`),
      ],
      []
    );
    let filteredAttrArray = attrArray;
    if (properties.attributes.filter) {
      filteredAttrArray = attrArray.filter((attr) =>
        Object.keys(properties.attributes.filter).some(
          (sectionId) => sectionId && attr.includes(sectionId)
        )
      );
    }
    getAttrs(
      [...filteredAttrArray, ...Object.keys(properties.attributes)],
      (v) => {
        const getValue = (section, id, field) =>
          v[`repeating_${section}_${id}_${field}`] === "on"
            ? 1
            : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
        const commonMultipliers =
          fields.length <= destinations.length
            ? []
            : fields.splice(
                destinations.length,
                fields.length - destinations.length
              );
        const output = destinations.reduce((obj, destination, index) => {
          let sumTotal = idArray.reduce(
            (total, id) =>
              total +
              getValue(section, id, fields_trimmed[index]) *
                commonMultipliers.reduce(
                  (subtotal, mult) =>
                    subtotal *
                    (!mult.includes(":") ||
                    mult
                      .split(":")[1]
                      .split(",")
                      .includes(fields_trimmed[index])
                      ? getValue(section, id, mult.split(":")[0])
                      : 1),
                  1
                ),
            0
          );
          sumTotal *=
            properties.options.hasOwnProperty("multiplier") &&
            Object.keys(properties.options.multiplier).includes(
              fields_trimmed[index]
            )
              ? parseFloat(
                  properties.options.multiplier[fields_trimmed[index]]
                ) || 0
              : 1;
          sumTotal += Object.entries(properties.attributes).reduce(
            (total, [key, value]) =>
              (total += value.hasOwnProperty(fields_trimmed[index])
                ? parseFloat(v[key] || 0) *
                  (parseFloat(value[fields_trimmed[index]]) || 1)
                : 0),
            0
          );
          checks.roundtypes.forEach((type) => {
            if (properties.options.hasOwnProperty(type)) {
              if (
                Object.keys(properties.options[type]).includes(
                  fields_trimmed[index]
                )
              ) {
                sumTotal = getRounded(
                  type,
                  sumTotal,
                  +properties.options[type][fields_trimmed[index]] || 0
                );
              } else if (
                properties.options[type] == "0" ||
                !isNaN(+properties.options[type] || "x")
              ) {
                sumTotal = getRounded(
                  type,
                  sumTotal,
                  +properties.options[type]
                );
              }
            }
          });
          obj[destination] = sumTotal;
          return obj;
        }, {});
        setAttrs(output);
      }
    );
  });
}

function getBiAttributeBonus(attr) {
  const bonus = attr > 15 ? Math.ceil((Math.min(attr, 30) - 15) / 2) : 0;
  return bonus;
}

function mergeAndAddObjects(data) {
  const result = {};
  data.forEach((obj) => {
    for (let [key, value] of Object.entries(obj)) {
      if (result[key]) {
        result[key] += value;
      } else {
        result[key] = value;
      }
    }
  });
  return result;
}

  // END UTILS

  // COMBAT
  function setWpRow(section, name, keyPrefix, level) {
  console.log("setWpRow", name, keyPrefix, level);
  const attrs = {};
  const levelBonuses = WP[name.toLowerCase()].slice(0, level);
  const totalBonuses = mergeAndAddObjects(levelBonuses);
  WP_KEYS[section].forEach((action) => {
    if (action == "skill") return; // kick out on name
    const key = `${keyPrefix}_${action}`;
    attrs[key] = action in totalBonuses ? totalBonuses[action] : 0;
  });
  attrs[`${keyPrefix}_skill_level`] = level;
  setAttrs(attrs);
}

function setWp({
  section,
  wpName,
  newCharacterLevel,
  oldCharacterLevel,
  newWpLevel,
  rowId,
  callback,
}) {
  console.log("setWp", {
    section,
    wpName,
    newCharacterLevel,
    oldCharacterLevel,
    newWpLevel,
    rowId,
    callback,
  });
  const keyPrefix = rowId
    ? `repeating_${section}_${rowId}`
    : `repeating_${section}`;
  if (newWpLevel) {
    setWpRow(section, wpName, keyPrefix, newWpLevel);
    if (callback) {
      callback(section, rowId, wpName);
    }
  } else if (!rowId) {
    setWpRow(section, wpName, keyPrefix, newCharacterLevel);
    if (callback) {
      callback(section, rowId, wpName);
    }
  } else {
    getAttrs([`${keyPrefix}_skill_level`], (a) => {
      const oldWpLevel = a[`${keyPrefix}_skill_level`];
      if (oldCharacterLevel) {
        const delta = oldCharacterLevel - oldWpLevel;
        if (delta != 0) {
          newWpLevel = newCharacterLevel - delta;
          setWpRow(section, wpName, keyPrefix, newWpLevel);
        } else {
          setWpRow(section, wpName, keyPrefix, newCharacterLevel);
        }
      } else {
        setWpRow(section, wpName, keyPrefix, newCharacterLevel);
      }
      if (callback) {
        callback(section, rowId, wpName);
      }
    });
  }
}

function updateWeaponProficiencies(
  section,
  newCharacterLevel,
  oldCharacterLevel
) {
  getSectionIDs(section, (ids) => {
    const attrNames = ids.map((id) => `repeating_${section}_${id}_skill`);
    getAttrs(attrNames, (a) => {
      ids.forEach((id) => {
        setWp({
          section,
          wpName: a[`repeating_${section}_${id}_skill`].toLowerCase(),
          newCharacterLevel,
          oldCharacterLevel,
          rowId: id,
        });
      });
    });
  });
}

function updateWeaponProficiency(section, source, newWpLevel) {
  getSectionIDs(section, (ids) => {
    const rowId = ids.find(
      (id) => `repeating_${section}_${id}_skill_level`.toLowerCase() == source
    );
    getAttrs([`repeating_${section}_${rowId}_skill`], (a) => {
      setWp({
        section,
        wpName: a[`repeating_${section}_${rowId}_skill`],
        newWpLevel,
        rowId: rowId,
        callback: addWpToCombat,
      });
    });
  });
}

on(
  "change:repeating_wp:skill_level change:repeating_wpmodern:skill_level",
  (e) => {
    const section = e.sourceAttribute.split("_")[1];
    updateWeaponProficiency(section, e.sourceAttribute, e.newValue);
  }
);

on("change:repeating_wp:skill change:repeating_wpmodern:skill", (e) => {
  console.log("change:repeating_wp:skill change:repeating_wpmodern:skill", e);
  const [r, section, rowId, attr] = e.sourceAttribute.split("_");
  const wpName = e.newValue.toLowerCase();
  const wpLevelKey = `repeating_${section}_skill_level`;
  getAttrs(["level", wpLevelKey], (a) => {
    if (Boolean(a[wpLevelKey])) {
      setWp({
        section,
        wpName,
        rowId,
        newWpLevel: a[wpLevelKey],
        callback: addWpToCombat,
      });
    } else {
      const attrs = {};
      attrs[`repeating_${section}_skill_level`] = a.level;
      setAttrs(attrs);
    }
  });
});

on("change:combat_combined_attacks", (e) => {
  getAttrs(["run_ft_melee"], (a) => {
    setAttrs({ run_ft_attack: Math.round(a.run_ft_melee / e.newValue) });
  });
  getSectionIDs("movement", (ids) => {
    const attrNames = ids.map(
      (id) => `repeating_movement_${id}_movement_ft_melee`
    );
    getAttrs(attrNames, (a) => {
      const attrs = {};
      ids.forEach((id) => {
        const row = `repeating_movement_${id}`;
        const feetPerMelee = a[`${row}_movement_ft_melee`] || 0;
        if (feetPerMelee) {
          attrs[`${row}_movement_ft_attack`] = Math.round(
            feetPerMelee / e.newValue
          );
        }
      });
      setAttrs(attrs);
    });
  });
});

function combineCombat(rowIds) {
  // we need to combine the values of each repeated attribute within
  // each of the sectionIds and aggregate them in the combined combat section
  // +PP +PS, and add a saving throws section with +ME +PE

  console.log("combineCombat", rowIds);
  // No attribute bonuses.
  repeatingSum(
    [
      "combat_combined_attacks",
      "combat_combined_initiative",
      "combat_combined_pull",
      "combat_combined_roll",
      "combat_combined_damage",
      "combat_combined_strike_range",
      "combat_combined_strike_range_single",
      "combat_combined_burst",
    ],
    "combat",
    [
      "attacks",
      "initiative",
      "pull",
      "roll",
      "damage",
      "strike_range",
      "strike_range_single",
      "burst",
    ],
    `filter:${rowIds.toString()}`
  );

  // PP Bonus
  repeatingSum(
    [
      "combat_combined_strike",
      "combat_combined_parry",
      "combat_combined_dodge",
      "combat_combined_throw",
      "combat_combined_disarm",
      "combat_combined_entangle",
      "combat_combined_dodge_flight",
      "combat_combined_dodge_auto",
      "combat_combined_dodge_teleport",
      "combat_combined_dodge_motion",
    ],
    "combat",
    [
      "strike",
      "parry",
      "dodge",
      "throw",
      "disarm",
      "entangle",
      "dodge_flight",
      "dodge_auto",
      "dodge_teleport",
      "dodge_motion",
    ],
    `filter:${rowIds.toString()}`,
    "pp_bonus"
  );

  // Saving Throws
  Object.entries(SAVE_KEYS_ATTRIBUTE_BONUSES).forEach(([key, saves]) => {
    repeatingSum(
      saves.map((key) => `combat_combined_${key}`),
      "combat",
      saves,
      `filter:${rowIds.toString()}`,
      key
    );
  });
}

function addWpToCombat(section, rowId, wpName) {
  console.log("addWpToCombat", section, rowId);
  if (!section || !rowId || !wpName) {
    return;
  }
  const wpActions = WP_KEYS[section];
  const wpAttrs = wpActions.map(
    (action) => `repeating_${section}_${rowId}_${action}`
  );
  const wpCombatId = `repeating_${section}_${rowId}_combat_id`;
  wpAttrs.push(wpCombatId);
  getAttrs(wpAttrs, (a) => {
    const attrs = {};
    let combatRowId;
    if (a[wpCombatId]) {
      combatRowId = a[wpCombatId];
    } else {
      combatRowId = generateRowID();
      attrs[wpCombatId] = combatRowId;
    }
    COMBAT_SAVE_KEYS.forEach((key) => {
      attrs[`repeating_combat_${combatRowId}_${key}`] =
        a[`repeating_${section}_${rowId}_${key}`] || 0;
    });
    setAttrs(attrs);
  });
}

/**
 * This function assumes its indices match up with combatselections indices.
 * If that changes, it will need to be modified.
 * */
on("change:repeating_combat:skill", (e) => {
  console.log("change:repeating_combat:skill", e);
  const [r, section, combatRowId] = e.sourceAttribute.split("_");
  getSectionIDs("combat", (skillIds) => {
    getSectionIDs("combatselections", (selectionIds) => {
      const skillIdx = skillIds.findIndex((id) =>
        e.sourceAttribute.includes(id)
      );
      const attrs = {};
      let rowId;
      if (skillIdx >= selectionIds.length) {
        // add new row
        rowId = generateRowID();
      } else {
        // use existing row
        rowId = selectionIds[skillIdx];
      }
      // Store related row ID from repeating_combatselections
      attrs[`repeating_combat_rowid`] = `repeating_combat_${combatRowId}_`;
      attrs[`repeating_combat_combat_selection_id`] = rowId;
      attrs[`repeating_combatselections_${rowId}_combat_id`] =
        skillIds[skillIdx];
      attrs[`repeating_combatselections_${rowId}_skill`] = e.newValue;
      attrs[`repeating_combatselections_${rowId}_bonus_section`] = "combat";
      setAttrs(attrs);
    });
  });
});

on("remove:repeating_wp remove:repeating_wpmodern", (e) => {
  console.log("remove wp", e);
  // const [r, section, rowId] = e.sourceAttribute.split('_');
  const combatRowId = e.removedInfo[`${e.sourceAttribute}_combat_id`];
  const combatSelectionKey = `repeating_combat_${combatRowId}_combat_selection_id`;
  getAttrs([combatSelectionKey], (a) => {
    removeRepeatingRow(`repeating_combatselections_${a[combatSelectionKey]}`);
    removeRepeatingRow(`repeating_combat_${combatRowId}`);
    aggregateBonuses();
  });
});

on("remove:repeating_combat", (e) => {
  // remove repeating_combatselections row with the same index
  const combatselectionsRowIdToRemove =
    e.removedInfo[`${e.sourceAttribute}_combat_selection_id`];
  removeRepeatingRow(
    `repeating_combatselections_${combatselectionsRowIdToRemove}`
  );
  aggregateBonuses();
});

on("change:_reorder:combat", (e) => {
  // reorder repeating_combatselections to match
  console.log("change:_reorder:combat", e);
});

function aggregateBonuses() {
  getSectionIDs("combatselections", (ids) => {
    const checkboxNames = ids.map(
      (id) => `repeating_combatselections_${id}_skill_check`
    );
    const combatIdNames = ids.map(
      (id) => `repeating_combatselections_${id}_combat_id`
    );
    const bonusSectionNames = ids.map(
      (id) => `repeating_combatselections_${id}_bonus_section`
    );
    const attrNames = checkboxNames.concat(combatIdNames, bonusSectionNames);
    getAttrs(attrNames, (a) => {
      const combatRowIds = ids.reduce((acc, id) => {
        const prefix = `repeating_combatselections_${id}`;
        if (Boolean(Number(a[`${prefix}_skill_check`])) == true) {
          acc.push(a[`${prefix}_combat_id`]);
        }
        return acc;
      }, []);
      combineCombat(combatRowIds);
    });
  });
}

on(
  "change:repeating_combatselections:skill_check change:repeating_combat",
  (e) => {
    console.log(
      "change:repeating_combatselections:skill_check change:repeating_combat",
      e
    );
    aggregateBonuses();
  }
);

  // END COMBAT

  // ATTRIBUTES
  on("change:iq", (e) => {
  const iq_bonus = e.newValue > 15 ? e.newValue - 14 : 0;
  const perception_bonus = getBiAttributeBonus(e.newValue);
  setAttrs({ iq_bonus, perception_bonus }, {}, updateSkills);
});

on("change:me change:pp change:pe", (e) => {
  const bonus = getBiAttributeBonus(e.newValue);
  const attrs = {};
  attrs[`${e.sourceAttribute}_bonus`] = bonus;
  if (e.sourceAttribute == "pe") {
    attrs["pe_coma_bonus"] =
      e.newValue >= 16
        ? e.newValue <= 18
          ? 4 + (e.newValue - 16)
          : e.newValue <= 30
          ? 8 + (e.newValue - 19) * 2
          : 30 + (e.newValue - 30)
        : 0;
  }
  setAttrs(attrs, {}, aggregateBonuses);
});

on("change:ma", (e) => {
  const ma_bonus =
    e.newValue >= 16
      ? e.newValue <= 24
        ? 40 + (e.newValue - 16) * 5
        : e.newValue <= 27
        ? 80 + (e.newValue - 24) * 4
        : e.newValue <= 29
        ? 92 + (e.newValue - 27) * 2
        : 97
      : 0;
  setAttrs({ ma_bonus, trust_intimidate: ma_bonus });
});

on("change:ps change:ps_type", (e) => {
  getAttrs(["ps", "ps_type"], (a) => {
    const ps = a.ps;
    const ps_type = a.ps_type;
    const ps_bonus = ps > 15 ? ps - 15 : 0;

    let restrained_punch = (punch = power_punch = kick = leap_kick = "");
    let restrained_punch_unit =
      (punch_unit =
      power_punch_unit =
      kick_unit =
      leap_kick_unit =
        "sdc");

    switch (ps_type) {
      case "normal":
        punch = "1D4";
        kick = "1D4";
        break;
      case "augmented":
        if (ps < 24) {
          // nop
        } else if (ps == 24) {
          power_punch = "1";
          power_punch_unit = "mdc";
        } else if (ps <= 27) {
          power_punch = "1D4";
          power_punch_unit = "mdc";
        } else if (ps <= 30) {
          power_punch = "1D6";
          power_punch_unit = "mdc";
        } else if (ps <= 40) {
          power_punch = "2D4";
          power_punch_unit = "mdc";
        } else if (ps <= 50) {
          restrained_punch = "3D6";
          punch = "1D4";
          punch_unit = "mdc";
          power_punch = "3D4";
          power_punch_unit = "mdc";
        } else {
          restrained_punch = "4D6";
          punch = "1D8";
          punch_unit = "mdc";
          power_punch = "4D4";
          power_punch_unit = "mdc";
        }
        break;
      case "robotic":
        if (ps <= 15) {
          restrained_punch = "1D6";
          punch = "2D6";
          power_punch = "4D6";
          kick = "2D6";
          leap_kick = "3D6";
        } else if (ps <= 20) {
          restrained_punch = "2D6";
          punch = "1";
          power_punch = "1D6";
          kick = "1D4";
          leap_kick = "2D4";
          punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
        } else if (ps <= 25) {
          restrained_punch = "6D6";
          punch = "1D4";
          power_punch = "2D4";
          kick = "1D6";
          leap_kick = "2D6";
          punch_unit = power_punch_unit = kick_unit = leap_kick_unit = "mdc";
        } else if (ps <= 30) {
          restrained_punch = "1D4";
          punch = "1D6";
          power_punch = "2D6";
          kick = "2D4";
          leap_kick = "2D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 35) {
          restrained_punch = "1D4";
          punch = "2D4";
          power_punch = "4D4";
          kick = "2D8";
          leap_kick = "4D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 40) {
          restrained_punch = "1D4";
          punch = "2D6";
          power_punch = "4D6";
          kick = "3D8";
          leap_kick = "5D8";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else if (ps <= 50) {
          restrained_punch = "1D6";
          punch = "3D6";
          power_punch = "1D6*10";
          kick = "5D8";
          leap_kick = "1D8*10";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        } else {
          restrained_punch = "2D6";
          punch = "6D6";
          power_punch = "2D6*10";
          kick = "6D8";
          leap_kick = "2D6*10";
          restrained_punch_unit =
            punch_unit =
            power_punch_unit =
            kick_unit =
            leap_kick_unit =
              "mdc";
        }
        break;
      case "supernatural":
        if (ps <= 15) {
          restrained_punch = "1D6";
          punch = "4D6";
          power_punch = "1D4";
          power_punch_unit = "mdc";
        } else if (ps <= 20) {
          restrained_punch = "3D6";
          punch = "1D6";
          power_punch = "2D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 25) {
          restrained_punch = "4D6";
          punch = "2D6";
          power_punch = "4D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 30) {
          restrained_punch = "5D6";
          punch = "3D6";
          power_punch = "6D6";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 35) {
          restrained_punch = "5D6";
          punch = "4D6";
          power_punch = "1D4*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 40) {
          restrained_punch = "6D6";
          punch = "5D6";
          power_punch = "1D6*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 50) {
          restrained_punch = "1D6*10";
          punch = "6D6";
          power_punch = "2D4*10";
          punch_unit = power_punch_unit = "mdc";
        } else if (ps <= 60) {
          restrained_punch = "1D6";
          punch = "1D6*10";
          power_punch = "2D6*10";
          restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
        } else {
          // > 60
          const extra = Math.ceil((ps - 60) / 10) * 10;
          restrained_punch = "1D6";
          punch = `1D6*10+${extra}`;
          power_punch = `2D6*10+${extra * 2}`;
          restrained_punch_unit = punch_unit = power_punch_unit = "mdc";
        }
        break;
    }
    const attrs = {
      ps_bonus,
      restrained_punch,
      punch,
      power_punch,
      kick,
      leap_kick,
      restrained_punch_unit,
      punch_unit,
      power_punch_unit,
      kick_unit,
      leap_kick_unit,
    };
    setAttrs(attrs);
  });
});

on("change:pb", (e) => {
  const pb_bonus =
    e.newValue >= 16
      ? e.newValue <= 26
        ? 30 + (e.newValue - 16) * 5
        : e.newValue <= 28
        ? 80 + (e.newValue - 26) * 3
        : e.newValue == 29
        ? 90
        : 92
      : 0;
  setAttrs({ pb_bonus, charm_impress: pb_bonus });
});

on("change:spd", (e) => {
  getAttrs(["combat_combined_attacks"], (a) => {
    const feetPerMelee = e.newValue * 15;
    const attrs = {
      run_mph: ((feetPerMelee * 4 * 60) / 5280).toFixed(1),
      run_ft_melee: feetPerMelee,
      run_ft_attack: Math.round(feetPerMelee / a.combat_combined_attacks),
    };
    setAttrs(attrs);
  });
});

  // END ATTRIBUTES

  // SKILLS
  function updateSkill(rowId) {
  const row = `repeating_skills_${rowId}`;
  const skillAttrs = SKILL_KEYS.map((key) => `${row}_${key}`);
  console.log(skillAttrs);
  getAttrs(skillAttrs.concat(["iq_bonus"]), (a) => {
    console.log(a);
    const attrs = {};
    const total =
      +a[`${row}_base`] +
      +a["iq_bonus"] +
      +a[`${row}_bonus`] +
      (+a[`${row}_skilllevel`] - 1) * +a[`${row}_perlevel`];
    console.log(total);
    attrs[`${row}_total`] = total;
    setAttrs(attrs);
  });
}

function updateSkills() {
  getSectionIDs("skills", (ids) => {
    ids.forEach((id) => {
      updateSkill(id);
    });
  });
}

function updateSkillLevels(newCharacterLevel, oldCharacterLevel) {
  const delta = newCharacterLevel - oldCharacterLevel;
  getSectionIDs("skills", (ids) => {
    const attrNames = ids.map((id) => `repeating_skills_${id}_skilllevel`);
    getAttrs(attrNames, (a) => {
      const attrs = {};
      ids.forEach((id) => {
        attrs[`repeating_skills_${id}_skilllevel`] =
          +a[`repeating_skills_${id}_skilllevel`] + delta;
      });
      setAttrs(attrs);
    });
  });
}

on("change:repeating_skills", (e) => {
  if (e.sourceAttribute.endsWith("_skilllevel")) return;
  const [r, section, rowId] = e.triggerName.split("_");
  getAttrs(["level"], (a) => {
    console.log(a);
    const attrs = { repeating_skills_skilllevel: a.level };
    console.log(attrs);
    setAttrs(attrs, {}, () => updateSkill(rowId));
  });
});

  // END SKILLS

  // MAGIC_PSIONICS
  on("clicked:repeating_magic:usespell", (e) => {
  console.log(e);
  getAttrs(["repeating_magic_ppe", "currentppe"], (a) => {
    console.log(a);
    setAttrs({ currentppe: a.currentppe - a.repeating_magic_ppe });
  });
});

on("clicked:resetppe", (e) => {
  console.log(e);
  getAttrs(["character_ppe"], (a) => {
    setAttrs({ currentppe: a.character_ppe });
  });
});

function calculateMagicRangeDuration(prop) {
  const row = `repeating_magic_${prop}`;
  const attrNames = ["starting", "per_level", "unit"].map(
    (subProp) => `${row}_${subProp}`
  );
  getAttrs(attrNames.concat(["level"]), (a) => {
    console.log(a);
    const value =
      +a[`${row}_starting`] + (+a.level - 1) * +a[`${row}_per_level`];
    const unit = a[`${row}_unit`];
    const valueWithUnits = `${value} ${unit}`;
    setAttrs({ [row]: valueWithUnits });
  });
}

function calculateMagicPercentage() {
  const row = "repeating_magic_percentage";
  const attrNames = ["starting", "per_level"].map(
    (subProp) => `${row}_${subProp}`
  );
  getAttrs(attrNames.concat(["level"]), (a) => {
    console.log(a);
    const value =
      +a[`${row}_starting`] + (+a.level - 1) * +a[`${row}_per_level`];
    setAttrs({ [row]: value });
  });
}

function calculateMagicDamage() {
  const row = "repeating_magic_damage";
  const attrNames = ["starting", "per_level", "unit"].map(
    (subProp) => `${row}_${subProp}`
  );
  getAttrs(attrNames.concat(["level"]), (a) => {
    console.log(a);
    const perLevel = a[`${row}_per_level`];
    const repeats = perLevel ? `+${perLevel}`.repeat(a.level - 1) : "";
    const value = `${a[`${row}_starting`]}${repeats}`;
    setAttrs({ [row]: value });
  });
}

on(
  "change:repeating_magic:damage_starting \
  change:repeating_magic:damage_per_level \
  change:repeating_magic:damage_unit",
  (e) => {
    console.log(e);
    calculateMagicDamage();
  }
);

on(
  "change:repeating_magic:percentage_starting \
  change:repeating_magic:percentage_per_level",
  (e) => {
    console.log(e);
    calculateMagicPercentage();
  }
);
on(
  "change:repeating_magic:duration_starting \
  change:repeating_magic:duration_per_level \
  change:repeating_magic:duration_unit",
  (e) => {
    console.log(e);
    const prop = "duration";
    calculateMagicRangeDuration(prop);
  }
);

on(
  "change:repeating_magic:range_starting \
  change:repeating_magic:range_per_level \
  change:repeating_magic:range_unit",
  (e) => {
    console.log(e);
    const prop = "range";
    calculateMagicRangeDuration(prop);
  }
);

  // END MAGIC_PSIONICS

  /**
   * @todo combat row `level` needs to populate when `skill` does
   * @todo combat row `level` needs to adjust with Character level like WPs do
   * @todo Skills
   * @todo Magic - include checkbox beside each spell to add it as a row on the Combat tab
   * @todo Psionics - include checkbox beside each spell to add it as a row on the Combat tab
   * @todo consider spells/gear that modifies attributes (either as a modifier or an absolute value),
   *    modifies PS type,
   *
   * @todo better better build process with imports/file modules
   * */

  /**
   * This one could be a doozy
   * */
  on("change:level", (e) => {
    console.log("change:level", e.newValue, e.previousValue);
    // Update WPs
    updateWeaponProficiencies("wp", e.newValue, e.previousValue);
    updateWeaponProficiencies("wpmodern", e.newValue, e.previousValue);
    updateSkillLevels(+e.newValue, +e.previousValue);
  });

  on("change:repeating_movement:movement_mph", (e) => {
    getAttrs(["combat_combined_attacks"], (a) => {
      const feetPerMelee = Math.round((e.newValue * 5280) / 60 / 4);
      const attrs = {
        repeating_movement_movement_ft_melee: feetPerMelee,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combat_combined_attacks
        ),
      };
      setAttrs(attrs);
    });
  });

  on("change:repeating_movement:movement_ft_melee", (e) => {
    getAttrs(["combat_combined_attacks"], (a) => {
      const feetPerMelee = e.newValue;
      //const mph = Math.round((feetPerMelee * 4 * 60) / 5280);
      const mph = ((feetPerMelee * 4 * 60) / 5280).toFixed(1);
      const attrs = {
        repeating_movement_movement_mph: mph,
        repeating_movement_movement_ft_attack: Math.round(
          feetPerMelee / a.combat_combined_attacks
        ),
      };
      setAttrs(attrs);
    });
  });

  const buttonlist = [
    "core",
    "wp",
    "combat",
    "equipment",
    "skills",
    "magic",
    "psionics",
  ];
  buttonlist.forEach((button) => {
    on(`clicked:${button}`, function () {
      setAttrs({ sheetTab: button });
    });
  });
</script>
